# OCW + TEE é€šç”¨æ¶æ„æ¨¡å—

`pallet-divination-ocw-tee` ä¸ºæ‰€æœ‰å åœæ¨¡å—æä¾›ç»Ÿä¸€çš„ Off-Chain Worker (OCW) + Trusted Execution Environment (TEE) éšç§è®¡ç®—åŸºç¡€è®¾æ–½ã€‚

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¨¡å—æ˜¯å åœç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½å±‚ï¼Œè´Ÿè´£ï¼š
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å åœè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ
- æä¾›å¤šç§éšç§æ¨¡å¼æ”¯æŒ
- ä¸ TEE èŠ‚ç‚¹å®‰å…¨é€šä¿¡
- è‡ªåŠ¨ä¸Šä¼ ç»“æœåˆ° IPFS
- æ”¯æŒç‰ˆæœ¬æ§åˆ¶å’Œæ›´æ–°

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åº”ç”¨å±‚ï¼ˆå„å åœæ¨¡å—ï¼‰                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  BaZi   â”‚ â”‚  Qimen  â”‚ â”‚ MeiHua  â”‚ â”‚ LiuYao  â”‚ â”‚  ZiWei  â”‚  ...      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚           â”‚           â”‚           â”‚           â”‚                 â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                               â”‚                                          â”‚
â”‚                               â–¼                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      é€šç”¨å±‚ï¼ˆpallet-divination-ocw-teeï¼‰                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è¯·æ±‚ç®¡ç†    â”‚  â”‚ OCW è°ƒåº¦    â”‚  â”‚ TEE é€šä¿¡    â”‚  â”‚ IPFS å­˜å‚¨   â”‚    â”‚
â”‚  â”‚ (Pending)   â”‚  â”‚ (Scheduler) â”‚  â”‚ (Client)    â”‚  â”‚ (Uploader)  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ éšç§æ¨¡å¼    â”‚  â”‚ æ¨¡å—æ³¨å†Œ    â”‚  â”‚ é‡è¯•æœºåˆ¶    â”‚  â”‚ äº‹ä»¶é€šçŸ¥    â”‚    â”‚
â”‚  â”‚ (Privacy)   â”‚  â”‚ (Registry)  â”‚  â”‚ (Retry)     â”‚  â”‚ (Events)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” éšç§æ¨¡å¼

| æ¨¡å¼ | è¾“å…¥ | è®¡ç®— | å­˜å‚¨ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| **Public** | æ˜æ–‡ | OCW | æ˜æ–‡ | å…¬å¼€å åœã€æ¼”ç¤º |
| **PublicEncrypted** | æ˜æ–‡ | OCW | åŠ å¯† | éæ•æ„Ÿè¾“å…¥ã€ç»“æœä¿å¯† |
| **Encrypted** | åŠ å¯† | TEE | åŠ å¯† | æ•æ„Ÿè¾“å…¥ã€ç»“æœä¿å¯† |
| **Private** | åŠ å¯† | TEE | åŠ å¯† | æœ€é«˜éšç§çº§åˆ« |

### éšç§æ¨¡å¼è¯¦è§£

#### Public æ¨¡å¼
- è¾“å…¥æ•°æ®æ˜æ–‡æäº¤åˆ°é“¾ä¸Š
- OCW ç›´æ¥è®¡ç®—ï¼Œæ— éœ€ TEE
- ç»“æœæ˜æ–‡å­˜å‚¨åˆ° IPFS
- é€‚ç”¨äºå…¬å¼€æ¼”ç¤ºæˆ–éæ•æ„Ÿæ•°æ®

#### PublicEncrypted æ¨¡å¼
- è¾“å…¥æ•°æ®æ˜æ–‡æäº¤ï¼ˆå¦‚å‡ºç”Ÿæ—¶é—´ï¼‰
- OCW æ˜æ–‡è®¡ç®—ï¼Œæ— éœ€ TEE
- ç»“æœä½¿ç”¨ç”¨æˆ·å…¬é’¥åŠ å¯†åå­˜å‚¨
- é€‚ç”¨äºè¾“å…¥éæ•æ„Ÿä½†ç»“æœéœ€ä¿å¯†çš„åœºæ™¯

#### Encrypted æ¨¡å¼
- è¾“å…¥æ•°æ®ä½¿ç”¨ TEE å…¬é’¥åŠ å¯†
- TEE èŠ‚ç‚¹è§£å¯†å¹¶è®¡ç®—
- ç»“æœä½¿ç”¨ç”¨æˆ·å…¬é’¥åŠ å¯†
- é€‚ç”¨äºè¾“å…¥å’Œç»“æœéƒ½éœ€ä¿å¯†çš„åœºæ™¯

#### Private æ¨¡å¼
- æœ€é«˜éšç§çº§åˆ«
- å…¨ç¨‹åŠ å¯†å¤„ç†
- æ”¯æŒé›¶çŸ¥è¯†è¯æ˜éªŒè¯

## ğŸ“¦ æ¨¡å—ç»“æ„

```
ocw-tee/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs          # ä¸»æ¨¡å—ï¼ŒPallet å®šä¹‰
â”‚   â”œâ”€â”€ types.rs        # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ traits.rs       # Trait å®šä¹‰
â”‚   â”œâ”€â”€ crypto.rs       # åŠ å¯†å·¥å…·
â”‚   â”œâ”€â”€ registry.rs     # æ¨¡å—æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ weights.rs      # æƒé‡å®šä¹‰
â”‚   â”œâ”€â”€ tests.rs        # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ benchmarking.rs # åŸºå‡†æµ‹è¯•
â””â”€â”€ Cargo.toml
```

## ğŸ”§ é…ç½®

### Pallet Config

```rust
#[pallet::config]
pub trait Config: frame_system::Config {
    /// è¿è¡Œæ—¶äº‹ä»¶ç±»å‹
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;

    /// OCW å¤„ç†é—´éš”ï¼ˆåŒºå—æ•°ï¼‰
    #[pallet::constant]
    type OcwInterval: Get<u32>;

    /// æœ€å¤§é‡è¯•æ¬¡æ•°
    #[pallet::constant]
    type MaxRetryCount: Get<u8>;

    /// æ¯åŒºå—æœ€å¤§å¤„ç†è¯·æ±‚æ•°
    #[pallet::constant]
    type MaxRequestsPerBlock: Get<u32>;

    /// æœ€å¤§è¾“å…¥æ•°æ®é•¿åº¦
    #[pallet::constant]
    type MaxInputDataLen: Get<u32>;

    /// TEE å®¢æˆ·ç«¯
    type TeeClient: TeeClient;

    /// IPFS å®¢æˆ·ç«¯
    type IpfsClient: IpfsClient;

    /// TEE Privacy é›†æˆ
    type TeePrivacy: TeePrivacyIntegration<Self::AccountId, BlockNumberFor<Self>>;

    /// IPFS Pin æœåŠ¡
    type IpfsPinner: IpfsPinner<Self::AccountId, u128>;

    /// æ¨¡å—æ³¨å†Œè¡¨
    type ModuleRegistry: ModuleRegistry;
}
```

### å¸¸é‡é…ç½®

| å¸¸é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `MAX_RETRY_COUNT` | 3 | æœ€å¤§é‡è¯•æ¬¡æ•° |
| `DEFAULT_OCW_INTERVAL` | 5 | OCW å¤„ç†é—´éš”ï¼ˆåŒºå—ï¼‰ |
| `MAX_REQUESTS_PER_BLOCK` | 10 | æ¯åŒºå—æœ€å¤§å¤„ç†æ•° |

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºå…¬å¼€æ¨¡å¼è¯·æ±‚

```rust
// æ˜æ–‡è¾“å…¥ï¼Œæ˜æ–‡å­˜å‚¨
OcwTee::create_public_request(
    origin,
    DivinationType::BaZi,
    input_data.encode(),
)?;
```

### åˆ›å»ºå…¬å¼€è®¡ç®—åŠ å¯†å­˜å‚¨è¯·æ±‚

```rust
// æ˜æ–‡è¾“å…¥ï¼ŒåŠ å¯†å­˜å‚¨
OcwTee::create_public_encrypted_request(
    origin,
    DivinationType::BaZi,
    input_data.encode(),
    user_pubkey,  // X25519 å…¬é’¥
)?;
```

### åˆ›å»ºåŠ å¯†æ¨¡å¼è¯·æ±‚

```rust
// åŠ å¯†è¾“å…¥ï¼ŒTEE è®¡ç®—ï¼ŒåŠ å¯†å­˜å‚¨
OcwTee::create_encrypted_request(
    origin,
    DivinationType::BaZi,
    ciphertext,
    nonce,
    sender_pubkey,
    user_pubkey,
    PrivacyMode::Encrypted,
)?;
```

### æ›´æ–°å åœç»“æœï¼ˆåˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰

```rust
// ä¿®æ­£é”™è¯¯è¾“å…¥ï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬
OcwTee::update_divination(
    origin,
    original_request_id,
    DivinationType::BaZi,
    new_input_data,
    user_pubkey,
    PrivacyMode::Public,
)?;
```

### å–æ¶ˆå¾…å¤„ç†è¯·æ±‚

```rust
OcwTee::cancel_request(origin, request_id)?;
```

## ğŸ“Š å­˜å‚¨ç»“æ„

### UserRequests
ç”¨æˆ·çš„è¯·æ±‚ ID åˆ—è¡¨ï¼ˆæœ€å¤š 100 ä¸ªï¼‰

### CompletedResults
å·²å®Œæˆçš„å åœç»“æœï¼ŒåŒ…å«ï¼š
- `owner`: æ‰€æœ‰è€…è´¦æˆ·
- `divination_type`: å åœç±»å‹
- `privacy_mode`: éšç§æ¨¡å¼
- `manifest_cid`: IPFS CID
- `manifest_hash`: æ¸…å•å“ˆå¸Œ
- `generation`: ç”Ÿæˆä¿¡æ¯ï¼ˆOCW/TEEï¼‰
- `version`: ç‰ˆæœ¬å·
- `is_latest`: æ˜¯å¦æœ€æ–°ç‰ˆæœ¬

### VersionChain
ç‰ˆæœ¬é“¾ç´¢å¼•ï¼Œè®°å½•æ‰€æœ‰ç‰ˆæœ¬çš„è¯·æ±‚ ID

### LatestVersion
æœ€æ–°ç‰ˆæœ¬ç´¢å¼•

## ğŸ“¡ äº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `RequestCreated` | è¯·æ±‚å·²åˆ›å»º |
| `RequestProcessing` | è¯·æ±‚å¤„ç†ä¸­ |
| `RequestCompleted` | è¯·æ±‚å·²å®Œæˆ |
| `RequestFailed` | è¯·æ±‚å¤±è´¥ |
| `RequestTimeout` | è¯·æ±‚è¶…æ—¶ |
| `RequestRetry` | è¯·æ±‚é‡è¯• |
| `ResultStored` | ç»“æœå·²å­˜å‚¨ |
| `RequestCancelled` | è¯·æ±‚å·²å–æ¶ˆ |
| `DivinationUpdated` | å åœå·²æ›´æ–°ï¼ˆæ–°ç‰ˆæœ¬ï¼‰ |

## âŒ é”™è¯¯ç±»å‹

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `RequestNotFound` | è¯·æ±‚ä¸å­˜åœ¨ |
| `RequestAlreadyProcessed` | è¯·æ±‚å·²å¤„ç† |
| `PendingQueueFull` | å¾…å¤„ç†é˜Ÿåˆ—å·²æ»¡ |
| `InputDataTooLong` | è¾“å…¥æ•°æ®è¿‡é•¿ |
| `InvalidPrivacyMode` | æ— æ•ˆçš„éšç§æ¨¡å¼ |
| `TeeNodeUnavailable` | TEE èŠ‚ç‚¹ä¸å¯ç”¨ |
| `Unauthorized` | æ— æƒé™ |
| `NotOwner` | ä¸æ˜¯æ‰€æœ‰è€… |
| `CannotCancel` | æ— æ³•å–æ¶ˆ |
| `TooManyVersions` | ç‰ˆæœ¬è¿‡å¤š |

## ğŸ”— ä¾èµ–æ¨¡å—

| æ¨¡å— | ç”¨é€” |
|------|------|
| `pallet-divination-common` | é€šç”¨ç±»å‹å®šä¹‰ |
| `pallet-tee-privacy` | TEE éšç§è®¡ç®—é›†æˆ |
| `pallet-storage-service` | IPFS å­˜å‚¨æœåŠ¡ |

## ğŸ”’ åŠ å¯†ç®—æ³•

- **å¯†é’¥äº¤æ¢**: X25519 (Curve25519)
- **å¯¹ç§°åŠ å¯†**: ChaCha20-Poly1305 (AEAD)
- **å“ˆå¸Œ**: Blake2b-256

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
cargo test -p pallet-divination-ocw-tee

# è¿è¡ŒåŸºå‡†æµ‹è¯•
cargo test -p pallet-divination-ocw-tee --features runtime-benchmarks
```

## ğŸ“ˆ åŸºå‡†æµ‹è¯•

```bash
# ç”Ÿæˆæƒé‡
./target/release/cosmos-node benchmark pallet \
    --chain dev \
    --pallet pallet_divination_ocw_tee \
    --extrinsic '*' \
    --steps 50 \
    --repeat 20 \
    --output pallets/divination/ocw-tee/src/weights.rs
```

## ğŸ“„ è®¸å¯è¯

MIT
