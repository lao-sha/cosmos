# åº—é“ºä»£å¸äº¤æ˜“å¸‚åœºæ¨¡å— (pallet-entity-market)

## æ¦‚è¿°

æœ¬æ¨¡å—å®ç°åº—é“ºä»£å¸çš„ P2P äº¤æ˜“å¸‚åœºï¼Œæ”¯æŒä»»æ„ä¸»ç½‘åœ°å€ä¹‹é—´çš„åº—é“ºä»£å¸ä¹°å–äº¤æ˜“ã€‚

## æ ¸å¿ƒåŠŸèƒ½

### 1. NXS é€šé“ âœ…

ä½¿ç”¨åŸç”Ÿ NXS ä»£å¸è¿›è¡Œåº—é“ºä»£å¸ä¹°å–ï¼Œé“¾ä¸Šå³æ—¶ç»“ç®—ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NXS é€šé“äº¤æ˜“æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   å–å®¶ (Alice)                          ä¹°å®¶ (Bob)              â”‚
â”‚       â”‚                                     â”‚                   â”‚
â”‚       â”‚ place_sell_order()                  â”‚                   â”‚
â”‚       â”‚ (é”å®š Token)                        â”‚                   â”‚
â”‚       â–¼                                     â”‚                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚                   â”‚
â”‚   â”‚ å–å•    â”‚                               â”‚                   â”‚
â”‚   â”‚ æŒ‚å•ä¸­  â”‚                               â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                   â”‚
â”‚       â”‚                                     â”‚                   â”‚
â”‚       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ take_order()                  â”‚
â”‚       â”‚                          (æ”¯ä»˜ NXS)                     â”‚
â”‚       â–¼                                     â”‚                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚   â”‚           åŸå­äº¤æ¢                       â”‚                  â”‚
â”‚   â”‚  Token: Alice â†’ Bob                     â”‚                  â”‚
â”‚   â”‚  NXS: Bob â†’ Alice                       â”‚                  â”‚
â”‚   â”‚  Fee: â†’ åº—é“ºé‡‘åº“                         â”‚                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. USDT é€šé“ âœ…

ä½¿ç”¨ TRC20 USDT è¿›è¡Œåº—é“ºä»£å¸ä¹°å–ï¼Œéœ€è¦ OCW éªŒè¯é“¾ä¸‹æ”¯ä»˜ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USDT é€šé“äº¤æ˜“æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   æµç¨‹ A: åƒ USDT å–å•ï¼ˆä¸¤é˜¶æ®µå®‰å…¨æ¨¡å¼ï¼‰ğŸ†•                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  1. Alice æŒ‚ USDT å–å• (é”å®š Token, æä¾› TRON åœ°å€)      â”‚  â”‚
â”‚   â”‚  2. Bob è°ƒç”¨ reserve_usdt_sell_order (é¢„é”å®š)           â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ é”å®š Bob çš„ NXS ä¿è¯é‡‘                           â”‚  â”‚
â”‚   â”‚     â””â”€â”€ é”å®šè®¢å•ä»½é¢ (é˜²æ­¢ä»–äººæŠ¢å )                      â”‚  â”‚
â”‚   â”‚  3. Bob é“¾ä¸‹è½¬ USDT â†’ Alice çš„ TRON åœ°å€                 â”‚  â”‚
â”‚   â”‚  4. Bob è°ƒç”¨ confirm_usdt_payment (æäº¤ tx_hash)        â”‚  â”‚
â”‚   â”‚  5. OCW éªŒè¯ TRON äº¤æ˜“ + é‡‘é¢å¤šæ¡£åˆ¤å®š                    â”‚  â”‚
â”‚   â”‚  6. ç»“æœå¤„ç†:                                            â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ å…¨é¢ä»˜æ¬¾ â†’ Token å…¨éƒ¨è½¬ Bob, é€€è¿˜ä¿è¯é‡‘          â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ å°‘ä»˜ â†’ æŒ‰æ¯”ä¾‹åˆ†é… Token, ä¿è¯é‡‘å…¨å½’å›½åº“          â”‚  â”‚
â”‚   â”‚     â””â”€â”€ è¶…æ—¶ â†’ Token é€€ Alice, ä¿è¯é‡‘å½’å›½åº“              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚   æµç¨‹ B: æ¥å— USDT ä¹°å•ï¼ˆå«ä¹°å®¶ä¿è¯é‡‘ + å¤šæ¡£åˆ¤å®šï¼‰ğŸ†•            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  1. Bob æŒ‚ USDT ä¹°å•                                     â”‚  â”‚
â”‚   â”‚  2. Alice è°ƒç”¨ accept_usdt_buy_order                    â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ é”å®š Bob çš„ NXS ä¿è¯é‡‘                           â”‚  â”‚
â”‚   â”‚     â””â”€â”€ é”å®š Alice çš„ Token                              â”‚  â”‚
â”‚   â”‚  3. Bob é“¾ä¸‹è½¬ USDT â†’ Alice çš„ TRON åœ°å€                 â”‚  â”‚
â”‚   â”‚  4. Bob è°ƒç”¨ confirm_usdt_payment (æäº¤ tx_hash)        â”‚  â”‚
â”‚   â”‚  5. OCW éªŒè¯ TRON äº¤æ˜“ + é‡‘é¢å¤šæ¡£åˆ¤å®š                    â”‚  â”‚
â”‚   â”‚  6. ç»“æœå¤„ç†:                                            â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ å…¨é¢ä»˜æ¬¾ â†’ Token å…¨éƒ¨è½¬ Bob, é€€è¿˜ä¿è¯é‡‘          â”‚  â”‚
â”‚   â”‚     â”œâ”€â”€ å°‘ä»˜ â†’ æŒ‰æ¯”ä¾‹åˆ†é… Token, ä¿è¯é‡‘å…¨å½’å›½åº“          â”‚  â”‚
â”‚   â”‚     â””â”€â”€ è¶…æ—¶ â†’ Token é€€ Alice, ä¿è¯é‡‘å½’å›½åº“              â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. OCW éªŒè¯æ¿€åŠ±æœºåˆ¶ ğŸ†•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OCW éªŒè¯æ¿€åŠ±æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   1. offchain_worker æ¯åŒºå—æ‰§è¡Œ                                 â”‚
â”‚      â””â”€â”€ æ£€æŸ¥ PendingUsdtTrades é˜Ÿåˆ—                           â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚   2. è°ƒç”¨ TronGrid API éªŒè¯ TRC20 äº¤æ˜“                          â”‚
â”‚      â”œâ”€â”€ å¤šç«¯ç‚¹æ•…éšœè½¬ç§» + å¥åº·è¯„åˆ†                              â”‚
â”‚      â””â”€â”€ ğŸ†• è·å–å®é™…ä»˜æ¬¾é‡‘é¢ (actual_amount)                    â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚   3. submit_ocw_result (æ— ç­¾åäº¤æ˜“)                             â”‚
â”‚      â”œâ”€â”€ ValidateUnsigned éªŒè¯                                  â”‚
â”‚      â”œâ”€â”€ ğŸ†• è®¡ç®—å¤šæ¡£åˆ¤å®šç»“æœ (PaymentVerificationResult)        â”‚
â”‚      â””â”€â”€ å­˜å‚¨ (åˆ¤å®šç»“æœ, å®é™…é‡‘é¢) åˆ° OcwVerificationResults    â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚   4. ä»»ä½•äººè°ƒç”¨ claim_verification_reward                       â”‚
â”‚      â”œâ”€â”€ è¯»å– OcwVerificationResults                            â”‚
â”‚      â”œâ”€â”€ ğŸ†• æ ¹æ®åˆ¤å®šç»“æœæ‰§è¡Œä¸åŒå¤„ç†é€»è¾‘                        â”‚
â”‚      â”‚     â”œâ”€â”€ Exact/Overpaid â†’ å…¨é¢é‡Šæ”¾                        â”‚
â”‚      â”‚     â””â”€â”€ Underpaid/SeverelyUnderpaid/Invalid â†’ æŒ‰æ¯”ä¾‹å¤„ç† â”‚
â”‚      â”œâ”€â”€ æ”¯ä»˜ VerificationReward ç»™è°ƒç”¨è€…                       â”‚
â”‚      â””â”€â”€ æ¸…ç†å­˜å‚¨                                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®‰å…¨æœºåˆ¶**ï¼š
- `submit_ocw_result` é€šè¿‡ `ValidateUnsigned` éªŒè¯
- åªæœ‰ `AwaitingVerification` çŠ¶æ€çš„äº¤æ˜“å¯æäº¤
- é˜²æ­¢é‡å¤æäº¤ï¼ˆå·²æœ‰ç»“æœåˆ™æ‹’ç»ï¼‰
- `claim_verification_reward` æ ¹æ®é“¾ä¸Š OCW ç»“æœè‡ªåŠ¨å¤„ç†

### 4. ä¹°å®¶ä¿è¯é‡‘æœºåˆ¶ ğŸ†•

é˜²æ­¢ USDT ä¹°å•åœºæ™¯ä¸‹ä¹°å®¶ä¸ä»˜æ¬¾çš„é£é™©ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¹°å®¶ä¿è¯é‡‘æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ä¿è¯é‡‘è®¡ç®—å…¬å¼:                                               â”‚
â”‚   deposit = max(MinBuyerDeposit, USDTé‡‘é¢ Ã— DepositRate Ã— Rate) â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  å–å®¶æ¥å—ä¹°å• (accept_usdt_buy_order)                     â”‚ â”‚
â”‚   â”‚       â”‚                                                   â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ è®¡ç®—ä¿è¯é‡‘é‡‘é¢                                  â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ é”å®šä¹°å®¶ NXS (T::Currency::reserve)            â”‚ â”‚
â”‚   â”‚       â””â”€â”€ é”å®šå–å®¶ Token                                  â”‚ â”‚
â”‚   â”‚       â”‚                                                   â”‚ â”‚
â”‚   â”‚       â–¼                                                   â”‚ â”‚
â”‚   â”‚  ç­‰å¾…ä¹°å®¶é“¾ä¸‹æ‰“æ¬¾...                                      â”‚ â”‚
â”‚   â”‚       â”‚                                                   â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚   â”‚       â”‚              â”‚                 â”‚                 â”‚ â”‚
â”‚   â”‚       â–¼              â–¼                 â–¼                 â”‚ â”‚
â”‚   â”‚   éªŒè¯é€šè¿‡        éªŒè¯å¤±è´¥          è¶…æ—¶æœªä»˜æ¬¾           â”‚ â”‚
â”‚   â”‚       â”‚              â”‚                 â”‚                 â”‚ â”‚
â”‚   â”‚       â–¼              â–¼                 â–¼                 â”‚ â”‚
â”‚   â”‚   é€€è¿˜ä¿è¯é‡‘      é€€è¿˜ä¿è¯é‡‘      æ²¡æ”¶ä¿è¯é‡‘â†’å–å®¶        â”‚ â”‚
â”‚   â”‚   Tokenâ†’ä¹°å®¶      Tokenâ†’å–å®¶      Tokenâ†’å–å®¶             â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚   ä¿è¯é‡‘çŠ¶æ€: None â†’ Locked â†’ Released / PartiallyForfeited / Forfeited â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡è¦ç‚¹**ï¼š
- é€‚ç”¨äº **æµç¨‹ Aï¼ˆåƒ USDT å–å•ï¼‰** å’Œ **æµç¨‹ Bï¼ˆæ¥å— USDT ä¹°å•ï¼‰**
- ä¿è¯é‡‘ä¸º NXSï¼Œéåº—é“ºä»£å¸ï¼Œä»·å€¼ç¨³å®š
- æ²¡æ”¶æ¯”ä¾‹å¯é…ç½®ï¼ˆ`DepositForfeitRate`ï¼‰ï¼Œæ”¯æŒéƒ¨åˆ†æ²¡æ”¶
- éªŒè¯å¤±è´¥æ—¶ä¿è¯é‡‘é€€è¿˜ï¼ˆå¯èƒ½æ˜¯ OCW éªŒè¯é”™è¯¯ï¼‰
- è¶…æ—¶æ—¶ä¿è¯é‡‘å…¨éƒ¨å½’å›½åº“ï¼ˆä¹°å®¶æœªä»˜æ¬¾æˆ–æäº¤å‡ tx_hashï¼‰

### 5. ä»˜æ¬¾é‡‘é¢å¤šæ¡£åˆ¤å®š ğŸ†•

é˜²æ­¢ä¹°å®¶å°‘ä»˜ USDT çš„è¯ˆéª—è¡Œä¸ºï¼Œè‡ªåŠ¨æŒ‰æ¯”ä¾‹å¤„ç†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‘é¢å¤šæ¡£åˆ¤å®šæœºåˆ¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   OCW éªŒè¯åè®¡ç®—ä»˜æ¬¾æ¯”ä¾‹:                                       â”‚
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  å®é™…é‡‘é¢ / æœŸæœ›é‡‘é¢                                      â”‚ â”‚
â”‚   â”‚       â”‚                                                   â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ â‰¥ 100.5%  â†’ Overpaid     â†’ âœ… å…¨é¢é‡Šæ”¾          â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ 99.5%-100.5% â†’ Exact     â†’ âœ… å…¨é¢é‡Šæ”¾          â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ 50%-99.5% â†’ Underpaid    â†’ âš ï¸ æŒ‰æ¯”ä¾‹è‡ªåŠ¨å¤„ç†   â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ < 50%     â†’ SeverelyUnderpaid â†’ âš ï¸ æŒ‰æ¯”ä¾‹è‡ªåŠ¨å¤„ç†â”‚ â”‚
â”‚   â”‚       â””â”€â”€ = 0       â†’ Invalid      â†’ âš ï¸ æŒ‰æ¯”ä¾‹è‡ªåŠ¨å¤„ç†   â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚   Underpaid è‡ªåŠ¨å¤„ç†é€»è¾‘:                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  ä¾‹: æœŸæœ› 100 USDTï¼Œå®é™… 80 USDT (80%)                    â”‚ â”‚
â”‚   â”‚       â”‚                                                   â”‚ â”‚
â”‚   â”‚       â”œâ”€â”€ Token: 80% é‡Šæ”¾ç»™ä¹°å®¶ï¼Œ20% é€€è¿˜å–å®¶             â”‚ â”‚
â”‚   â”‚       â””â”€â”€ ä¿è¯é‡‘: å…¨éƒ¨å½’å›½åº“ ğŸ†•                           â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡è¦ç‚¹**ï¼š
- Â±0.5% å®¹å·®å¤„ç†æ±‡ç‡æ³¢åŠ¨å’Œæ‰‹ç»­è´¹
- **æ‰€æœ‰å°‘ä»˜æƒ…å†µ Token æŒ‰æ¯”ä¾‹è‡ªåŠ¨å¤„ç†**ï¼Œæ— éœ€äººå·¥ä»²è£
- ä¹°å®¶è·å¾—ä¸ä»˜æ¬¾æ¯”ä¾‹ç›¸ç­‰çš„ Token
- **å°‘ä»˜/è¶…æ—¶/æ— æ•ˆæ—¶ï¼Œä¿è¯é‡‘å…¨éƒ¨å½’å›½åº“** ğŸ†•
- åªæœ‰å…¨é¢ä»˜æ¬¾æ—¶ï¼Œä¿è¯é‡‘æ‰é€€è¿˜ä¹°å®¶

## æ•°æ®ç»“æ„

### è®¢å• (TradeOrder)

```rust
pub struct TradeOrder<T: Config> {
    pub order_id: u64,           // è®¢å• ID
    pub shop_id: u64,            // åº—é“º ID
    pub maker: T::AccountId,     // æŒ‚å•è€…
    pub side: OrderSide,         // Buy / Sell
    pub channel: PaymentChannel, // NXS / USDT
    pub token_amount: Balance,   // ä»£å¸æ•°é‡
    pub filled_amount: Balance,  // å·²æˆäº¤æ•°é‡
    pub price: Balance,          // å•ä»·ï¼ˆNXS/Tokenï¼‰
    pub status: OrderStatus,     // è®¢å•çŠ¶æ€
    pub created_at: BlockNumber, // åˆ›å»ºåŒºå—
    pub expires_at: BlockNumber, // è¿‡æœŸåŒºå—
}
```

### è®¢å•çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `Open` | æŒ‚å•ä¸­ï¼Œç­‰å¾…æˆäº¤ |
| `PartiallyFilled` | éƒ¨åˆ†æˆäº¤ |
| `Filled` | å®Œå…¨æˆäº¤ |
| `Cancelled` | å·²å–æ¶ˆ |
| `Expired` | å·²è¿‡æœŸ |

### ä¹°å®¶ä¿è¯é‡‘çŠ¶æ€ (BuyerDepositStatus) ğŸ†•

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `None` | æ— ä¿è¯é‡‘ï¼ˆæµç¨‹ A æˆ–é›¶ä¿è¯é‡‘ï¼‰ |
| `Locked` | å·²é”å®šï¼ˆç­‰å¾…äº¤æ˜“å®Œæˆï¼‰ |
| `Released` | å·²é€€è¿˜ï¼ˆäº¤æ˜“å®Œæˆæˆ–éªŒè¯å¤±è´¥ï¼‰ |
| `Forfeited` | å·²æ²¡æ”¶ï¼ˆè¶…æ—¶æœªä»˜æ¬¾ï¼‰ |
| `PartiallyForfeited` | éƒ¨åˆ†æ²¡æ”¶ï¼ˆå°‘ä»˜åœºæ™¯ï¼‰ğŸ†• |

### ä»˜æ¬¾éªŒè¯ç»“æœ (PaymentVerificationResult) ğŸ†•

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| `Exact` | éªŒè¯é€šè¿‡ï¼ˆ99.5%-100.5%ï¼‰ |
| `Overpaid` | å¤šä»˜ï¼ˆâ‰¥100.5%ï¼‰ |
| `Underpaid` | å°‘ä»˜ï¼ˆ50%-99.5%ï¼‰â†’ æŒ‰æ¯”ä¾‹å¤„ç† |
| `SeverelyUnderpaid` | ä¸¥é‡å°‘ä»˜ï¼ˆ<50%ï¼‰â†’ æŒ‰æ¯”ä¾‹å¤„ç† |
| `Invalid` | æ— æ•ˆï¼ˆ0 æˆ–äº¤æ˜“å¤±è´¥ï¼‰â†’ æŒ‰æ¯”ä¾‹å¤„ç† |

### USDT äº¤æ˜“ (UsdtTrade) ğŸ†•æ‰©å±•

```rust
pub struct UsdtTrade<T: Config> {
    // ... åŸæœ‰å­—æ®µ ...
    pub buyer_deposit: BalanceOf<T>,      // ğŸ†• ä¹°å®¶ä¿è¯é‡‘é‡‘é¢ï¼ˆNXSï¼‰
    pub deposit_status: BuyerDepositStatus, // ğŸ†• ä¿è¯é‡‘çŠ¶æ€
}
```

### å¸‚åœºé…ç½® (MarketConfig)

```rust
pub struct MarketConfig {
    pub cos_enabled: bool,      // æ˜¯å¦å¯ç”¨ NXS äº¤æ˜“
    pub usdt_enabled: bool,     // æ˜¯å¦å¯ç”¨ USDT äº¤æ˜“
    pub fee_rate: u16,          // æ‰‹ç»­è´¹ç‡ï¼ˆåŸºç‚¹ï¼‰
    pub min_order_amount: u128, // æœ€å°è®¢å•æ•°é‡
    pub order_ttl: u32,         // è®¢å•æœ‰æ•ˆæœŸï¼ˆåŒºå—æ•°ï¼‰
}
```

## Extrinsics

### NXS é€šé“

#### 1. `place_sell_order`

æŒ‚å–å•ï¼ˆå– Token å¾— NXSï¼‰

```rust
fn place_sell_order(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    price: Balance,  // æ¯ä¸ª Token çš„ NXS ä»·æ ¼
) -> DispatchResult;
```

#### 2. `place_buy_order`

æŒ‚ä¹°å•ï¼ˆç”¨ NXS ä¹° Tokenï¼‰

```rust
fn place_buy_order(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    price: Balance,
) -> DispatchResult;
```

#### 3. `take_order`

åƒå•ï¼ˆæˆäº¤å¯¹æ‰‹ç›˜è®¢å•ï¼‰

```rust
fn take_order(
    origin: OriginFor<T>,
    order_id: u64,
    amount: Option<TokenBalance>,  // None = å…¨éƒ¨åƒæ‰
) -> DispatchResult;
```

#### 4. `cancel_order`

å–æ¶ˆè®¢å•

```rust
fn cancel_order(
    origin: OriginFor<T>,
    order_id: u64,
) -> DispatchResult;
```

### USDT é€šé“

#### 5. `place_usdt_sell_order`

æŒ‚ USDT å–å•ï¼ˆå– Token æ”¶ USDTï¼‰

```rust
fn place_usdt_sell_order(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    usdt_price: u64,           // æ¯ä¸ª Token çš„ USDT ä»·æ ¼ï¼ˆç²¾åº¦ 10^6ï¼‰
    tron_address: Vec<u8>,     // å–å®¶ TRON æ”¶æ¬¾åœ°å€
) -> DispatchResult;
```

#### 6. `place_usdt_buy_order`

æŒ‚ USDT ä¹°å•ï¼ˆç”¨ USDT ä¹° Tokenï¼‰

```rust
fn place_usdt_buy_order(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    usdt_price: u64,
) -> DispatchResult;
```

#### 7. `reserve_usdt_sell_order` ğŸ†•

é¢„é”å®š USDT å–å•ï¼ˆä¹°å®¶å‘èµ·ï¼Œä¸¤é˜¶æ®µå®‰å…¨æ¨¡å¼ï¼‰

```rust
fn reserve_usdt_sell_order(
    origin: OriginFor<T>,
    order_id: u64,
    amount: Option<TokenBalance>,
) -> DispatchResult;
```

> **æ³¨æ„**: ä¹°å®¶å…ˆè°ƒç”¨æ­¤å‡½æ•°é”å®šè®¢å•ä»½é¢å’Œä¿è¯é‡‘ï¼Œç„¶åé“¾ä¸‹æ”¯ä»˜ USDTï¼Œæœ€åè°ƒç”¨ `confirm_usdt_payment` æäº¤ tx_hashã€‚

#### 8. `accept_usdt_buy_order`

æ¥å— USDT ä¹°å•ï¼ˆå–å®¶å‘èµ·ï¼‰

```rust
fn accept_usdt_buy_order(
    origin: OriginFor<T>,
    order_id: u64,
    amount: Option<TokenBalance>,
    tron_address: Vec<u8>,     // å–å®¶ TRON æ”¶æ¬¾åœ°å€
) -> DispatchResult;
```

#### 9. `confirm_usdt_payment`

ä¹°å®¶ç¡®è®¤ USDT æ”¯ä»˜ï¼ˆæäº¤äº¤æ˜“å“ˆå¸Œï¼‰

```rust
fn confirm_usdt_payment(
    origin: OriginFor<T>,
    trade_id: u64,
    tron_tx_hash: Vec<u8>,
) -> DispatchResult;
```

#### 10. `verify_usdt_payment`

OCW éªŒè¯ USDT æ”¯ä»˜ç»“æœï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ `claim_verification_reward` æ›¿ä»£ï¼‰

```rust
fn verify_usdt_payment(
    origin: OriginFor<T>,
    trade_id: u64,
    verified: bool,
    actual_amount: u64,
) -> DispatchResult;
```

#### 11. `process_usdt_timeout`

å¤„ç†è¶…æ—¶çš„ USDT äº¤æ˜“ï¼ˆä»»ä½•äººå¯è°ƒç”¨ï¼‰

```rust
fn process_usdt_timeout(
    origin: OriginFor<T>,
    trade_id: u64,
) -> DispatchResult;
```

### OCW æ¿€åŠ±æœºåˆ¶ ğŸ†•

#### 18. `submit_ocw_result`

OCW æäº¤éªŒè¯ç»“æœï¼ˆæ— ç­¾åäº¤æ˜“ï¼‰

```rust
fn submit_ocw_result(
    origin: OriginFor<T>,
    trade_id: u64,
    verified: bool,
    actual_amount: u64,
) -> DispatchResult;
```

#### 19. `claim_verification_reward`

é¢†å–éªŒè¯å¥–åŠ±ï¼ˆä»»ä½•äººå¯è°ƒç”¨ï¼‰

```rust
fn claim_verification_reward(
    origin: OriginFor<T>,
    trade_id: u64,
) -> DispatchResult;
```

**æ¿€åŠ±æœºåˆ¶è¯´æ˜**ï¼š
- OCW éªŒè¯å®Œæˆåï¼Œé€šè¿‡ `submit_ocw_result` æäº¤ç»“æœåˆ°é“¾ä¸Š
- ä»»ä½•äººå¯è°ƒç”¨ `claim_verification_reward` ç¡®è®¤éªŒè¯å¹¶è·å–å¥–åŠ±
- å¥–åŠ±é‡‘é¢ç”± `VerificationReward` é…ç½®ï¼Œä» `RewardSource` è´¦æˆ·æ”¯ä»˜

### å¸‚ä»·å•

#### 12. `market_buy`

å¸‚ä»·ä¹°å•ï¼ˆç«‹å³ä»¥æœ€ä¼˜å–ä»·æˆäº¤ï¼‰

```rust
fn market_buy(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    max_cost: Balance,             // æ»‘ç‚¹ä¿æŠ¤
) -> DispatchResult;
```

#### 13. `market_sell`

å¸‚ä»·å–å•ï¼ˆç«‹å³ä»¥æœ€ä¼˜ä¹°ä»·æˆäº¤ï¼‰

```rust
fn market_sell(
    origin: OriginFor<T>,
    shop_id: u64,
    token_amount: TokenBalance,
    min_receive: Balance,          // æ»‘ç‚¹ä¿æŠ¤
) -> DispatchResult;
```

### ç®¡ç†

#### 14. `configure_market`

é…ç½®åº—é“ºå¸‚åœºï¼ˆåº—ä¸»è°ƒç”¨ï¼‰

```rust
fn configure_market(
    origin: OriginFor<T>,
    shop_id: u64,
    cos_enabled: bool,
    usdt_enabled: bool,
    fee_rate: u16,
    min_order_amount: u128,
    order_ttl: u32,
    usdt_timeout: u32,
) -> DispatchResult;
```

## äº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `OrderCreated` | NXS è®¢å•å·²åˆ›å»º |
| `OrderFilled` | NXS è®¢å•å·²æˆäº¤ï¼ˆéƒ¨åˆ†æˆ–å…¨éƒ¨ï¼‰ |
| `OrderCancelled` | è®¢å•å·²å–æ¶ˆ |
| `MarketConfigured` | å¸‚åœºé…ç½®å·²æ›´æ–° |
| `UsdtSellOrderCreated` | USDT å–å•å·²åˆ›å»º |
| `UsdtBuyOrderCreated` | USDT ä¹°å•å·²åˆ›å»º |
| `UsdtTradeCreated` | USDT äº¤æ˜“å·²åˆ›å»ºï¼ˆç­‰å¾…æ”¯ä»˜ï¼‰ |
| `UsdtPaymentSubmitted` | USDT æ”¯ä»˜å·²æäº¤ï¼ˆç­‰å¾…éªŒè¯ï¼‰ |
| `UsdtTradeCompleted` | USDT äº¤æ˜“å·²å®Œæˆ |
| `UsdtTradeVerificationFailed` | USDT äº¤æ˜“éªŒè¯å¤±è´¥ |
| `UsdtTradeRefunded` | USDT äº¤æ˜“å·²è¶…æ—¶é€€æ¬¾ |
| `VerificationRewardClaimed` | éªŒè¯å¥–åŠ±å·²é¢†å– |
| `OcwResultSubmitted` | OCW éªŒè¯ç»“æœå·²æäº¤ |
| `BuyerDepositLocked` | ä¹°å®¶ä¿è¯é‡‘å·²é”å®š ğŸ†• |
| `BuyerDepositReleased` | ä¹°å®¶ä¿è¯é‡‘å·²é€€è¿˜ ğŸ†• |
| `BuyerDepositForfeited` | ä¹°å®¶ä¿è¯é‡‘å·²æ²¡æ”¶ ğŸ†• |
| `UnderpaidAutoProcessed` | å°‘ä»˜è‡ªåŠ¨å¤„ç†ï¼ˆæŒ‰æ¯”ä¾‹é‡Šæ”¾ï¼‰ğŸ†• |
| `MarketOrderExecuted` | å¸‚ä»·å•å·²æ‰§è¡Œ |
| `BestPricesUpdated` | æœ€ä¼˜ä»·æ ¼å·²æ›´æ–° |
| `TwapUpdated` | TWAP ä»·æ ¼å·²æ›´æ–° |
| `CircuitBreakerTriggered` | ç†”æ–­å·²è§¦å‘ |
| `CircuitBreakerLifted` | ç†”æ–­å·²è§£é™¤ |
| `PriceProtectionConfigured` | ä»·æ ¼ä¿æŠ¤é…ç½®å·²æ›´æ–° |
| `InitialPriceSet` | åˆå§‹ä»·æ ¼å·²è®¾ç½® |

## é”™è¯¯

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `ShopNotFound` | åº—é“ºä¸å­˜åœ¨ |
| `TokenNotEnabled` | åº—é“ºä»£å¸æœªå¯ç”¨ |
| `MarketNotEnabled` | NXS å¸‚åœºæœªå¯ç”¨ |
| `UsdtMarketNotEnabled` | USDT å¸‚åœºæœªå¯ç”¨ |
| `OrderNotFound` | è®¢å•ä¸å­˜åœ¨ |
| `NotOrderOwner` | ä¸æ˜¯è®¢å•æ‰€æœ‰è€… |
| `OrderClosed` | è®¢å•å·²å…³é—­ |
| `InsufficientBalance` | NXS ä½™é¢ä¸è¶³ |
| `InsufficientTokenBalance` | Token ä½™é¢ä¸è¶³ |
| `CannotTakeOwnOrder` | ä¸èƒ½åƒè‡ªå·±çš„å• |
| `InvalidTronAddress` | æ— æ•ˆçš„ TRON åœ°å€ |
| `UsdtTradeNotFound` | USDT äº¤æ˜“ä¸å­˜åœ¨ |
| `NotTradeParticipant` | ä¸æ˜¯äº¤æ˜“å‚ä¸è€… |
| `InvalidTradeStatus` | äº¤æ˜“çŠ¶æ€æ— æ•ˆ |
| `TradeTimeout` | äº¤æ˜“å·²è¶…æ—¶ |
| `InvalidTxHash` | æ— æ•ˆçš„äº¤æ˜“å“ˆå¸Œ |
| `ChannelMismatch` | é€šé“ä¸åŒ¹é… |
| `NoOrdersAvailable` | æ²¡æœ‰å¯ç”¨è®¢å• |
| `SlippageExceeded` | æ»‘ç‚¹è¶…é™ |
| `PriceDeviationTooHigh` | ä»·æ ¼åç¦» TWAP è¿‡å¤§ |
| `MarketCircuitBreakerActive` | å¸‚åœºå¤„äºç†”æ–­çŠ¶æ€ |
| `OcwResultNotFound` | OCW éªŒè¯ç»“æœä¸å­˜åœ¨ |
| `InsufficientTwapData` | TWAP æ•°æ®ä¸è¶³ |
| `InsufficientDepositBalance` | ä¹°å®¶ä¿è¯é‡‘ä½™é¢ä¸è¶³ ğŸ†• |

## å­˜å‚¨é¡¹

| å­˜å‚¨é¡¹ | è¯´æ˜ |
|--------|------|
| `NextOrderId` | ä¸‹ä¸€ä¸ªè®¢å• ID |
| `Orders` | è®¢å•å­˜å‚¨ |
| `ShopSellOrders` | åº—é“ºå–å•åˆ—è¡¨ |
| `ShopBuyOrders` | åº—é“ºä¹°å•åˆ—è¡¨ |
| `UserOrders` | ç”¨æˆ·è®¢å•åˆ—è¡¨ |
| `MarketConfigs` | åº—é“ºå¸‚åœºé…ç½® |
| `MarketStatsStorage` | å¸‚åœºç»Ÿè®¡æ•°æ® |
| `NextUsdtTradeId` | ä¸‹ä¸€ä¸ª USDT äº¤æ˜“ ID |
| `UsdtTrades` | USDT äº¤æ˜“è®°å½•å­˜å‚¨ |
| `PendingUsdtTrades` | å¾…éªŒè¯çš„ USDT äº¤æ˜“åˆ—è¡¨ |
| `OcwVerificationResults` | OCW éªŒè¯ç»“æœå­˜å‚¨ ğŸ†• |
| `BestAsk` | åº—é“ºæœ€ä¼˜å–ä»· |
| `BestBid` | åº—é“ºæœ€ä¼˜ä¹°ä»· |
| `LastTradePrice` | åº—é“ºæœ€æ–°æˆäº¤ä»· |
| `MarketSummaryStorage` | åº—é“ºå¸‚åœºæ‘˜è¦ |
| `TwapAccumulators` | TWAP ç´¯ç§¯å™¨ï¼ˆæ¯åº—é“ºï¼‰ |
| `PriceProtection` | ä»·æ ¼ä¿æŠ¤é…ç½®ï¼ˆæ¯åº—é“ºï¼‰ |

## é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `DefaultOrderTTL` | é»˜è®¤è®¢å•æœ‰æ•ˆæœŸ | 14400 åŒºå—ï¼ˆçº¦24å°æ—¶ï¼‰ |
| `MaxActiveOrdersPerUser` | æ¯ç”¨æˆ·æœ€å¤§æ´»è·ƒè®¢å•æ•° | 100 |
| `DefaultFeeRate` | é»˜è®¤æ‰‹ç»­è´¹ç‡ | 100 åŸºç‚¹ï¼ˆ1%ï¼‰ |
| `DefaultUsdtTimeout` | USDT äº¤æ˜“é»˜è®¤è¶…æ—¶ | 7200 åŒºå—ï¼ˆçº¦12å°æ—¶ï¼‰ |
| `BlocksPerHour` | 1å°æ—¶å¯¹åº”åŒºå—æ•° | 600 åŒºå— |
| `BlocksPerDay` | 24å°æ—¶å¯¹åº”åŒºå—æ•° | 14400 åŒºå— |
| `BlocksPerWeek` | 7å¤©å¯¹åº”åŒºå—æ•° | 100800 åŒºå— |
| `CircuitBreakerDuration` | ç†”æ–­æŒç»­æ—¶é—´ | 600 åŒºå—ï¼ˆçº¦1å°æ—¶ï¼‰ |
| `VerificationReward` | éªŒè¯å¥–åŠ±é‡‘é¢ | 0.1 NXS |
| `RewardSource` | å¥–åŠ±æ¥æºè´¦æˆ· | è´¢åº“è´¦æˆ· |
| `BuyerDepositRate` | ä¹°å®¶ä¿è¯é‡‘æ¯”ä¾‹ï¼ˆbpsï¼‰ | 1000ï¼ˆ10%ï¼‰ğŸ†• |
| `MinBuyerDeposit` | æœ€ä½ä¹°å®¶ä¿è¯é‡‘ | 10 NXS ğŸ†• |
| `DepositForfeitRate` | ä¿è¯é‡‘æ²¡æ”¶æ¯”ä¾‹ï¼ˆbpsï¼‰ | 10000ï¼ˆ100%ï¼‰ğŸ†• |
| `UsdtToNxsRate` | USDTâ†’NXS æ±‡ç‡ï¼ˆç²¾åº¦ 10^9ï¼‰ | 10_000_000_000 ğŸ†• |
| `TreasuryAccount` | å›½åº“è´¦æˆ·ï¼ˆæ²¡æ”¶ä¿è¯é‡‘å½’å…¥ï¼‰| ç³»ç»Ÿè´¢åº“ ğŸ†• |

## ä½¿ç”¨ç¤ºä¾‹

### 1. åº—ä¸»é…ç½®å¸‚åœº

```rust
// å¯ç”¨ NXS å’Œ USDT äº¤æ˜“
EntityMarket::configure_market(
    Origin::signed(shop_owner),
    shop_id,
    true,   // cos_enabled
    true,   // usdt_enabled
    50,     // fee_rate (0.5%)
    100,    // min_order_amount
    14400,  // order_ttl (24h)
    7200,   // usdt_timeout (12h)
)?;
```

### 2. NXS é€šé“ - æŒ‚å–å•

```rust
// ä»¥ 0.1 NXS/Token çš„ä»·æ ¼å‡ºå”® 1000 Token
EntityMarket::place_sell_order(
    Origin::signed(alice),
    shop_id,
    1000,           // token_amount
    100_000_000,    // price (0.1 NXS, ç²¾åº¦ 10^9)
)?;
```

### 3. NXS é€šé“ - åƒå•

```rust
// åƒæ‰è®¢å• #1 çš„å…¨éƒ¨
EntityMarket::take_order(
    Origin::signed(bob),
    1,      // order_id
    None,   // amount (å…¨éƒ¨)
)?;
```

### 4. USDT é€šé“ - æŒ‚å–å•

```rust
// ä»¥ 0.01 USDT/Token çš„ä»·æ ¼å‡ºå”® 1000 Token
EntityMarket::place_usdt_sell_order(
    Origin::signed(alice),
    shop_id,
    1000,                           // token_amount
    10_000,                         // usdt_price (0.01 USDT, ç²¾åº¦ 10^6)
    b"TXyz...".to_vec(),           // tron_address
)?;
```

### 5. USDT é€šé“ - åƒå–å•ï¼ˆä¸¤é˜¶æ®µå®‰å…¨æ¨¡å¼ï¼‰ğŸ†•

```rust
// æ­¥éª¤ 1: Bob é¢„é”å®šè®¢å•ï¼ˆé”å®šä¿è¯é‡‘ + è®¢å•ä»½é¢ï¼‰
EntityMarket::reserve_usdt_sell_order(
    Origin::signed(bob),
    order_id,
    None,                                           // amount (å…¨éƒ¨)
)?;

// æ­¥éª¤ 2: Bob é“¾ä¸‹è½¬ USDT åˆ° Alice çš„ TRON åœ°å€
// (é“¾ä¸‹æ“ä½œï¼Œè·å¾— tron_tx_hash)

// æ­¥éª¤ 3: Bob æäº¤äº¤æ˜“å“ˆå¸Œ
EntityMarket::confirm_usdt_payment(
    Origin::signed(bob),
    trade_id,
    b"abc123...".to_vec(),                         // tron_tx_hash (64 å­—ç¬¦)
)?;

// æ­¥éª¤ 4: ç­‰å¾… OCW éªŒè¯ + ä»»ä½•äººè°ƒç”¨ claim_verification_reward
```

### 6. USDT é€šé“ - æ¥å—ä¹°å•

```rust
// Alice æ¥å— Bob çš„ USDT ä¹°å•
EntityMarket::accept_usdt_buy_order(
    Origin::signed(alice),
    order_id,
    None,                           // amount (å…¨éƒ¨)
    b"TXyz...".to_vec(),           // tron_address
)?;

// Bob é“¾ä¸‹è½¬ USDT åç¡®è®¤æ”¯ä»˜
EntityMarket::confirm_usdt_payment(
    Origin::signed(bob),
    trade_id,
    b"abc123...".to_vec(),         // tron_tx_hash
)?;
// ç­‰å¾… OCW éªŒè¯...
```

### 7. å¸‚ä»·ä¹°å•

```rust
// ä»¥æœ€ä¼˜ä»·æ ¼ç«‹å³è´­ä¹° 1000 Tokenï¼Œæœ€å¤šæ”¯ä»˜ 200 NXS
EntityMarket::market_buy(
    Origin::signed(bob),
    shop_id,
    1000,                           // token_amount
    200_000_000_000,               // max_cost (200 NXS, æ»‘ç‚¹ä¿æŠ¤)
)?;
```

### 8. å¸‚ä»·å–å•

```rust
// ä»¥æœ€ä¼˜ä»·æ ¼ç«‹å³å‡ºå”® 1000 Tokenï¼Œæœ€å°‘æ”¶åˆ° 80 NXS
EntityMarket::market_sell(
    Origin::signed(alice),
    shop_id,
    1000,                           // token_amount
    80_000_000_000,                // min_receive (80 NXS, æ»‘ç‚¹ä¿æŠ¤)
)?;
```

### 9. æŸ¥è¯¢è®¢å•ç°¿æ·±åº¦

```rust
// è·å–è®¢å•ç°¿æ·±åº¦ï¼ˆæ¯è¾¹ 10 æ¡£ï¼‰
let depth = EntityMarket::get_order_book_depth(shop_id, 10);
// depth.asks: å–ç›˜ï¼ˆæŒ‰ä»·æ ¼å‡åºï¼‰
// depth.bids: ä¹°ç›˜ï¼ˆæŒ‰ä»·æ ¼é™åºï¼‰
// depth.best_ask: æœ€ä¼˜å–ä»·
// depth.best_bid: æœ€ä¼˜ä¹°ä»·
// depth.spread: ä¹°å–ä»·å·®
```

### 10. æŸ¥è¯¢å¸‚åœºæ‘˜è¦

```rust
// è·å–å¸‚åœºæ‘˜è¦
let summary = EntityMarket::get_market_summary(shop_id);
// summary.best_ask: æœ€ä¼˜å–ä»·
// summary.best_bid: æœ€ä¼˜ä¹°ä»·
// summary.last_price: æœ€æ–°æˆäº¤ä»·
// summary.total_ask_amount: å–å•æ€»é‡
// summary.total_bid_amount: ä¹°å•æ€»é‡
```

### 11. æŸ¥è¯¢æœ€ä¼˜ä»·æ ¼

```rust
// è·å–æœ€ä¼˜ä¹°å–ä»·
let (best_ask, best_bid) = EntityMarket::get_best_prices(shop_id);

// è·å–ä¹°å–ä»·å·®
let spread = EntityMarket::get_spread(shop_id);
```

### 12. é…ç½®ä»·æ ¼ä¿æŠ¤

```rust
// åº—ä¸»é…ç½®ä»·æ ¼ä¿æŠ¤å‚æ•°
EntityMarket::configure_price_protection(
    Origin::signed(shop_owner),
    shop_id,
    true,   // enabled: å¯ç”¨ä»·æ ¼ä¿æŠ¤
    2000,   // max_price_deviation: 20% (åŸºç‚¹)
    500,    // max_slippage: 5% (åŸºç‚¹)
    5000,   // circuit_breaker_threshold: 50% (åŸºç‚¹)
    100,    // min_trades_for_twap: æœ€å°‘100ç¬”äº¤æ˜“åå¯ç”¨TWAP
)?;
```

### 13. æŸ¥è¯¢ TWAP ä»·æ ¼

```rust
// è·å– 1å°æ—¶ TWAP
let twap_1h = EntityMarket::calculate_twap(shop_id, TwapPeriod::OneHour);

// è·å– 24å°æ—¶ TWAP
let twap_24h = EntityMarket::calculate_twap(shop_id, TwapPeriod::OneDay);

// è·å– 7å¤© TWAP
let twap_7d = EntityMarket::calculate_twap(shop_id, TwapPeriod::OneWeek);
```

### 14. è§£é™¤ç†”æ–­

```rust
// åº—ä¸»åœ¨ç†”æ–­æ—¶é—´åˆ°æœŸåæ‰‹åŠ¨è§£é™¤
EntityMarket::lift_circuit_breaker(
    Origin::signed(shop_owner),
    shop_id,
)?;
```

### 15. è®¾ç½®åº—é“ºä»£å¸åˆå§‹ä»·æ ¼

```rust
// åº—ä¸»è®¾ç½®åˆå§‹å‚è€ƒä»·æ ¼ï¼ˆç”¨äº TWAP å†·å¯åŠ¨ï¼‰
// åœ¨å¸‚åœºæˆäº¤é‡ä¸è¶³æ—¶ï¼Œå°†ä½¿ç”¨æ­¤ä»·æ ¼ä½œä¸ºä»·æ ¼åç¦»æ£€æŸ¥çš„å‚è€ƒ
EntityMarket::set_initial_price(
    Origin::signed(shop_owner),
    shop_id,
    100_000_000_000,  // åˆå§‹ä»·æ ¼: 100 NXS / Token
)?;
```

**åˆå§‹ä»·æ ¼ä½¿ç”¨é€»è¾‘ï¼š**
1. å¦‚æœæˆäº¤é‡ >= `min_trades_for_twap`ï¼Œä½¿ç”¨ 1å°æ—¶ TWAP
2. å¦‚æœæˆäº¤é‡ä¸è¶³ä½†æœ‰åˆå§‹ä»·æ ¼ï¼Œä½¿ç”¨åº—ä¸»è®¾å®šçš„åˆå§‹ä»·æ ¼
3. å¦‚æœéƒ½æ²¡æœ‰ï¼Œè·³è¿‡ä»·æ ¼åç¦»æ£€æŸ¥

## ä¾èµ–æ¨¡å—

- `pallet-entity-common`: å…¬å…±ç±»å‹å’Œ Trait
- `pallet-entity-shop`: åº—é“ºä¿¡æ¯æŸ¥è¯¢
- `pallet-entity-token`: åº—é“ºä»£å¸æ“ä½œ

## ç‰ˆæœ¬å†å²

- **v0.1.0** (2026-02-01): Phase 1ï¼Œå®ç° NXS é€šé“é™ä»·å•
- **v0.2.0** (2026-02-01): Phase 2ï¼Œå®ç° USDT é€šé“ + OCW éªŒè¯
- **v0.3.0** (2026-02-01): Phase 3ï¼Œå®ç°å¸‚ä»·å•æ”¯æŒ
- **v0.4.0** (2026-02-01): Phase 4ï¼Œå®ç°è®¢å•ç°¿æ·±åº¦ä¼˜åŒ–
- **v0.5.0** (2026-02-01): Phase 5ï¼Œå®ç°ä¸‰å‘¨æœŸ TWAP ä»·æ ¼é¢„è¨€æœº
- **v0.6.0** (2026-02-04): Phase 6ï¼Œå®ç° OCW éªŒè¯æ¿€åŠ±æœºåˆ¶ + ValidateUnsigned
- **v0.7.0** (2026-02-04): Phase 7ï¼Œå®ç°ä¹°å®¶ä¿è¯é‡‘æœºåˆ¶ï¼ˆå›ºå®šæ¯”ä¾‹ NXS ä¿è¯é‡‘ï¼‰
- **v0.8.0** (2026-02-04): Phase 8ï¼Œå®ç°ä»˜æ¬¾é‡‘é¢å¤šæ¡£åˆ¤å®š + è‡ªåŠ¨æŒ‰æ¯”ä¾‹å¤„ç†

## åç»­è®¡åˆ’

- [x] Phase 1: NXS é€šé“é™ä»·å• âœ…
- [x] Phase 2: USDT é€šé“ + OCW éªŒè¯ âœ…
- [x] Phase 3: å¸‚ä»·å•æ”¯æŒ âœ…
- [x] Phase 4: è®¢å•ç°¿æ·±åº¦ä¼˜åŒ– âœ…
- [x] Phase 5: ä»·æ ¼é¢„è¨€æœºé›†æˆ âœ…
- [x] Phase 6: OCW éªŒè¯æ¿€åŠ±æœºåˆ¶ âœ…
- [x] Phase 7: ä¹°å®¶ä¿è¯é‡‘æœºåˆ¶ âœ…
- [x] Phase 8: ä»˜æ¬¾é‡‘é¢å¤šæ¡£åˆ¤å®š âœ…
