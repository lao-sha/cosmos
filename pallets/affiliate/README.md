# Pallet Affiliate

## æ¨¡å—æ¦‚è¿°

**pallet-affiliate** æ˜¯ä¸€ä¸ªç»Ÿä¸€è”ç›Ÿè®¡é…¬ç³»ç»Ÿï¼Œæ•´åˆäº†åŸæœ‰çš„5ä¸ªè”ç›Ÿè®¡é…¬ç›¸å…³palletï¼Œæä¾›å®Œæ•´çš„15å±‚æ¨èå…³ç³»ç®¡ç†å’Œå¤šæ¨¡å¼åˆ†æˆè®¡é…¬åŠŸèƒ½ã€‚

### è®¾è®¡ç†å¿µ

- **ç»Ÿä¸€**ï¼šæ•´åˆ5ä¸ªç‹¬ç«‹æ¨¡å—ä¸ºå•ä¸€palletï¼Œé™ä½ç»´æŠ¤æˆæœ¬
- **çµæ´»**ï¼šæ”¯æŒä¸‰ç§ç»“ç®—æ¨¡å¼ï¼ˆå³æ—¶/å‘¨ç»“ç®—/æ··åˆï¼‰ï¼Œé€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯
- **é«˜æ•ˆ**ï¼š15å±‚æ¨èé“¾å‹ç¼©ç®—æ³•ï¼Œè‡ªåŠ¨åˆ†é…å¥–åŠ±
- **æ˜“ç”¨**ï¼šç®€åŒ–çš„APIè®¾è®¡ï¼Œé™ä½é›†æˆéš¾åº¦
- **ğŸ†• æ²»ç†é©±åŠ¨**ï¼šå…³é”®å‚æ•°ï¼ˆåˆ†æˆæ¯”ä¾‹ã€å¹´è´¹ä»·æ ¼ï¼‰é€šè¿‡å…¨æ°‘æŠ•ç¥¨ä¿®æ”¹

**ç‰ˆæœ¬**: v1.1.0
**æœ€åæ›´æ–°**: 2025-12-30

## æ¶æ„å˜æ›´ï¼ˆğŸ†• 2025-12-30ï¼‰

### æ¨èå…³ç³»æŠ½ç¦»

æ¨èå…³ç³»ç®¡ç†åŠŸèƒ½å·²æŠ½ç¦»åˆ°ç‹¬ç«‹çš„ `pallet-affiliate-referral` æ¨¡å—ï¼š

| åŸæ¨¡å— | æ–°æ¨¡å— | è¯´æ˜ |
|--------|--------|------|
| `pallet-affiliate::referral` | `pallet-affiliate-referral` | æ¨èäººç»‘å®šã€æ¨èç ç®¡ç†ã€æ¨èé“¾æŸ¥è¯¢ |

**è¿ç§»å½±å“**ï¼š
- å­˜å‚¨é¡¹ `Sponsors`ã€`AccountByCode`ã€`CodeByAccount` å·²è¿ç§»åˆ° `pallet-affiliate-referral`
- æœ¬æ¨¡å—é€šè¿‡ `Config: pallet_affiliate_referral::Config` ç»§æ‰¿æ¨èå…³ç³»åŠŸèƒ½
- å¯¹å¤–æ¥å£ä¿æŒå…¼å®¹ï¼Œ`bind_sponsor` å’Œ `claim_code` å§”æ‰˜åˆ° referral pallet

## æ•´åˆè‡ª

æœ¬æ¨¡å—æ•´åˆäº†ä»¥ä¸‹5ä¸ªç‹¬ç«‹palletçš„åŠŸèƒ½ï¼š

- `pallet-affiliate`: èµ„é‡‘æ‰˜ç®¡
- `pallet-affiliate-config`: é…ç½®ç®¡ç†
- `pallet-affiliate-instant`: å³æ—¶åˆ†æˆ
- `pallet-affiliate-weekly`: å‘¨ç»“ç®—
- ~~`pallet-memo-referrals`: æ¨èå…³ç³»~~ â†’ å·²æŠ½ç¦»åˆ° `pallet-affiliate-referral`

## æ ¸å¿ƒåŠŸèƒ½

### 1. æ¨èå…³ç³»ç®¡ç†ï¼ˆreferral.rsï¼‰

æ¨èå…³ç³»æ˜¯è”ç›Ÿè®¡é…¬çš„åŸºç¡€ï¼Œå»ºç«‹æ¨èäººä¸è¢«æ¨èäººä¹‹é—´çš„æ°¸ä¹…ç»‘å®šå…³ç³»ã€‚

#### 1.1 æ¨èäººç»‘å®š

- **ç»‘å®šæ–¹å¼**ï¼šæ–°ç”¨æˆ·é€šè¿‡æ¨èç ç»‘å®šæ¨èäºº
- **ç»‘å®šç‰¹æ€§**ï¼šæ¨èå…³ç³»ä¸€ç»ç»‘å®šæ°¸ä¹…ç”Ÿæ•ˆï¼Œä¸å¯ä¿®æ”¹
- **å¾ªç¯æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆAâ†’Bâ†’Câ†’Aï¼‰
- **èµ„æ ¼éªŒè¯**ï¼šæ¨èäººå¿…é¡»æ˜¯æœ‰æ•ˆä¼šå‘˜
- **æœ€å¤§æœç´¢æ·±åº¦**ï¼š`MaxSearchHops` é…ç½®å‚æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯

#### 1.2 æ¨èç ç®¡ç†

- **è®¤é¢†æœºåˆ¶**ï¼šæœ‰æ•ˆä¼šå‘˜å¯è®¤é¢†è‡ªå®šä¹‰æ¨èç 
- **é•¿åº¦é™åˆ¶**ï¼šæ¨èç é•¿åº¦èŒƒå›´ [MIN_CODE_LEN, MaxCodeLen]ï¼ˆé»˜è®¤4-16å­—èŠ‚ï¼‰
- **å”¯ä¸€æ€§ä¿è¯**ï¼šæ¨èç å…¨å±€å”¯ä¸€ï¼Œå…ˆåˆ°å…ˆå¾—
- **åŒå‘æ˜ å°„**ï¼šè´¦æˆ·â†”æ¨èç åŒå‘æ˜ å°„ï¼Œå¿«é€ŸæŸ¥è¯¢
- **é»˜è®¤æ¨èç **ï¼šç³»ç»Ÿå¯ä¸ºä¼šå‘˜è‡ªåŠ¨ç”Ÿæˆé»˜è®¤æ¨èç ï¼ˆè´¦æˆ·IDå‰8ä½åå…­è¿›åˆ¶ï¼‰

#### 1.3 æ¨èé“¾æŸ¥è¯¢

- **å‘ä¸Šè¿½æº¯**ï¼šä»æŒ‡å®šè´¦æˆ·å‘ä¸Šè¿½æº¯æ¨èäººé“¾æ¡
- **æœ€å¤§å±‚æ•°**ï¼šæœ€å¤šè¿½æº¯15å±‚ï¼ˆMAX_REFERRAL_CHAINï¼‰
- **å¿«é€ŸæŸ¥è¯¢**ï¼šä½¿ç”¨ `Sponsors` StorageMap å®ç° O(1) æŸ¥è¯¢
- **é˜²æŠ¤æœºåˆ¶**ï¼šæœ€å¤§æœç´¢æ·±åº¦ä¿æŠ¤ï¼Œé˜²æ­¢æ— é™å¾ªç¯

### 2. é…ç½®ç®¡ç†ï¼ˆtypes.rsï¼‰

é…ç½®ç®¡ç†æä¾›çµæ´»çš„ç»“ç®—æ¨¡å¼å’Œåˆ†æˆæ¯”ä¾‹é…ç½®ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´ã€‚

#### 2.1 ä¸‰ç§ç»“ç®—æ¨¡å¼

| æ¨¡å¼ | æè¿° | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Weekly** | å…¨éƒ¨å‘¨ç»“ç®— | æ‰¹é‡ç»“ç®—ï¼ŒèŠ‚çœGas | å¤§é¢äº¤æ˜“ï¼Œç¤¾åŒºæ¿€åŠ± |
| **Instant** | å…¨éƒ¨å³æ—¶åˆ†æˆ | å®æ—¶è½¬è´¦ï¼Œç«‹å³åˆ°è´¦ | å°é¢äº¤æ˜“ï¼Œå¿«é€Ÿæ¿€åŠ± |
| **Hybrid** | æ··åˆæ¨¡å¼ | å‰Nå±‚å³æ—¶ï¼ŒåMå±‚å‘¨ç»“ç®— | å¹³è¡¡æ•ˆç‡ä¸æ¿€åŠ± |

**æ··åˆæ¨¡å¼é…ç½®ç¤ºä¾‹**ï¼š
- å‰5å±‚å³æ—¶åˆ†æˆï¼šå¿«é€Ÿæ¿€åŠ±ç›´æ¨å›¢é˜Ÿ
- å10å±‚å‘¨ç»“ç®—ï¼šç¨³å®šæ”¶ç›Šï¼Œæ‰¹é‡ç»“ç®—

#### 2.2 åˆ†æˆæ¯”ä¾‹é…ç½®

**å³æ—¶åˆ†æˆæ¯”ä¾‹ï¼ˆInstantLevelPercentsï¼‰**ï¼š
- 15å±‚ç‹¬ç«‹é…ç½®ï¼Œæ¯å±‚0-100%
- é»˜è®¤é…ç½®ï¼ˆæ€»è®¡99%ï¼‰ï¼š
  ```rust
  [30, 25, 15, 10, 7, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1]
  ```
  - L1: 30%ï¼ˆæœ€é«˜å¥–åŠ±ï¼‰
  - L2: 25%
  - L3: 15%
  - L4: 10%
  - L5: 7%
  - L6: 3%
  - L7-L9: å„2%
  - L10-L15: å„1%

**å‘¨ç»“ç®—åˆ†æˆæ¯”ä¾‹ï¼ˆWeeklyLevelPercentsï¼‰**ï¼š
- 15å±‚ç‹¬ç«‹é…ç½®ï¼Œæ¯å±‚0-100%
- é»˜è®¤é…ç½®ï¼ˆæ€»è®¡82%ï¼‰ï¼š
  ```rust
  [20, 10, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4]
  ```
  - L1: 20%
  - L2: 10%
  - L3-L15: å„4%

#### 2.3 æ¯å‘¨åŒºå—æ•°é…ç½®

- **ç”¨é€”**ï¼šç”¨äºå‘¨æœŸè®¡ç®—å’Œæ´»è·ƒæœŸç®¡ç†
- **é»˜è®¤å€¼**ï¼š100800å—ï¼ˆå‡è®¾6ç§’å‡ºå—ï¼Œ1å‘¨â‰ˆ100800å—ï¼‰
- **å¯è°ƒæ•´**ï¼šç®¡ç†å‘˜å¯æ ¹æ®å®é™…å‡ºå—æ—¶é—´è°ƒæ•´

### 3. èµ„é‡‘æ‰˜ç®¡ï¼ˆescrow.rsï¼‰

èµ„é‡‘æ‰˜ç®¡æä¾›ç‹¬ç«‹çš„æ‰˜ç®¡è´¦æˆ·ï¼Œå®ç°è”ç›Ÿå¥–åŠ±èµ„é‡‘ä¸å¹³å°èµ„é‡‘çš„éš”ç¦»ã€‚

#### 3.1 ç‹¬ç«‹æ‰˜ç®¡è´¦æˆ·

- **è´¦æˆ·æ´¾ç”Ÿ**ï¼šä½¿ç”¨ `EscrowPalletId` æ´¾ç”Ÿç‹¬ç«‹æ‰˜ç®¡è´¦æˆ·
- **èµ„é‡‘éš”ç¦»**ï¼šæ‰˜ç®¡è´¦æˆ·ä¸å¹³å°èµ„é‡‘å®Œå…¨éš”ç¦»
- **å®‰å…¨æ€§**ï¼šæ‰˜ç®¡è´¦æˆ·ä»…å—æœ¬æ¨¡å—æ§åˆ¶ï¼Œæ— ç§é’¥æ³„éœ²é£é™©

#### 3.2 æ‰˜ç®¡æ“ä½œ

| æ“ä½œ | æè¿° | è°ƒç”¨æ—¶æœº |
|------|------|----------|
| **å­˜å…¥** | ä»ä»˜æ¬¾äººè´¦æˆ·è½¬å…¥æ‰˜ç®¡è´¦æˆ· | ç”¨æˆ·è´­ä¹°/ä¾›å¥‰æ—¶ |
| **æå–** | ä»æ‰˜ç®¡è´¦æˆ·è½¬å‡ºæŒ‡å®šé‡‘é¢ | å³æ—¶åˆ†æˆ/å‘¨ç»“ç®—æ—¶ |
| **æ‰¹é‡æå–** | æ‰¹é‡è½¬è´¦åˆ°å¤šä¸ªè´¦æˆ· | å‘¨ç»“ç®—æ‰¹é‡åˆ†é…æ—¶ |
| **ä½™é¢æŸ¥è¯¢** | æŸ¥è¯¢æ‰˜ç®¡è´¦æˆ·å½“å‰ä½™é¢ | å®¡è®¡/ç›‘æ§æ—¶ |

#### 3.3 ç´¯è®¡ç»Ÿè®¡

- **TotalDeposited**ï¼šç´¯è®¡å­˜å…¥é‡‘é¢ï¼ˆå®¡è®¡ç”¨ï¼‰
- **TotalWithdrawn**ï¼šç´¯è®¡æå–é‡‘é¢ï¼ˆå®¡è®¡ç”¨ï¼‰
- **å®æ—¶ä½™é¢**ï¼šé€šè¿‡ `Currency::free_balance` æŸ¥è¯¢

### 4. å³æ—¶åˆ†æˆï¼ˆinstant.rsï¼‰

å³æ—¶åˆ†æˆåœ¨äº¤æ˜“å‘ç”Ÿæ—¶ç«‹å³åˆ†é…å¥–åŠ±ï¼Œå®ç°å®æ—¶è½¬è´¦ã€ç«‹å³åˆ°è´¦ã€‚

#### 4.1 å®æ—¶è½¬è´¦æœºåˆ¶

```
äº¤æ˜“æµç¨‹ï¼š
1. è·å–æ¨èé“¾ï¼ˆæœ€å¤š15å±‚ï¼‰
2. è·å–å³æ—¶åˆ†æˆæ¯”ä¾‹é…ç½®
3. é€å±‚éªŒè¯æ¨èäººèµ„æ ¼
4. è®¡ç®—åˆ†æˆé‡‘é¢ï¼ˆåŸºäºé…ç½®æ¯”ä¾‹ï¼‰
5. ç«‹å³è½¬è´¦åˆ°æ¨èäººè´¦æˆ·
6. å‘å°„äº‹ä»¶ï¼ˆInstantRewardDistributedï¼‰
7. æ›´æ–°ç´¯è®¡ç»Ÿè®¡
```

#### 4.2 æ¨èäººèµ„æ ¼éªŒè¯

**éªŒè¯è§„åˆ™**ï¼š
- å¿…é¡»æ˜¯æœ‰æ•ˆä¼šå‘˜ï¼ˆé€šè¿‡ `MembershipProvider` éªŒè¯ï¼‰
- å±‚çº§ä¸è¶…è¿‡15å±‚
- è´¦æˆ·çŠ¶æ€æ­£å¸¸ï¼ˆå¯æ¥æ”¶è½¬è´¦ï¼‰

**éªŒè¯å¤±è´¥å¤„ç†**ï¼š
- æ— æ•ˆæ¨èäººï¼šä»½é¢è·³è¿‡è¯¥å±‚ï¼Œç»§ç»­åˆ†é…ä¸‹ä¸€å±‚
- è½¬è´¦å¤±è´¥ï¼šè·³è¿‡è¯¥å±‚ï¼Œç»§ç»­åˆ†é…ä¸‹ä¸€å±‚
- å®¹é”™è®¾è®¡ï¼šå•ä¸ªè´¦æˆ·å¤±è´¥ä¸å½±å“å…¶ä»–è´¦æˆ·

#### 4.3 åˆ†æˆé‡‘é¢è®¡ç®—

**è®¡ç®—å…¬å¼**ï¼š
```rust
åˆ†æˆé‡‘é¢ = å¯åˆ†é…é‡‘é¢ Ã— å±‚çº§æ¯”ä¾‹ / 100
```

**ç¤ºä¾‹**ï¼ˆå‡è®¾å¯åˆ†é…é‡‘é¢1000 COSï¼ŒL1=30%ï¼‰ï¼š
```
L1å¥–åŠ± = 1000 Ã— 30 / 100 = 300 COS
```

#### 4.4 ç´¯è®¡ç»Ÿè®¡

- **TotalInstantDistributed**ï¼šç´¯è®¡å³æ—¶åˆ†é…é‡‘é¢
- **æŒ‰è´¦æˆ·ç»Ÿè®¡**ï¼šé€šè¿‡äº‹ä»¶æ—¥å¿—è¿½æº¯
- **æŒ‰å±‚çº§ç»Ÿè®¡**ï¼šé€šè¿‡äº‹ä»¶æ—¥å¿—è¿½æº¯

### 5. å‘¨ç»“ç®—ï¼ˆweekly.rsï¼‰

å‘¨ç»“ç®—æŒ‰å‘¨æœŸæ‰¹é‡ç»“ç®—è´¦æˆ·ï¼Œè®°è´¦åˆ†é…ã€å®šæœŸç»“ç®—ã€‚

#### 5.1 è®°è´¦åˆ†é…æœºåˆ¶

**æ¶ˆè´¹ä¸ŠæŠ¥æµç¨‹**ï¼š
```
1. è®¡ç®—å½“å‰å‘¨ç¼–å·ï¼ˆblock_number / blocks_per_weekï¼‰
2. è·å–æ¨èé“¾ï¼ˆæœ€å¤š15å±‚ï¼‰
3. è·å–å‘¨ç»“ç®—åˆ†æˆæ¯”ä¾‹é…ç½®
4. é€å±‚ç´¯è®¡åº”å¾—é‡‘é¢åˆ° Entitlement å­˜å‚¨
5. æ›´æ–°æ´»è·ƒæœŸï¼ˆå¦‚æœ‰æ—¶é•¿ï¼‰
6. æ›´æ–°ç›´æ¨æ´»è·ƒæ•°
```

#### 5.2 æ´»è·ƒæœŸç®¡ç†

**æ´»è·ƒæœŸæ¦‚å¿µ**ï¼š
- è´¦æˆ·çš„æ´»è·ƒæˆªæ­¢å‘¨ï¼ˆActiveUntilWeekï¼‰
- ä»…æ´»è·ƒè´¦æˆ·å¯è·å¾—å‘¨ç»“ç®—å¥–åŠ±
- ä¾›å¥‰å»¶é•¿æ´»è·ƒæœŸï¼ˆæŒ‰ä¾›å¥‰æ—¶é•¿ï¼‰

**ç›´æ¨æ´»è·ƒæ•°ç®¡ç†**ï¼š
- ç»Ÿè®¡æ¯ä¸ªè´¦æˆ·çš„æ´»è·ƒç›´æ¨æ•°é‡ï¼ˆDirectActiveCountï¼‰
- æ–°æ¿€æ´»ç›´æ¨æ—¶ï¼Œå¢åŠ æ¨èäººçš„ç›´æ¨è®¡æ•°
- ç”¨äºæœªæ¥åŠ¨æ€å±‚æ•°è°ƒæ•´ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰

#### 5.3 å‘¨æœŸç»“ç®—

**ç»“ç®—æµç¨‹**ï¼š
```
1. è·å–å½“å‰ç»“ç®—æ¸¸æ ‡ï¼ˆæ”¯æŒåˆ†æ‰¹ç»“ç®—ï¼‰
2. è¿­ä»£ Entitlement å­˜å‚¨ï¼Œè·å–å¾…ç»“ç®—è´¦æˆ·
3. æ‰¹é‡è½¬è´¦ï¼ˆdo_batch_withdrawï¼‰
4. æ¸…ç†å·²ç»“ç®—è´¦æˆ·çš„ Entitlement
5. æ›´æ–°ç´¯è®¡ç»Ÿè®¡ï¼ˆTotalWeeklyDistributedï¼‰
6. æ›´æ–°ç»“ç®—æ¸¸æ ‡
7. å‘å°„äº‹ä»¶ï¼ˆCycleSettledï¼‰
```

**åˆ†æ‰¹ç»“ç®—æœºåˆ¶**ï¼š
- **max_accounts**ï¼šæ¯æ¬¡æœ€å¤šç»“ç®—çš„è´¦æˆ·æ•°ï¼ˆé˜²åŒºå—è¶…è½½ï¼‰
- **æ¸¸æ ‡æœºåˆ¶**ï¼šè®°å½•å½“å‰ç»“ç®—è¿›åº¦ï¼ˆSettleCursorï¼‰
- **ç»§ç»­ç»“ç®—**ï¼šæœªå®Œæˆæ—¶æ›´æ–°æ¸¸æ ‡ï¼Œä¸‹æ¬¡ç»§ç»­
- **ç»“ç®—å®Œæˆ**ï¼šå…¨éƒ¨å®Œæˆåæ¸…ç©ºæ¸¸æ ‡

#### 5.4 ç´¯è®¡ç»Ÿè®¡

- **TotalWeeklyDistributed**ï¼šç´¯è®¡å‘¨ç»“ç®—åˆ†é…é‡‘é¢
- **æŒ‰å‘¨æœŸç»Ÿè®¡**ï¼šé€šè¿‡äº‹ä»¶æ—¥å¿—è¿½æº¯
- **æŒ‰è´¦æˆ·ç»Ÿè®¡**ï¼šé€šè¿‡ Entitlement å­˜å‚¨æŸ¥è¯¢

### 6. ç»Ÿä¸€åˆ†é…å…¥å£ï¼ˆdistribute.rsï¼‰

ç»Ÿä¸€åˆ†é…å…¥å£æä¾›è‡ªåŠ¨è·¯ç”±åŠŸèƒ½ï¼Œæ ¹æ®ç»“ç®—æ¨¡å¼è‡ªåŠ¨é€‰æ‹©åˆ†é…æ–¹å¼ã€‚

#### 6.1 ç³»ç»Ÿè´¹ç”¨æ‰£é™¤

**æ‰£è´¹è§„åˆ™**ï¼ˆé€šç”¨åˆ†é…åœºæ™¯ï¼‰ï¼š
- **é”€æ¯**ï¼š5%ï¼ˆå‘é€åˆ° BurnAccountï¼‰
- **å›½åº“**ï¼š2%ï¼ˆå‘é€åˆ° TreasuryAccountï¼‰
- **å­˜å‚¨**ï¼š3%ï¼ˆå‘é€åˆ°ç”¨æˆ·çš„ UserFunding è´¦æˆ·ï¼ŒğŸ†• 2025-12-30 æ›´æ–°ï¼‰
- **å¯åˆ†é…**ï¼š90%ï¼ˆè¿›å…¥è”ç›Ÿå¥–åŠ±æ± ï¼‰

**ç¤ºä¾‹**ï¼ˆå‡è®¾æ€»é‡‘é¢1000 COSï¼‰ï¼š
```
é”€æ¯ï¼š1000 Ã— 5% = 50 COS
å›½åº“ï¼š1000 Ã— 2% = 20 COS
å­˜å‚¨ï¼š1000 Ã— 3% = 30 COSï¼ˆå……å€¼åˆ°ç”¨æˆ·å­˜å‚¨èµ„é‡‘è´¦æˆ·ï¼‰
å¯åˆ†é…ï¼š1000 - 50 - 20 - 30 = 900 COS
```

> **ğŸ†• 2025-12-30 å˜æ›´**ï¼šå­˜å‚¨è´¹ç”¨ä¸å†å‘é€åˆ°å…¨å±€ StorageAccountï¼Œè€Œæ˜¯é€šè¿‡ `UserFundingProvider` trait å……å€¼åˆ°ç”¨æˆ·çš„ UserFunding æ´¾ç”Ÿè´¦æˆ·ã€‚

#### 6.2 ä¼šå‘˜ä¸“ç”¨åˆ†é…

**ç‰¹æ®Šè§„åˆ™**ï¼š
- ä¼šå‘˜è´¹é‡‘é¢100%åˆ†é…åˆ°æ¨èé“¾ï¼Œæ— ç³»ç»Ÿæ‰£è´¹
- ä½¿ç”¨å³æ—¶åˆ†æˆæ¨¡å¼ï¼ˆå¿«é€Ÿåˆ°è´¦ï¼‰
- æ¿€åŠ±æ¨èè¡Œä¸ºï¼Œä¿ƒè¿›ä¼šå‘˜å¢é•¿

**è°ƒç”¨æ¥å£**ï¼š
```rust
do_distribute_membership_rewards(buyer, amount)
```

#### 6.3 æ¨¡å¼è‡ªåŠ¨è·¯ç”±

| æ¨¡å¼ | è·¯ç”±ç­–ç•¥ | è¿”å›å€¼ |
|------|----------|--------|
| **Weekly** | è°ƒç”¨ `do_report_consumption`ï¼ˆ15å±‚ï¼‰ | 0ï¼ˆå‘¨ç»“ç®—æ—¶ç«‹å³è¿”å›0ï¼‰ |
| **Instant** | è°ƒç”¨ `do_instant_distribute`ï¼ˆ15å±‚ï¼‰ | å®é™…åˆ†é…æ€»é¢ |
| **Hybrid** | å…ˆå³æ—¶åˆ†æˆï¼ˆå‰Nå±‚ï¼‰ï¼Œå†å‘¨ç»“ç®—ï¼ˆåMå±‚ï¼‰ | å³æ—¶åˆ†é…æ€»é¢ |

#### 6.4 å®¹é”™å¤„ç†

- **ä½™é¢ä¸è¶³**ï¼šè‡ªåŠ¨è·³è¿‡è¯¥å±‚ï¼Œç»§ç»­ä¸‹ä¸€å±‚
- **é“¾æ¡ä¸­æ–­**ï¼šå•ä¸ªè´¦æˆ·å¤±è´¥ä¸å½±å“å…¶ä»–è´¦æˆ·
- **è½¬è´¦å¤±è´¥**ï¼šè®°å½•å¤±è´¥åŸå› ï¼ˆé€šè¿‡æ—¥å¿—ï¼‰ï¼Œç»§ç»­åˆ†é…
- **åŸå­æ“ä½œ**ï¼šåˆ†é…è¿‡ç¨‹ä½¿ç”¨äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š

## 15å±‚å‹ç¼©ç®—æ³•è¯¦è§£

### ç®—æ³•ç›®æ ‡

ä»æ¨èé“¾ä¸­æ‰¾åˆ°æœ€å¤š15å±‚åˆæ ¼çš„æ¨èäººï¼Œæ ¹æ®é…ç½®çš„åˆ†æˆæ¯”ä¾‹åˆ†é…å¥–åŠ±ã€‚

## ğŸ†• æ²»ç†ç³»ç»Ÿï¼ˆgovernance.rsï¼‰

æœ¬æ¨¡å—å®ç°å…¨æ°‘æŠ•ç¥¨æœºåˆ¶ä¿®æ”¹å…³é”®å‚æ•°ï¼ŒåŒ…æ‹¬ï¼š
- **å³æ—¶åˆ†æˆæ¯”ä¾‹**ï¼ˆInstantLevelPercentsï¼‰ï¼š15å±‚è”ç›Ÿåˆ†æˆæ¯”ä¾‹
- **å¹´è´¹ç­‰çº§ä»·æ ¼**ï¼ˆMembershipPricesï¼‰ï¼š4ä¸ªç­‰çº§çš„USDTä»·æ ¼

### æ ¸å¿ƒç‰¹æ€§

- **ææ¡ˆåˆ›å»º**ï¼šæŒå¸å¤§æˆ·ã€ç¤¾åŒºè”ç½²å¯å‘èµ·ææ¡ˆ
- **æŠ•ç¥¨æœºåˆ¶**ï¼šåŠ æƒæŠ•ç¥¨ï¼ˆæŒå¸70% + å‚ä¸20% + è´¡çŒ®10%ï¼‰+ ä¿¡å¿µæŠ•ç¥¨
- **è‡ªåŠ¨æ‰§è¡Œ**ï¼šé€šè¿‡åè‡ªåŠ¨ç”Ÿæ•ˆï¼Œæ— éœ€äººå·¥å¹²é¢„
- **ç´§æ€¥æœºåˆ¶**ï¼šæŠ€æœ¯å§”å‘˜ä¼šå¯ç´§æ€¥æš‚åœæ²»ç†ï¼ˆä½†æ— æ³•å¦å†³ææ¡ˆï¼‰
- **ğŸ”¥ æŠ€æœ¯å§”å‘˜ä¼šæ— å¦å†³æƒ**ï¼šæ‰€æœ‰ææ¡ˆéƒ½å¿…é¡»é€šè¿‡å…¨æ°‘æŠ•ç¥¨

### 7.1 åˆ†æˆæ¯”ä¾‹æ²»ç†

#### å‘èµ·åˆ†æˆæ¯”ä¾‹è°ƒæ•´ææ¡ˆ - `propose_percentage_adjustment` (call_index 50)

**å‚æ•°**ï¼š
- `new_percentages: Vec<u8>` - æ–°çš„15å±‚åˆ†æˆæ¯”ä¾‹
- `title_cid: BoundedVec<u8, 64>` - ææ¡ˆæ ‡é¢˜ï¼ˆIPFS CIDï¼‰
- `description_cid: BoundedVec<u8, 64>` - ææ¡ˆè¯¦æƒ…ï¼ˆIPFS CIDï¼‰
- `rationale_cid: BoundedVec<u8, 64>` - ææ¡ˆç†ç”±ï¼ˆIPFS CIDï¼‰

**éªŒè¯è§„åˆ™**ï¼š
- å‰2å±‚ï¼ˆç¬¬1ã€2å±‚ï¼‰ä¸èƒ½ä¸º0ï¼Œç¡®ä¿åŸºç¡€æ¿€åŠ±
- ç¬¬3å±‚å¯ä»¥ä¸º0ï¼Œå…è®¸ç¤¾åŒºé€šè¿‡æŠ•ç¥¨è°ƒæ•´ï¼ˆğŸ”¥ 2025-11-13 æ›´æ–°ï¼‰
- ç¬¬4-15å±‚å¯ä»¥ä¸º0ï¼Œæä¾›çµæ´»æ€§
- æ€»å’Œå¿…é¡»åœ¨50-99%èŒƒå›´å†…
- å‰5å±‚å¿…é¡»é€’å‡ï¼ˆåŒ…æ‹¬0å€¼ï¼‰
- L1æ¯”ä¾‹ä¸è¶…è¿‡50%ï¼ˆé˜²æ­¢å¯¡å¤´å„æ–­ï¼‰

**æŠ¼é‡‘æœºåˆ¶**ï¼š
- å¾®è°ƒææ¡ˆï¼š1,000 COS
- é‡å¤§ææ¡ˆï¼ˆ>10%å˜åŒ–ï¼‰ï¼š10,000 COS

#### å¯¹åˆ†æˆæ¯”ä¾‹ææ¡ˆæŠ•ç¥¨ - `vote_on_percentage_proposal` (call_index 51)

**å‚æ•°**ï¼š
- `proposal_id: u64` - ææ¡ˆID
- `vote_type: u8` - æŠ•ç¥¨é€‰é¡¹ï¼ˆ0=Aye, 1=Nay, 2=Abstainï¼‰
- `conviction_type: u8` - ä¿¡å¿µæŠ•ç¥¨ï¼ˆ0=None, 1-6=Locked1x-6xï¼‰

**ä¿¡å¿µæŠ•ç¥¨é”å®š**ï¼š

| ä¿¡å¿µç­‰çº§ | æƒé‡å€æ•° | é”å®šå‘¨æ•° |
|---------|---------|---------|
| None | 1x | 0 |
| Locked1x | 1.5x | 1 |
| Locked2x | 2x | 2 |
| Locked3x | 3x | 4 |
| Locked4x | 4x | 8 |
| Locked5x | 5x | 16 |
| Locked6x | 6x | 32 |

#### å–æ¶ˆææ¡ˆ - `cancel_proposal` (call_index 52)

ä»…ææ¡ˆå‘èµ·äººå¯åœ¨è®¨è®ºæœŸå–æ¶ˆï¼ŒæŠ•ç¥¨å¼€å§‹åä¸å¯å–æ¶ˆã€‚

### 7.2 å¹´è´¹ä»·æ ¼æ²»ç†ï¼ˆğŸ†•ï¼‰

#### å‘èµ·å¹´è´¹ä»·æ ¼è°ƒæ•´ææ¡ˆ - `propose_membership_price_adjustment` (call_index 70)

**å‚æ•°**ï¼š
- `new_prices_usdt: [u64; 4]` - æ–°çš„å¹´è´¹ä»·æ ¼ï¼ˆUSDTï¼Œç²¾åº¦ 10^6ï¼‰
  - æŒ‰é¡ºåºï¼š[Year1, Year3, Year5, Year10]
- `title_cid: BoundedVec<u8, 64>` - ææ¡ˆæ ‡é¢˜ï¼ˆIPFS CIDï¼‰
- `description_cid: BoundedVec<u8, 64>` - ææ¡ˆè¯¦æƒ…ï¼ˆIPFS CIDï¼‰
- `rationale_cid: BoundedVec<u8, 64>` - ææ¡ˆç†ç”±ï¼ˆIPFS CIDï¼‰

**éªŒè¯è§„åˆ™**ï¼š
- ä»·æ ¼èŒƒå›´ï¼š10-1000 USDT
- ä»·æ ¼å¿…é¡»é€’å¢ï¼šYear1 â‰¤ Year3 â‰¤ Year5 â‰¤ Year10
- ç›¸é‚»ä»·æ ¼å·®è·ä¸è¶…è¿‡10å€

**é»˜è®¤ä»·æ ¼**ï¼š
```rust
[50_000_000, 100_000_000, 200_000_000, 300_000_000]
// å³ [50, 100, 200, 300] USDT
```

#### å¯¹å¹´è´¹ä»·æ ¼ææ¡ˆæŠ•ç¥¨ - `vote_on_membership_price_proposal` (call_index 71)

**å‚æ•°**ï¼š
- `proposal_id: u64` - ææ¡ˆID
- `vote_type: u8` - æŠ•ç¥¨é€‰é¡¹ï¼ˆ0=Aye, 1=Nay, 2=Abstainï¼‰
- `conviction_type: u8` - ä¿¡å¿µæŠ•ç¥¨ï¼ˆ0-6ï¼‰

#### å–æ¶ˆå¹´è´¹ä»·æ ¼ææ¡ˆ - `cancel_membership_price_proposal` (call_index 72)

ä»…ææ¡ˆå‘èµ·äººå¯åœ¨è®¨è®ºæœŸå–æ¶ˆã€‚

### 7.3 ç´§æ€¥æ²»ç†æ§åˆ¶

#### ç´§æ€¥æš‚åœæ²»ç† - `emergency_pause_governance` (call_index 60)

**æƒé™**ï¼šAdminOriginï¼ˆæŠ€æœ¯å§”å‘˜ä¼šè¶…çº§å¤šæ•° 5/7ï¼‰

**å‚æ•°**ï¼š
- `reason_cid: BoundedVec<u8, 64>` - æš‚åœåŸå› ï¼ˆIPFS CIDï¼‰

#### æ¢å¤æ²»ç† - `resume_governance` (call_index 61)

**æƒé™**ï¼šAdminOriginï¼ˆRoot æˆ–å§”å‘˜ä¼šï¼‰

### 7.4 æŠ•ç¥¨æƒé‡è®¡ç®—

**æ€»æŠ•ç¥¨æƒé‡ = æŒå¸æƒé‡(70%) + å‚ä¸æƒé‡(20%) + è´¡çŒ®æƒé‡(10%)**

**æŒå¸æƒé‡**ï¼ˆå¹³æ–¹æ ¹ï¼Œé¿å…å·¨é²¸å„æ–­ï¼‰ï¼š
```rust
stake_weight = sqrt(balance).min(1000)  // ä¸Šé™ç›¸å½“äº100ä¸‡COS
```

**å‚ä¸æƒé‡**ï¼ˆå†å²æŠ•ç¥¨æ¬¡æ•°ï¼‰ï¼š
| æŠ•ç¥¨æ¬¡æ•° | æƒé‡ |
|---------|------|
| 0-2 | 10ï¼ˆæ–°æ‰‹ï¼‰ |
| 3-5 | 25ï¼ˆæ´»è·ƒï¼‰ |
| 6-10 | 50ï¼ˆèµ„æ·±ï¼‰ |
| 11+ | 100ï¼ˆå…ƒè€ï¼‰ |

**è´¡çŒ®æƒé‡**ï¼ˆæ¨èè´¡çŒ®ï¼‰ï¼š
- æ¯ä¸ªæˆåŠŸæ¨è +2 åˆ†ï¼Œæœ€å¤š50äºº = 100åˆ†
- ä¸Šé™ï¼š300åˆ†

### 7.5 é€šè¿‡æ¡ä»¶

**å…¨æ°‘æŠ•ç¥¨æœºåˆ¶**ï¼š
- æœ€ä½å‚ä¸ç‡ï¼š15%
- è‡ªé€‚åº”æ”¯æŒç‡é˜ˆå€¼ï¼š
  - 50%å‚ä¸ â†’ 50%æ”¯æŒ
  - 30%å‚ä¸ â†’ 55%æ”¯æŒ
  - 15%å‚ä¸ â†’ 60%æ”¯æŒ

**å¹´è´¹ä»·æ ¼å¾®è°ƒææ¡ˆ**ï¼šåœ¨åŸåŸºç¡€ä¸Šé™ä½5%é—¨æ§›

## ğŸ†• å­˜å‚¨è†¨èƒ€é˜²æŠ¤

### é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|-----|------|-------|
| `MaxActiveProposals` | æœ€å¤§æ´»è·ƒææ¡ˆæ•° | 10 |
| `MaxReadyProposals` | æœ€å¤§å¾…æ‰§è¡Œææ¡ˆæ•° | 5 |
| `HistoryRetentionWeeks` | å†å²è®°å½•ä¿ç•™å‘¨æ•° | 52 |
| `ProposalExpiry` | ææ¡ˆè¿‡æœŸåŒºå—æ•° | 604800ï¼ˆçº¦30å¤©ï¼‰ |

### è‡ªåŠ¨æ¸…ç†æœºåˆ¶

**on_idle Hook**ï¼š
- æ¸…ç†è¿‡æœŸææ¡ˆï¼ˆæ¯æ¬¡æœ€å¤š5ä¸ªï¼‰
- æ¸…ç†æ—§å‘¨æ”¶å…¥æ•°æ®ï¼ˆæ¯æ¬¡æœ€å¤š3ä¸ªå‘¨æœŸï¼‰

```rust
fn on_idle(now: BlockNumberFor<T>, remaining_weight: Weight) -> Weight {
    // æ¸…ç†è¿‡æœŸææ¡ˆ
    Self::cleanup_expired_proposals(now, 5);
    // æ¸…ç†æ—§å‘¨æ”¶å…¥æ•°æ®
    Self::cleanup_old_weekly_data(now, 3);
}
```

## 15å±‚å‹ç¼©ç®—æ³•è¯¦è§£

### ç®—æ³•ç›®æ ‡

ä»æ¨èé“¾ä¸­æ‰¾åˆ°æœ€å¤š15å±‚åˆæ ¼çš„æ¨èäººï¼Œæ ¹æ®é…ç½®çš„åˆ†æˆæ¯”ä¾‹åˆ†é…å¥–åŠ±ã€‚

### ç®—æ³•æµç¨‹

```
è¾“å…¥ï¼šbuyerï¼ˆè´­ä¹°è€…ï¼‰ã€distributable_amountï¼ˆå¯åˆ†é…é‡‘é¢ï¼‰ã€levelsï¼ˆåˆ†é…å±‚æ•°ï¼‰

1. è·å–æ¨èé“¾ï¼šget_referral_chain(buyer) â†’ [sponsor1, sponsor2, ..., sponsorN]
2. è·å–åˆ†æˆæ¯”ä¾‹ï¼šInstantLevelPercents æˆ– WeeklyLevelPercents
3. éå†æ¨èé“¾ï¼ˆæœ€å¤š15å±‚ï¼‰ï¼š
   for (index, referrer) in referral_chain.iter().take(levels) {
       a. è·å–è¯¥å±‚åˆ†æˆæ¯”ä¾‹ï¼špercent = level_percents[index]
       b. éªŒè¯æ¨èäººèµ„æ ¼ï¼šis_valid_referrer(referrer, level)
       c. è®¡ç®—åˆ†æˆé‡‘é¢ï¼šshare = distributable_amount Ã— percent / 100
       d. è½¬è´¦/è®°è´¦ï¼š
          - å³æ—¶æ¨¡å¼ï¼šCurrency::transfer
          - å‘¨ç»“ç®—ï¼šEntitlement::mutate
       e. å‘å°„äº‹ä»¶
   }
4. è¿”å›å®é™…åˆ†é…æ€»é¢
```

### å‹ç¼©è§„åˆ™ï¼ˆç²¾ç®€ç‰ˆï¼‰

**å½“å‰å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰**ï¼š
- ä»…æ£€æŸ¥ä¼šå‘˜æœ‰æ•ˆæ€§å’Œæ´»è·ƒæœŸ
- ä¸åšå¤æ‚çš„æŒä»“é—¨æ§›éªŒè¯
- ä¸åšåŠ¨æ€å±‚æ•°è°ƒæ•´

**æœªæ¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰**ï¼š
- æŒä»“é—¨æ§›ï¼šæŒ‰æŒä»“é‡å†³å®šå¯æ‹¿ä»£æ•°
- ç›´æ¨è¦æ±‚ï¼šæŒ‰ç›´æ¨æ•°é‡å†³å®šå¯æ‹¿ä»£æ•°
- åŠ¨æ€å±‚æ•°ï¼šæ ¹æ®å›¢é˜Ÿæ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´

### èµ„é‡‘æµå‘

**å³æ—¶åˆ†æˆæ¨¡å¼**ï¼š
```
ç”¨æˆ·æ”¯ä»˜ â†’ æ‰˜ç®¡è´¦æˆ· â†’ 15å±‚æ¨èäººï¼ˆç«‹å³è½¬è´¦ï¼‰
```

**å‘¨ç»“ç®—æ¨¡å¼**ï¼š
```
ç”¨æˆ·æ”¯ä»˜ â†’ æ‰˜ç®¡è´¦æˆ· â†’ Entitlement è®°è´¦ â†’ å‘¨æœ«æ‰¹é‡ç»“ç®— â†’ æ¨èäºº
```

**æ··åˆæ¨¡å¼**ï¼š
```
ç”¨æˆ·æ”¯ä»˜ â†’ æ‰˜ç®¡è´¦æˆ· â†’ {
    å‰Nå±‚ï¼šç«‹å³è½¬è´¦
    åMå±‚ï¼šEntitlement è®°è´¦ â†’ å‘¨æœ«ç»“ç®—
}
```

### ä¸è¶³å±‚æ•°å¤„ç†

**åœºæ™¯**ï¼šæ¨èé“¾ä¸è¶³15å±‚ï¼ˆä¾‹å¦‚åªæœ‰5å±‚ï¼‰

**å¤„ç†æ–¹å¼**ï¼š
- ä»…åˆ†é…å®é™…å­˜åœ¨çš„å±‚æ•°ï¼ˆ5å±‚ï¼‰
- æœªåˆ†é…çš„ä»½é¢ï¼ˆL6-L15ï¼‰ä¿ç•™åœ¨æ‰˜ç®¡è´¦æˆ·
- ç®¡ç†å‘˜å¯é…ç½®ï¼šå¹¶å…¥å›½åº“/é”€æ¯/å…¶ä»–ç”¨é€”

## ä¸‰ç§ç»“ç®—æ¨¡å¼å¯¹æ¯”

### å¯¹æ¯”è¡¨æ ¼

| å¯¹æ¯”ç»´åº¦ | Weekly | Instant | Hybrid |
|----------|--------|---------|--------|
| **åˆ°è´¦æ—¶é—´** | å‘¨æœ«ç»“ç®— | ç«‹å³åˆ°è´¦ | éƒ¨åˆ†ç«‹å³ï¼Œéƒ¨åˆ†å‘¨æœ« |
| **Gasæˆæœ¬** | ä½ï¼ˆæ‰¹é‡ç»“ç®—ï¼‰ | é«˜ï¼ˆé€ç¬”è½¬è´¦ï¼‰ | ä¸­ç­‰ |
| **ç”¨æˆ·ä½“éªŒ** | å»¶è¿Ÿé«˜ | å®æ—¶åé¦ˆ | å¹³è¡¡ |
| **ç³»ç»Ÿè´Ÿè½½** | å³°å€¼é«˜ï¼ˆå‘¨æœ«ï¼‰ | å‡åŒ€åˆ†å¸ƒ | å‡åŒ€åˆ†å¸ƒ |
| **é€‚ç”¨åœºæ™¯** | å¤§é¢äº¤æ˜“ | å°é¢äº¤æ˜“ | é€šç”¨ |
| **å¤æ‚åº¦** | é«˜ï¼ˆæ¸¸æ ‡/åˆ†æ‰¹ï¼‰ | ä½ | ä¸­ç­‰ |

### æ¨¡å¼åˆ‡æ¢

**åˆ‡æ¢æ–¹å¼**ï¼š
```rust
// åˆ‡æ¢åˆ°å³æ—¶åˆ†æˆæ¨¡å¼
set_settlement_mode(1, 0, 0)

// åˆ‡æ¢åˆ°å‘¨ç»“ç®—æ¨¡å¼
set_settlement_mode(0, 0, 0)

// åˆ‡æ¢åˆ°æ··åˆæ¨¡å¼ï¼ˆå‰5å±‚å³æ—¶ï¼Œå10å±‚å‘¨ç»“ç®—ï¼‰
set_settlement_mode(2, 5, 10)
```

**æ³¨æ„äº‹é¡¹**ï¼š
- æ¨¡å¼åˆ‡æ¢ç«‹å³ç”Ÿæ•ˆ
- å·²è®°è´¦çš„å‘¨ç»“ç®—ä¸å—å½±å“ï¼Œä»ç„¶æŒ‰åŸè®¡åˆ’ç»“ç®—
- å»ºè®®åœ¨ä½å³°æœŸåˆ‡æ¢æ¨¡å¼

### æœ€ä½³å®è·µ

**æ¨èé…ç½®**ï¼š
- **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨ Instant æ¨¡å¼ï¼Œå¿«é€ŸéªŒè¯åŠŸèƒ½
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ Hybrid æ¨¡å¼ï¼ˆå‰5å±‚å³æ—¶ï¼Œå10å±‚å‘¨ç»“ç®—ï¼‰
- **ç‰¹æ®Šæ´»åŠ¨**ï¼šä¸´æ—¶åˆ‡æ¢åˆ° Instant æ¨¡å¼ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

## æ•°æ®ç»“æ„

### æ ¸å¿ƒç±»å‹å®šä¹‰

```rust
/// ç»“ç®—æ¨¡å¼æšä¸¾
pub enum SettlementMode {
    Weekly,
    Instant,
    Hybrid {
        instant_levels: u8,
        weekly_levels: u8,
    },
}

/// åˆ†æˆæ¯”ä¾‹é…ç½®ï¼ˆ15å±‚ï¼‰
pub type LevelPercents = BoundedVec<u8, ConstU32<15>>;

/// æ¨èé“¾æœ€å¤§å±‚æ•°
pub const MAX_REFERRAL_CHAIN: u32 = 15;

/// æ¨èç é•¿åº¦èŒƒå›´
pub const MIN_CODE_LEN: u32 = 4;
pub const MAX_CODE_LEN: u32 = 16;
```

### å­˜å‚¨é¡¹

#### æ¨èå…³ç³»å­˜å‚¨ï¼ˆğŸ†• å·²è¿ç§»åˆ° pallet-affiliate-referralï¼‰

| å­˜å‚¨é¡¹ | é”®ç±»å‹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|--------|------|
| `Sponsors` | AccountId | AccountId | è´¦æˆ·çš„æ¨èäººï¼ˆå·²è¿ç§»ï¼‰ |
| `AccountByCode` | BoundedVec<u8> | AccountId | æ¨èç â†’è´¦æˆ·ï¼ˆå·²è¿ç§»ï¼‰ |
| `CodeByAccount` | AccountId | BoundedVec<u8> | è´¦æˆ·â†’æ¨èç ï¼ˆå·²è¿ç§»ï¼‰ |

> **æ³¨æ„**ï¼šä»¥ä¸Šå­˜å‚¨é¡¹å·²è¿ç§»åˆ° `pallet-affiliate-referral`ï¼Œæœ¬æ¨¡å—é€šè¿‡ trait è®¿é—®ã€‚

#### é…ç½®å­˜å‚¨ï¼ˆ4ä¸ªï¼‰

| å­˜å‚¨é¡¹ | å€¼ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|--------|------|--------|
| `SettlementMode` | SettlementMode | å½“å‰ç»“ç®—æ¨¡å¼ | Weekly |
| `InstantLevelPercents` | LevelPercents | å³æ—¶åˆ†æˆæ¯”ä¾‹ï¼ˆ15å±‚ï¼‰ | [30,25,15,10,7,3,2,2,2,1,1,1,1,1,1] |
| `WeeklyLevelPercents` | LevelPercents | å‘¨ç»“ç®—æ¯”ä¾‹ï¼ˆ15å±‚ï¼‰ | [20,10,4,4,4,4,4,4,4,4,4,4,4,4,4] |
| `BlocksPerWeek` | BlockNumber | æ¯å‘¨åŒºå—æ•° | 100800 |

#### æ‰˜ç®¡å­˜å‚¨ï¼ˆ2ä¸ªï¼‰

| å­˜å‚¨é¡¹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|------|
| `TotalDeposited` | Balance | ç´¯è®¡å­˜å…¥é‡‘é¢ï¼ˆå®¡è®¡ç”¨ï¼‰ |
| `TotalWithdrawn` | Balance | ç´¯è®¡æå–é‡‘é¢ï¼ˆå®¡è®¡ç”¨ï¼‰ |

#### å³æ—¶åˆ†æˆå­˜å‚¨ï¼ˆ1ä¸ªï¼‰

| å­˜å‚¨é¡¹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|------|
| `TotalInstantDistributed` | Balance | ç´¯è®¡å³æ—¶åˆ†é…é‡‘é¢ |

#### å‘¨ç»“ç®—å­˜å‚¨ï¼ˆ7ä¸ªï¼‰

| å­˜å‚¨é¡¹ | é”®ç±»å‹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|--------|------|
| `Entitlement` | (u32, AccountId) | Balance | æ¯å‘¨åº”å¾—é‡‘é¢ |
| `ActiveUntilWeek` | AccountId | u32 | æ´»è·ƒæˆªæ­¢å‘¨ |
| `DirectActiveCount` | AccountId | u32 | ç›´æ¨æ´»è·ƒæ•° |
| `SettleCursor` | u32 | u32 | ç»“ç®—æ¸¸æ ‡ï¼ˆè´¦æˆ·ç´¢å¼•ï¼‰ |
| `CurrentSettlingCycle` | - | Option<u32> | å½“å‰ç»“ç®—å‘¨æœŸ |
| `CycleAccounts` | u32 | BoundedVec<AccountId, 1000> | å‘¨æœŸå¾…ç»“ç®—è´¦æˆ·åˆ—è¡¨ |
| `TotalWeeklyDistributed` | - | Balance | ç´¯è®¡å‘¨ç»“ç®—é‡‘é¢ |

#### ğŸ†• åˆ†æˆæ¯”ä¾‹æ²»ç†å­˜å‚¨ï¼ˆ14ä¸ªï¼‰

| å­˜å‚¨é¡¹ | é”®ç±»å‹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|--------|------|
| `NextProposalId` | - | u64 | ä¸‹ä¸€ä¸ªææ¡ˆID |
| `ActiveProposals` | u64 | PercentageAdjustmentProposal | æ´»è·ƒææ¡ˆ |
| `ActiveProposalIds` | - | BoundedVec<u64> | æ´»è·ƒææ¡ˆIDåˆ—è¡¨ï¼ˆæœ‰ç•Œï¼‰ |
| `ProposalDeposits` | u64 | (AccountId, Balance) | ææ¡ˆæŠ¼é‡‘ |
| `ProposalVotes` | (u64, AccountId) | VoteRecord | æŠ•ç¥¨è®°å½• |
| `VoteTally` | u64 | VoteTally | æŠ•ç¥¨ç»Ÿè®¡ |
| `VoteHistory` | AccountId | BoundedVec<u64, 100> | æŠ•ç¥¨å†å² |
| `PercentageHistory` | u64 | PercentageChangeRecord | æ¯”ä¾‹å˜æ›´å†å² |
| `GovernancePaused` | - | bool | æ²»ç†æš‚åœæ ‡è®° |
| `PauseReason` | - | BoundedVec<u8, 64> | æš‚åœåŸå›  |
| `ProposalCooldown` | AccountId | BlockNumber | è´¦æˆ·å†·å´æœŸ |
| `ActiveProposalsByAccount` | AccountId | BoundedVec<u64, 3> | è´¦æˆ·æ´»è·ƒææ¡ˆæ•° |
| `LastProposalBlock` | AccountId | BlockNumber | è´¦æˆ·æœ€åææ¡ˆåŒºå— |
| `ReadyForExecution` | u64 | PercentageAdjustmentProposal | å¾…æ‰§è¡Œææ¡ˆ |
| `ReadyProposalIds` | - | BoundedVec<u64> | å¾…æ‰§è¡Œææ¡ˆIDåˆ—è¡¨ï¼ˆæœ‰ç•Œï¼‰ |

#### ğŸ†• å¹´è´¹ä»·æ ¼æ²»ç†å­˜å‚¨ï¼ˆ8ä¸ªï¼‰

| å­˜å‚¨é¡¹ | é”®ç±»å‹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|--------|------|
| `MembershipPrices` | - | [u64; 4] | å½“å‰ä¼šå‘˜å¹´è´¹ä»·æ ¼ï¼ˆUSDT * 10^6ï¼‰ |
| `ActiveMembershipPriceProposals` | u64 | MembershipPriceProposal | æ´»è·ƒå¹´è´¹ä»·æ ¼ææ¡ˆ |
| `ActiveMembershipPriceProposalIds` | - | BoundedVec<u64> | æ´»è·ƒå¹´è´¹ä»·æ ¼ææ¡ˆIDåˆ—è¡¨ |
| `MembershipPriceProposalDeposits` | u64 | (AccountId, Balance) | å¹´è´¹ä»·æ ¼ææ¡ˆæŠ¼é‡‘ |
| `MembershipPriceVoteTally` | u64 | VoteTally | å¹´è´¹ä»·æ ¼ææ¡ˆæŠ•ç¥¨ç»Ÿè®¡ |
| `MembershipPriceProposalVotes` | (u64, AccountId) | VoteRecord | å¹´è´¹ä»·æ ¼ææ¡ˆæŠ•ç¥¨è®°å½• |
| `ReadyForMembershipPriceExecution` | u64 | MembershipPriceProposal | å¾…æ‰§è¡Œå¹´è´¹ä»·æ ¼ææ¡ˆ |
| `MembershipPriceHistory` | - | BoundedVec<MembershipPriceChangeRecord, 100> | å¹´è´¹ä»·æ ¼å˜æ›´å†å² |

#### ğŸ†• ä¿¡å¿µæŠ•ç¥¨é”å®šå­˜å‚¨ï¼ˆ1ä¸ªï¼‰

| å­˜å‚¨é¡¹ | é”®ç±»å‹ | å€¼ç±»å‹ | è¯´æ˜ |
|--------|--------|--------|------|
| `VoteLocks` | (AccountId, u64) | (Balance, BlockNumber) | æŠ•ç¥¨é”å®šè®°å½•ï¼ˆé”å®šé‡‘é¢, è§£é”åŒºå—ï¼‰ |

## ä¸»è¦è°ƒç”¨æ–¹æ³•

### ç”¨æˆ·æ¥å£

#### `bind_sponsor(sponsor_code)`

ç»‘å®šæ¨èäºº

**å‚æ•°**ï¼š
- `sponsor_code: Vec<u8>` - æ¨èäººçš„æ¨èç 

**æƒé™**ï¼šä»»ä½•ç­¾åè´¦æˆ·

**å‰ç½®æ¡ä»¶**ï¼š
- è‡ªå·±æœªç»‘å®šè¿‡æ¨èäºº
- æ¨èç å­˜åœ¨ä¸”æœ‰æ•ˆ
- æ¨èäººæ˜¯æœ‰æ•ˆä¼šå‘˜
- ä¸å½¢æˆå¾ªç¯å¼•ç”¨

**æ•ˆæœ**ï¼šå»ºç«‹æ°¸ä¹…æ¨èå…³ç³»

**ç¤ºä¾‹**ï¼š
```rust
// Rustè°ƒç”¨
pallet_affiliate::Pallet::<Runtime>::bind_sponsor(
    origin,
    b"ALICE123".to_vec()
)?;

// å‰ç«¯è°ƒç”¨
await api.tx.affiliate
  .bindSponsor("ALICE123")
  .signAndSend(account);
```

#### `claim_code(code)`

è®¤é¢†æ¨èç 

**å‚æ•°**ï¼š
- `code: Vec<u8>` - è‡ªå®šä¹‰æ¨èç ï¼ˆ4-16å­—èŠ‚ï¼‰

**æƒé™**ï¼šä»»ä½•ç­¾åè´¦æˆ·

**å‰ç½®æ¡ä»¶**ï¼š
- æ˜¯æœ‰æ•ˆä¼šå‘˜
- æœªè®¤é¢†è¿‡æ¨èç 
- æ¨èç æœªè¢«å ç”¨

**æ•ˆæœ**ï¼šè·å¾—æ¨èç ï¼Œå¯ç”¨äºæ¨èä»–äºº

**ç¤ºä¾‹**ï¼š
```rust
// Rustè°ƒç”¨
pallet_affiliate::Pallet::<Runtime>::claim_code(
    origin,
    b"BOB456".to_vec()
)?;

// å‰ç«¯è°ƒç”¨
await api.tx.affiliate
  .claimCode("BOB456")
  .signAndSend(account);
```

### ç®¡ç†å‘˜æ¥å£ï¼ˆAdminOriginï¼‰

#### `set_settlement_mode(mode_id, instant_levels, weekly_levels)`

è®¾ç½®ç»“ç®—æ¨¡å¼

**å‚æ•°**ï¼š
- `mode_id: u8` - æ¨¡å¼IDï¼ˆ0=Weekly, 1=Instant, 2=Hybridï¼‰
- `instant_levels: u8` - å³æ—¶å±‚æ•°ï¼ˆHybridæ¨¡å¼ï¼‰
- `weekly_levels: u8` - å‘¨ç»“ç®—å±‚æ•°ï¼ˆHybridæ¨¡å¼ï¼‰

**æƒé™**ï¼šAdminOrigin

**æ ¡éªŒ**ï¼š
- Hybridæ¨¡å¼ä¸‹ï¼šinstant_levels + weekly_levels â‰¤ 15

**ç¤ºä¾‹**ï¼š
```rust
// è®¾ç½®ä¸ºæ··åˆæ¨¡å¼ï¼šå‰5å±‚å³æ—¶ï¼Œå10å±‚å‘¨ç»“ç®—
pallet_affiliate::Pallet::<Runtime>::set_settlement_mode(
    admin_origin,
    2, // Hybrid
    5, // instant_levels
    10 // weekly_levels
)?;

// å‰ç«¯è°ƒç”¨
await api.tx.affiliate
  .setSettlementMode(2, 5, 10)
  .signAndSend(adminAccount);
```

#### `set_instant_percents(percents)`

è®¾ç½®å³æ—¶åˆ†æˆæ¯”ä¾‹

**å‚æ•°**ï¼š
- `percents: Vec<u8>` - 15å±‚åˆ†æˆæ¯”ä¾‹æ•°ç»„ï¼ˆæ¯é¡¹0-100ï¼‰

**æƒé™**ï¼šAdminOrigin

**æ ¡éªŒ**ï¼šæ•°ç»„é•¿åº¦å¿…é¡»ä¸º15

**ç¤ºä¾‹**ï¼š
```rust
// è®¾ç½®ä¸ºé€å±‚é€’å‡
pallet_affiliate::Pallet::<Runtime>::set_instant_percents(
    admin_origin,
    vec![10, 8, 6, 5, 4, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1]
)?;

// å‰ç«¯è°ƒç”¨
const percents = [10, 8, 6, 5, 4, 3, 2, 2, 1, 1, 1, 1, 1, 1, 1];
await api.tx.affiliate
  .setInstantPercents(percents)
  .signAndSend(adminAccount);
```

#### `set_weekly_percents(percents)`

è®¾ç½®å‘¨ç»“ç®—åˆ†æˆæ¯”ä¾‹

**å‚æ•°**ï¼š
- `percents: Vec<u8>` - 15å±‚åˆ†æˆæ¯”ä¾‹æ•°ç»„ï¼ˆæ¯é¡¹0-100ï¼‰

**æƒé™**ï¼šAdminOrigin

**æ ¡éªŒ**ï¼šæ•°ç»„é•¿åº¦å¿…é¡»ä¸º15

**ç¤ºä¾‹**ï¼š
```rust
// è®¾ç½®ä¸ºL1-L2é«˜ï¼ŒL3-L15å¹³å‡
pallet_affiliate::Pallet::<Runtime>::set_weekly_percents(
    admin_origin,
    vec![8, 6, 5, 4, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1]
)?;

// å‰ç«¯è°ƒç”¨
const percents = [8, 6, 5, 4, 3, 3, 2, 2, 2, 1, 1, 1, 1, 1, 1];
await api.tx.affiliate
  .setWeeklyPercents(percents)
  .signAndSend(adminAccount);
```

#### `set_blocks_per_week(blocks)`

è®¾ç½®æ¯å‘¨åŒºå—æ•°

**å‚æ•°**ï¼š
- `blocks: BlockNumber` - æ¯å‘¨åŒºå—æ•°

**æƒé™**ï¼šAdminOrigin

**é»˜è®¤å€¼**ï¼š100800ï¼ˆ6ç§’å‡ºå—ï¼Œ1å‘¨â‰ˆ100800å—ï¼‰

**ç¤ºä¾‹**ï¼š
```rust
// æµ‹è¯•ç½‘ï¼ˆ1åˆ†é’Ÿå‡ºå—ï¼‰
pallet_affiliate::Pallet::<Runtime>::set_blocks_per_week(
    admin_origin,
    10080u32.into()
)?;

// å‰ç«¯è°ƒç”¨
await api.tx.affiliate
  .setBlocksPerWeek(10080)
  .signAndSend(adminAccount);
```

### å‘¨ç»“ç®—æ¥å£

#### `settle_cycle(cycle, max_accounts)`

ç»“ç®—æŒ‡å®šå‘¨æœŸ

**å‚æ•°**ï¼š
- `cycle: u32` - å‘¨æœŸç¼–å·ï¼ˆä»0å¼€å§‹ï¼‰
- `max_accounts: u32` - æœ€å¤šç»“ç®—è´¦æˆ·æ•°ï¼ˆé˜²åŒºå—è¶…è½½ï¼‰

**æƒé™**ï¼šä»»ä½•ç­¾åè´¦æˆ·ï¼ˆé¼“åŠ±ç¤¾åŒºå‚ä¸ï¼‰

**é€»è¾‘**ï¼š
- æŒ‰æ¸¸æ ‡ç»§ç»­ä¸Šæ¬¡æœªå®Œæˆçš„ç»“ç®—
- æœ€å¤šå¤„ç†max_accountsä¸ªè´¦æˆ·
- æœªå®Œæˆåˆ™æ›´æ–°æ¸¸æ ‡ï¼Œä¸‹æ¬¡ç»§ç»­
- å…¨éƒ¨å®Œæˆåˆ™æ¸…ç©ºæ¸¸æ ‡

**ç¤ºä¾‹**ï¼š
```rust
// ç»“ç®—ç¬¬5å‘¨ï¼Œæ¯æ¬¡æœ€å¤š100ä¸ªè´¦æˆ·
pallet_affiliate::Pallet::<Runtime>::settle_cycle(
    origin,
    5,
    100
)?;

// å‰ç«¯è°ƒç”¨
await api.tx.affiliate
  .settleCycle(5, 100)
  .signAndSend(account);
```

### å†…éƒ¨æ–¹æ³•ï¼ˆä¾›å…¶ä»–palletè°ƒç”¨ï¼‰

#### `bind_sponsor_internal(who, sponsor)`

ç»‘å®šæ¨èäººï¼ˆå†…éƒ¨æ–¹æ³•ï¼‰

**å‚æ•°**ï¼š
- `who: &AccountId` - è¢«æ¨èäºº
- `sponsor: &AccountId` - æ¨èäºº

**ç‰¹ç‚¹**ï¼š
- ä¸éªŒè¯ï¼Œä¸å‘å°„äº‹ä»¶
- ä»…ç”¨äºå…¶ä»–palletå†…éƒ¨ç»‘å®šæ¨èå…³ç³»
- ä¾›ç³»ç»Ÿçº§æ“ä½œä½¿ç”¨ï¼ˆå¦‚ï¼šåˆå§‹åŒ–è´¦æˆ·ï¼‰

## äº‹ä»¶å®šä¹‰

### æ¨èå…³ç³»äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `SponsorBound` | who, sponsor | æ¨èäººå·²ç»‘å®š |
| `CodeClaimed` | who, code | æ¨èç å·²è®¤é¢† |

### é…ç½®ç®¡ç†äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `SettlementModeSet` | - | ç»“ç®—æ¨¡å¼å·²æ›´æ–° |
| `InstantPercentsSet` | - | å³æ—¶åˆ†æˆæ¯”ä¾‹å·²æ›´æ–° |
| `WeeklyPercentsSet` | - | å‘¨ç»“ç®—æ¯”ä¾‹å·²æ›´æ–° |
| `BlocksPerWeekSet` | blocks | æ¯å‘¨åŒºå—æ•°å·²æ›´æ–° |

### æ‰˜ç®¡äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `Deposited` | from, amount | èµ„é‡‘å·²å­˜å…¥æ‰˜ç®¡ |
| `Withdrawn` | to, amount | èµ„é‡‘å·²ä»æ‰˜ç®¡æå– |

### å³æ—¶åˆ†æˆäº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `InstantRewardDistributed` | referrer, buyer, level, amount | å³æ—¶å¥–åŠ±å·²åˆ†é… |

### å‘¨ç»“ç®—äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `CycleSettled` | cycle, settled_count, total_amount | å‘¨æœŸå·²ç»“ç®— |

### ğŸ†• åˆ†æˆæ¯”ä¾‹æ²»ç†äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `PercentageAdjustmentProposed` | proposal_id, proposer, change_magnitude, is_major | åˆ†æˆæ¯”ä¾‹è°ƒæ•´ææ¡ˆå·²åˆ›å»º |
| `VoteCast` | proposal_id, voter, vote_type, weight | æŠ•ç¥¨å·²æäº¤ |
| `ProposalPassed` | proposal_id, approval_rate, participation_rate, effective_block | ææ¡ˆå·²é€šè¿‡ |
| `ProposalRejected` | proposal_id, approval_rate, participation_rate | ææ¡ˆå·²æ‹’ç» |
| `ProposalCancelled` | proposal_id, proposer | ææ¡ˆå·²å–æ¶ˆ |
| `PercentageAdjustmentExecuted` | proposal_id, new_percentages, effective_block | æ¯”ä¾‹è°ƒæ•´å·²æ‰§è¡Œ |
| `GovernanceEmergencyPaused` | reason_cid | æ²»ç†ç´§æ€¥æš‚åœ |
| `GovernanceResumed` | by | æ²»ç†å·²æ¢å¤ |

### ğŸ†• å¹´è´¹ä»·æ ¼æ²»ç†äº‹ä»¶

| äº‹ä»¶ | å­—æ®µ | æè¿° |
|------|------|------|
| `MembershipPriceProposed` | proposal_id, proposer, new_prices_usdt, is_major, deposit | å¹´è´¹ä»·æ ¼è°ƒæ•´ææ¡ˆå·²åˆ›å»º |
| `MembershipPriceVoteCast` | proposal_id, voter, vote, conviction, voting_power | å¹´è´¹ä»·æ ¼ææ¡ˆæŠ•ç¥¨å·²æäº¤ |
| `MembershipPriceProposalPassed` | proposal_id, approval_rate, participation_rate, effective_block | å¹´è´¹ä»·æ ¼ææ¡ˆå·²é€šè¿‡ |
| `MembershipPriceProposalRejected` | proposal_id, approval_rate, participation_rate | å¹´è´¹ä»·æ ¼ææ¡ˆå·²æ‹’ç» |
| `MembershipPriceProposalCancelled` | proposal_id, proposer | å¹´è´¹ä»·æ ¼ææ¡ˆå·²å–æ¶ˆ |
| `MembershipPriceAdjustmentExecuted` | proposal_id, new_prices_usdt, effective_block | å¹´è´¹ä»·æ ¼è°ƒæ•´å·²æ‰§è¡Œ |

## é”™è¯¯å®šä¹‰

### æ¨èå…³ç³»é”™è¯¯

| é”™è¯¯ | æè¿° |
|------|------|
| `AlreadyBound` | å·²ç»‘å®šæ¨èäºº |
| `CodeNotFound` | æ¨èç ä¸å­˜åœ¨ |
| `CannotBindSelf` | ä¸èƒ½ç»‘å®šè‡ªå·± |
| `WouldCreateCycle` | ä¼šå½¢æˆå¾ªç¯å¼•ç”¨ |
| `NotMember` | ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ |
| `CodeTooLong` | æ¨èç è¿‡é•¿ |
| `CodeTooShort` | æ¨èç è¿‡çŸ­ |
| `CodeAlreadyTaken` | æ¨èç å·²è¢«å ç”¨ |
| `AlreadyHasCode` | å·²æ‹¥æœ‰æ¨èç  |

### é…ç½®ç®¡ç†é”™è¯¯

| é”™è¯¯ | æè¿° |
|------|------|
| `InvalidPercents` | æ— æ•ˆçš„åˆ†æˆæ¯”ä¾‹ |
| `HybridLevelsTooMany` | æ··åˆæ¨¡å¼å±‚æ•°è¶…é™ï¼ˆ>15ï¼‰ |
| `InvalidMode` | æ— æ•ˆçš„æ¨¡å¼ID |

### æ‰˜ç®¡é”™è¯¯

| é”™è¯¯ | æè¿° |
|------|------|
| `WithdrawFailed` | ææ¬¾å¤±è´¥ |

### ğŸ†• åˆ†æˆæ¯”ä¾‹æ²»ç†é”™è¯¯

| é”™è¯¯ | æè¿° |
|------|------|
| `InvalidPercentageLength` | æ¯”ä¾‹æ•°ç»„é•¿åº¦å¿…é¡»ä¸º15 |
| `PercentageTooHigh` | å•å±‚æ¯”ä¾‹è¶…è¿‡100% |
| `CriticalLayerZero` | å‰2å±‚æ¯”ä¾‹ä¸èƒ½ä¸º0ï¼ˆç¬¬3å±‚å¯ä»¥ä¸º0ï¼‰ |
| `TotalPercentageTooLow` | æ€»æ¯”ä¾‹ä½äº50% |
| `TotalPercentageTooHigh` | æ€»æ¯”ä¾‹è¶…è¿‡99% |
| `NonDecreasingPercentage` | å‰5å±‚æ¯”ä¾‹åº”é€’å‡ |
| `FirstLayerTooHigh` | L1æ¯”ä¾‹è¶…è¿‡50% |
| `InsufficientBalance` | ææ¡ˆæŠ¼é‡‘ä¸è¶³ |
| `ProposalNotFound` | ææ¡ˆä¸å­˜åœ¨ |
| `VotingNotActive` | æŠ•ç¥¨æœŸæœªå¼€å§‹æˆ–å·²ç»“æŸ |
| `AlreadyVoted` | å·²ç»æŠ•è¿‡ç¥¨ |
| `NotProposer` | ä¸æ˜¯ææ¡ˆå‘èµ·äºº |
| `CannotCancelAfterVoting` | æŠ•ç¥¨å¼€å§‹åä¸èƒ½å–æ¶ˆ |
| `TooManyActiveProposals` | æ´»è·ƒææ¡ˆè¿‡å¤š |
| `ProposalTooFrequent` | ææ¡ˆé—´éš”è¿‡çŸ­ |
| `InCooldownPeriod` | å†·å´æœŸå†…ä¸èƒ½ææ¡ˆ |
| `GovernancePausedError` | æ²»ç†åŠŸèƒ½å·²æš‚åœ |
| `InsufficientAuthority` | æƒé™ä¸è¶³ |
| `InvalidVoteType` | æ— æ•ˆçš„æŠ•ç¥¨ç±»å‹ï¼ˆå¿…é¡»ä¸º 0=Aye, 1=Nay, 2=Abstainï¼‰ |
| `InvalidConvictionType` | æ— æ•ˆçš„ä¿¡å¿µæŠ•ç¥¨ç±»å‹ï¼ˆå¿…é¡»ä¸º 0-6ï¼‰ |

### ğŸ†• å¹´è´¹ä»·æ ¼æ²»ç†é”™è¯¯

| é”™è¯¯ | æè¿° |
|------|------|
| `PriceOutOfRange` | å¹´è´¹ä»·æ ¼è¶…å‡ºèŒƒå›´ (10-1000 USDT) |
| `PriceMustBeAscending` | å¹´è´¹ä»·æ ¼å¿…é¡»é€’å¢ |
| `PriceGapTooLarge` | ç›¸é‚»ç­‰çº§ä»·æ ¼å·®è·è¿‡å¤§ |
| `MembershipPriceProposalNotFound` | å¹´è´¹ä»·æ ¼ææ¡ˆä¸å­˜åœ¨ |
| `MembershipPriceVotingNotActive` | å¹´è´¹ä»·æ ¼æŠ•ç¥¨æœŸæœªå¼€å§‹æˆ–å·²ç»“æŸ |
| `MembershipPriceAlreadyVoted` | å·²ç»å¯¹æ­¤å¹´è´¹ä»·æ ¼ææ¡ˆæŠ•è¿‡ç¥¨ |

## é…ç½®å‚æ•°

### Runtimeé…ç½®ç¤ºä¾‹

```rust
impl pallet_affiliate::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;

    // æ‰˜ç®¡ PalletId
    type EscrowPalletId = AffiliatePalletId;

    // æƒé™æ§åˆ¶
    type WithdrawOrigin = EnsureRoot<AccountId>;
    type AdminOrigin = EnsureRoot<AccountId>;

    // ğŸ†• 2025-12-30ï¼šæ¨èå…³ç³»é€šè¿‡ç»§æ‰¿ pallet_affiliate_referral::Config è·å–
    // type MembershipProvider = Membership;  // å·²ç§»åŠ¨åˆ° referral pallet

    // ç³»ç»Ÿè´¦æˆ·
    type BurnAccount = BurnAccount;
    type TreasuryAccount = TreasuryAccount;

    // ğŸ†• 2025-12-30ï¼šç”¨æˆ·å­˜å‚¨èµ„é‡‘è´¦æˆ·æä¾›è€…ï¼ˆæ›¿ä»£ StorageAccountï¼‰
    type UserFundingProvider = CosmosIpfs;

    // ğŸ†• å­˜å‚¨è†¨èƒ€é˜²æŠ¤é…ç½®
    type MaxActiveProposals = ConstU32<10>;
    type MaxReadyProposals = ConstU32<5>;
    type HistoryRetentionWeeks = ConstU32<52>;
    type ProposalExpiry = ConstU32<604800>;  // çº¦30å¤©

    // ğŸ†• ææ¡ˆæŠ¼é‡‘é…ç½®
    type ProposalDeposit = ConstU128<1_000_000_000_000_000_000_000>;  // 1000 COS å…œåº•
    type ProposalDepositUsd = ConstU64<50_000_000>;  // 50 USDT
    type DepositCalculator = TradingCommon;

    type WeightInfo = pallet_affiliate::weights::SubstrateWeight<Runtime>;
}
```

### PalletIdé…ç½®

```rust
parameter_types! {
    pub const AffiliatePalletId: PalletId = PalletId(*b"py/afflt");
}
```

### ğŸ†• å­˜å‚¨è†¨èƒ€é˜²æŠ¤å¸¸é‡é…ç½®

```rust
parameter_types! {
    pub const MaxActiveProposals: u32 = 10;      // æœ€å¤§æ´»è·ƒææ¡ˆæ•°
    pub const MaxReadyProposals: u32 = 5;        // æœ€å¤§å¾…æ‰§è¡Œææ¡ˆæ•°
    pub const HistoryRetentionWeeks: u32 = 52;   // å†å²ä¿ç•™52å‘¨
    pub const ProposalExpiry: u32 = 604800;      // ææ¡ˆ30å¤©è¿‡æœŸ
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šæ–°ç”¨æˆ·æ³¨å†Œå¹¶ç»‘å®šæ¨èäºº

```rust
// æ­¥éª¤1ï¼šæ–°ç”¨æˆ·è·å–æ¨èç ï¼ˆçº¿ä¸‹/é“¾å¤–ï¼‰
let sponsor_code = b"ALICE123".to_vec();

// æ­¥éª¤2ï¼šç»‘å®šæ¨èäºº
api.tx.affiliate
  .bindSponsor(sponsor_code)
  .signAndSend(newUser);

// æ­¥éª¤3ï¼šæˆä¸ºä¼šå‘˜åè®¤é¢†æ¨èç 
let my_code = b"BOB456".to_vec();
api.tx.affiliate
  .claimCode(my_code)
  .signAndSend(newUser);

// æ­¥éª¤4ï¼šå¯ä»¥å¼€å§‹æ¨èå…¶ä»–ç”¨æˆ·
// åˆ†äº«æ¨èç  "BOB456" ç»™å…¶ä»–äºº
```

### åœºæ™¯2ï¼šä¼šå‘˜è´­ä¹°ï¼ˆè‡ªåŠ¨åˆ†é…å¥–åŠ±ï¼‰

```rust
// ä¼šå‘˜è´­ä¹°ä¼šå‘˜èµ„æ ¼ï¼ˆ100 COSï¼‰
let amount = 100_000_000_000_000u128; // 100 COS

// ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨åˆ†é…æ¥å£ï¼ˆåœ¨ä¼šå‘˜è´­ä¹°é€»è¾‘ä¸­ï¼‰
pallet_affiliate::Pallet::<Runtime>::do_distribute_membership_rewards(
    &buyer,
    amount.into()
)?;

// æ ¹æ®ç»“ç®—æ¨¡å¼è‡ªåŠ¨åˆ†é…ï¼š
// - Instantæ¨¡å¼ï¼šç«‹å³è½¬è´¦ç»™15å±‚æ¨èäºº
// - Weeklyæ¨¡å¼ï¼šè®°è´¦åˆ°æœ¬å‘¨åº”å¾—é‡‘é¢
// - Hybridæ¨¡å¼ï¼šå‰Nå±‚å³æ—¶ï¼ŒåMå±‚å‘¨ç»“ç®—
```

### åœºæ™¯3ï¼šä¾›å¥‰ä¸šåŠ¡ï¼ˆ90%è¿›å…¥è”ç›Ÿå¥–åŠ±æ± ï¼‰

```rust
// ç”¨æˆ·ä¾›å¥‰ï¼ˆ1000 COSï¼‰
let gross_amount = 1000_000_000_000_000u128; // 1000 COS

// ç³»ç»Ÿè°ƒç”¨åˆ†é…æ¥å£ï¼ˆåœ¨ä¾›å¥‰é€»è¾‘ä¸­ï¼‰
pallet_affiliate::Pallet::<Runtime>::do_distribute_rewards(
    &buyer,
    gross_amount.into(),
    Some(52) // 52å‘¨ï¼ˆ1å¹´ï¼‰
)?;

// æ‰£è´¹ï¼š
// - é”€æ¯ï¼š5% = 50 COS
// - å›½åº“ï¼š2% = 20 COS
// - å­˜å‚¨ï¼š3% = 30 COS
// - å¯åˆ†é…ï¼š90% = 900 COS

// åˆ†é…900 COSç»™æ¨èé“¾ï¼ˆæŒ‰é…ç½®æ¯”ä¾‹ï¼‰
```

### åœºæ™¯4ï¼šå‘¨ç»“ç®—

```rust
// æ¯å‘¨å¼€å§‹åï¼Œä»»ä½•äººå¯è°ƒç”¨ç»“ç®—
let current_week = 5u32;
let max_accounts = 100u32;

// ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ˆç»“ç®—100ä¸ªè´¦æˆ·ï¼‰
api.tx.affiliate
  .settleCycle(current_week, max_accounts)
  .signAndSend(anyone);

// å¦‚æœæœªå®Œæˆï¼Œç»§ç»­è°ƒç”¨ï¼ˆç»“ç®—ä¸‹100ä¸ªè´¦æˆ·ï¼‰
api.tx.affiliate
  .settleCycle(current_week, max_accounts)
  .signAndSend(anyone);

// ç›´åˆ°å…¨éƒ¨è´¦æˆ·ç»“ç®—å®Œæˆ
```

### åœºæ™¯5ï¼šæŸ¥è¯¢æ¨èé“¾

```typescript
// æŸ¥è¯¢æ¨èäºº
const sponsor = await api.query.affiliate.sponsors(account.address);
console.log("My sponsor:", sponsor.toString());

// æŸ¥è¯¢æ¨èç 
const code = await api.query.affiliate.codeByAccount(account.address);
console.log("My code:", new TextDecoder().decode(code.toU8a()));

// æŸ¥è¯¢å®Œæ•´æ¨èé“¾ï¼ˆéœ€è¦é€’å½’æŸ¥è¯¢ï¼‰
async function getReferralChain(account) {
  const chain = [];
  let current = account;

  for (let i = 0; i < 15; i++) {
    const sponsor = await api.query.affiliate.sponsors(current);
    if (sponsor.isEmpty) break;

    chain.push(sponsor.toString());
    current = sponsor.toString();
  }

  return chain;
}

const chain = await getReferralChain(account.address);
console.log("My referral chain:", chain);
```

### åœºæ™¯6ï¼šç®¡ç†å‘˜é…ç½®

```typescript
// åˆ‡æ¢åˆ°æ··åˆæ¨¡å¼ï¼šå‰5å±‚å³æ—¶ï¼Œå10å±‚å‘¨ç»“ç®—
await api.tx.affiliate
  .setSettlementMode(2, 5, 10)
  .signAndSend(adminAccount);

// è°ƒæ•´å³æ—¶åˆ†æˆæ¯”ä¾‹ï¼ˆæ›´é«˜æ¿€åŠ±ï¼‰
const newInstantPercents = [35, 30, 20, 15, 10, 8, 6, 5, 4, 3, 2, 2, 1, 1, 1];
await api.tx.affiliate
  .setInstantPercents(newInstantPercents)
  .signAndSend(adminAccount);

// è°ƒæ•´æ¯å‘¨åŒºå—æ•°ï¼ˆæµ‹è¯•ç½‘ï¼‰
await api.tx.affiliate
  .setBlocksPerWeek(10080) // 1åˆ†é’Ÿå‡ºå—
  .signAndSend(adminAccount);
```

## é›†æˆè¯´æ˜

### ä¸ pallet-memo-offerings é›†æˆ

**é›†æˆæ–¹å¼**ï¼šé€šè¿‡ `OnOfferingCommitted` hook è‡ªåŠ¨è§¦å‘è”ç›Ÿå¥–åŠ±åˆ†é…

```rust
// åœ¨ pallet-memorial çš„ offer å‡½æ•°ä¸­
impl<T: Config> Pallet<T> {
    pub fn do_offer(...) -> DispatchResult {
        // ... ä¾›å¥‰é€»è¾‘ ...

        // è°ƒç”¨è”ç›Ÿå¥–åŠ±åˆ†é…
        let distributed = pallet_affiliate::Pallet::<T>::do_distribute_rewards(
            &who,
            amount,
            duration_weeks
        )?;

        // ... åç»­é€»è¾‘ ...
    }
}
```

### ä¸ä¼šå‘˜æ¨¡å—é›†æˆ

**é›†æˆæ–¹å¼**ï¼šé€šè¿‡ `MembershipProvider` trait æä¾›ä¼šå‘˜ä¿¡æ¯

```rust
// ä¼šå‘˜æ¨¡å—å®ç° MembershipProvider
impl<T: Config> pallet_affiliate::MembershipProvider<T::AccountId> for Pallet<T> {
    fn is_valid_member(who: &T::AccountId) -> bool {
        // æ£€æŸ¥ä¼šå‘˜çŠ¶æ€
        Self::member_status(who).is_active()
    }
}
```

### ä¸ pallet-ledger é›†æˆ

**é›†æˆæ–¹å¼**ï¼šé€šè¿‡äº‹ä»¶ç›‘å¬è®°å½•è”ç›Ÿå¥–åŠ±ç»Ÿè®¡

```rust
// pallet-ledger ç›‘å¬ InstantRewardDistributed äº‹ä»¶
impl<T: Config> Pallet<T> {
    fn on_instant_reward(referrer: &T::AccountId, amount: Balance) {
        // è®°å½•æ¨èå¥–åŠ±ç»Ÿè®¡
        Self::update_referral_stats(referrer, amount);
    }
}
```

### ä¸ pallet-escrow é›†æˆ

**é›†æˆæ–¹å¼**ï¼šæœ¬æ¨¡å—è‡ªåŒ…å«æ‰˜ç®¡åŠŸèƒ½ï¼Œæ— éœ€å¤–éƒ¨ escrow pallet

**å¦‚æœéœ€è¦å¤–éƒ¨ escrow**ï¼š
```rust
// é…ç½® WithdrawOrigin ä¸º pallet-escrow çš„ç®¡ç†æƒé™
type WithdrawOrigin = pallet_escrow::EnsureEscrowAdmin<AccountId>;
```

## Trading Pallet é›†æˆ

### AffiliateDistributor Trait å®ç°

æœ¬æ¨¡å—å®ç°äº† `AffiliateDistributor` traitï¼Œä¾› Trading Pallet è°ƒç”¨ï¼š

```rust
pub trait AffiliateDistributor<AccountId, Balance, BlockNumber> {
    fn distribute_rewards(
        buyer: &AccountId,
        amount: Balance,
        target: Option<(u8, u64)>,
    ) -> Result<Balance, DispatchError>;
}
```

### Trading Pallet è°ƒç”¨ç¤ºä¾‹

```rust
// åœ¨ pallet-trading ä¸­
impl<T: Config> Pallet<T> {
    pub fn do_trade(...) -> DispatchResult {
        // ... äº¤æ˜“é€»è¾‘ ...

        // è°ƒç”¨è”ç›Ÿå¥–åŠ±åˆ†é…
        let distributed = T::AffiliateDistributor::distribute_rewards(
            &buyer,
            commission_amount,
            Some((domain, id))
        )?;

        // ... åç»­é€»è¾‘ ...
    }
}
```

## æœ€ä½³å®è·µ

### 1. æ¨èå…³ç³»å»ºç«‹

**æ¨è**ï¼š
- åœ¨ç”¨æˆ·æ³¨å†Œæ—¶æç¤ºç»‘å®šæ¨èäºº
- æä¾›æ¨èç è¾“å…¥æ¡†ï¼Œæ”¯æŒå¤åˆ¶ç²˜è´´
- éªŒè¯æ¨èç æœ‰æ•ˆæ€§åå†æäº¤äº¤æ˜“
- æ˜¾ç¤ºæ¨èäººä¿¡æ¯ï¼ˆæ˜µç§°/å¤´åƒï¼‰ï¼Œå¢å¼ºä¿¡ä»»

**ä¸æ¨è**ï¼š
- å…è®¸ç”¨æˆ·éšæ„æ›´æ”¹æ¨èäººï¼ˆç ´åæ¨èé“¾ç¨³å®šæ€§ï¼‰
- å¼ºåˆ¶ç»‘å®šæ¨èäººï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
- ä½¿ç”¨è¿‡çŸ­çš„æ¨èç ï¼ˆå®¹æ˜“ç¢°æ’ï¼‰

### 2. ç»“ç®—æ¨¡å¼é€‰æ‹©

**æ¨èé…ç½®**ï¼š
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šHybridæ¨¡å¼ï¼ˆå‰5å±‚å³æ—¶ï¼Œå10å±‚å‘¨ç»“ç®—ï¼‰
- **æµ‹è¯•ç¯å¢ƒ**ï¼šInstantæ¨¡å¼ï¼ˆå¿«é€ŸéªŒè¯åŠŸèƒ½ï¼‰
- **ç‰¹æ®Šæ´»åŠ¨**ï¼šä¸´æ—¶åˆ‡æ¢åˆ°Instantæ¨¡å¼ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰

**åˆ‡æ¢æ—¶æœº**ï¼š
- åœ¨ä½å³°æœŸåˆ‡æ¢æ¨¡å¼ï¼ˆé¿å…å½±å“ç”¨æˆ·ä½“éªŒï¼‰
- æå‰å…¬å‘Šæ¨¡å¼åˆ‡æ¢ï¼ˆç»™ç”¨æˆ·å¿ƒç†é¢„æœŸï¼‰
- ç›‘æ§åˆ‡æ¢åçš„ç³»ç»Ÿè´Ÿè½½ï¼ˆåŠæ—¶è°ƒæ•´ï¼‰

### 3. åˆ†æˆæ¯”ä¾‹è®¾è®¡

**æ¨èç­–ç•¥**ï¼š
- L1-L3ï¼šé«˜æ¯”ä¾‹ï¼ˆ30%+ï¼‰ï¼Œæ¿€åŠ±ç›´æ¨å›¢é˜Ÿ
- L4-L10ï¼šä¸­æ¯”ä¾‹ï¼ˆ5-10%ï¼‰ï¼Œå¹³è¡¡æ”¶ç›Š
- L11-L15ï¼šä½æ¯”ä¾‹ï¼ˆ1-3%ï¼‰ï¼Œæ‰©å¤§è¦†ç›–é¢

**è°ƒæ•´åŸåˆ™**ï¼š
- æ€»æ¯”ä¾‹æ§åˆ¶åœ¨100%ä»¥å†…ï¼ˆé¿å…è¶…å‘ï¼‰
- å³æ—¶åˆ†æˆæ¯”ä¾‹ > å‘¨ç»“ç®—æ¯”ä¾‹ï¼ˆå¿«é€Ÿæ¿€åŠ±ï¼‰
- å®šæœŸåˆ†ææ•°æ®ï¼Œä¼˜åŒ–æ¯”ä¾‹é…ç½®

### 4. å‘¨ç»“ç®—ä¼˜åŒ–

**æ¨èè®¾ç½®**ï¼š
- `max_accounts`: 100-200ï¼ˆæ ¹æ®åŒºå—å¤§å°è°ƒæ•´ï¼‰
- ç»“ç®—æ—¶æœºï¼šéé«˜å³°æœŸï¼ˆå‡å°‘å¯¹ç”¨æˆ·äº¤æ˜“çš„å½±å“ï¼‰
- åˆ†æ‰¹ç»“ç®—ï¼šå¤šæ¬¡è°ƒç”¨ï¼Œé¿å…å•æ¬¡è¶…è½½

**ç›‘æ§æŒ‡æ ‡**ï¼š
- ç»“ç®—è€—æ—¶ï¼ˆå•æ¬¡ç»“ç®—çš„åŒºå—æ•°ï¼‰
- å¾…ç»“ç®—è´¦æˆ·æ•°ï¼ˆEntitlement å­˜å‚¨å¤§å°ï¼‰
- ç»“ç®—å¤±è´¥ç‡ï¼ˆè½¬è´¦å¤±è´¥çš„è´¦æˆ·æ•°ï¼‰

### 5. å®‰å…¨è€ƒè™‘

**é˜²æŠ¤æªæ–½**ï¼š
- æ¨èé“¾å¾ªç¯æ£€æµ‹ï¼ˆMaxSearchHopsé™åˆ¶ï¼‰
- ä¼šå‘˜èº«ä»½éªŒè¯ï¼ˆä»…æœ‰æ•ˆä¼šå‘˜å¯æˆä¸ºæ¨èäººï¼‰
- èµ„é‡‘éš”ç¦»ï¼ˆæ‰˜ç®¡è´¦æˆ·ç‹¬ç«‹ï¼‰
- åŸå­æ“ä½œï¼ˆåˆ†é…è¿‡ç¨‹åŸå­åŒ–ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»šï¼‰
- å®¹é”™æœºåˆ¶ï¼ˆå•ä¸ªè´¦æˆ·å¤±è´¥ä¸å½±å“å…¶ä»–è´¦æˆ·ï¼‰

**å®¡è®¡è¦ç‚¹**ï¼š
- å®šæœŸæ£€æŸ¥æ‰˜ç®¡è´¦æˆ·ä½™é¢ï¼ˆTotalDeposited - TotalWithdrawnï¼‰
- ç›‘æ§åˆ†é…å¤±è´¥äº‹ä»¶ï¼ˆè½¬è´¦å¤±è´¥/æ¨èäººæ— æ•ˆï¼‰
- è¿½æº¯æ¨èé“¾å®Œæ•´æ€§ï¼ˆæ£€æµ‹å¼‚å¸¸æ¨èå…³ç³»ï¼‰

### 6. æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- åˆ†æ‰¹ç»“ç®—ï¼šé˜²æ­¢å•æ¬¡ç»“ç®—è¿‡å¤šè´¦æˆ·å¯¼è‡´åŒºå—è¶…è½½
- æ¸¸æ ‡æœºåˆ¶ï¼šè®°å½•ç»“ç®—è¿›åº¦ï¼Œæ”¯æŒåˆ†æ‰¹æ‰§è¡Œ
- æƒ°æ€§è®¡ç®—ï¼šä»…åœ¨éœ€è¦æ—¶è®¡ç®—æ´»è·ƒæœŸå’Œå±‚æ•°
- å»é‡æœºåˆ¶ï¼šé¿å…é‡å¤åˆ†é…

**ç›‘æ§æŒ‡æ ‡**ï¼š
- æ¨èé“¾æŸ¥è¯¢è€—æ—¶ï¼ˆget_referral_chainï¼‰
- åˆ†é…è€—æ—¶ï¼ˆdo_instant_distribute / do_report_consumptionï¼‰
- ç»“ç®—è€—æ—¶ï¼ˆdo_settle_cycleï¼‰
- å­˜å‚¨å¤§å°ï¼ˆSponsors / Entitlementï¼‰

## å‰ç«¯é›†æˆè¦ç‚¹

### 1. æ¨èç å±•ç¤º

```typescript
// æ˜¾ç¤ºç”¨æˆ·çš„æ¨èç 
const MyReferralCode = () => {
  const [code, setCode] = useState("");

  useEffect(() => {
    api.query.affiliate.codeByAccount(account.address)
      .then(c => setCode(new TextDecoder().decode(c.toU8a())));
  }, [account]);

  return (
    <div>
      <p>æˆ‘çš„æ¨èç ï¼š{code}</p>
      <button onClick={() => navigator.clipboard.writeText(code)}>
        å¤åˆ¶æ¨èç 
      </button>
    </div>
  );
};
```

### 2. æ¨èé“¾å¯è§†åŒ–

```typescript
// æ˜¾ç¤ºæ¨èé“¾ï¼ˆæ ‘çŠ¶å›¾ï¼‰
const ReferralChainTree = () => {
  const [chain, setChain] = useState([]);

  useEffect(() => {
    getReferralChain(account.address).then(setChain);
  }, [account]);

  return (
    <div className="referral-tree">
      {chain.map((sponsor, index) => (
        <div key={index} className="level">
          <span>L{index + 1}:</span>
          <span>{sponsor}</span>
        </div>
      ))}
    </div>
  );
};
```

### 3. è”ç›Ÿå¥–åŠ±ç»Ÿè®¡

```typescript
// æ˜¾ç¤ºè”ç›Ÿå¥–åŠ±ç»Ÿè®¡
const AffiliateRewards = () => {
  const [stats, setStats] = useState({
    instantRewards: 0,
    weeklyRewards: 0,
    totalRewards: 0
  });

  // ç›‘å¬äº‹ä»¶ï¼Œç´¯è®¡å¥–åŠ±
  useEffect(() => {
    api.query.system.events((events) => {
      events.forEach(({ event }) => {
        if (api.events.affiliate.InstantRewardDistributed.is(event)) {
          const { referrer, amount } = event.data;
          if (referrer.eq(account.address)) {
            setStats(prev => ({
              ...prev,
              instantRewards: prev.instantRewards + amount.toNumber()
            }));
          }
        }
      });
    });
  }, []);

  return (
    <div className="rewards-stats">
      <div>å³æ—¶å¥–åŠ±ï¼š{stats.instantRewards} COS</div>
      <div>å‘¨ç»“ç®—å¥–åŠ±ï¼š{stats.weeklyRewards} COS</div>
      <div>ç´¯è®¡å¥–åŠ±ï¼š{stats.totalRewards} COS</div>
    </div>
  );
};
```

### 4. å‘¨ç»“ç®—æé†’

```typescript
// å‘¨ç»“ç®—å€’è®¡æ—¶
const SettlementCountdown = () => {
  const [countdown, setCountdown] = useState(0);

  useEffect(() => {
    const updateCountdown = async () => {
      const now = await api.query.system.number();
      const blocksPerWeek = await api.query.affiliate.blocksPerWeek();
      const currentWeek = Math.floor(now.toNumber() / blocksPerWeek.toNumber());
      const nextWeekBlock = (currentWeek + 1) * blocksPerWeek.toNumber();
      const remaining = nextWeekBlock - now.toNumber();

      setCountdown(remaining);
    };

    updateCountdown();
    const interval = setInterval(updateCountdown, 6000); // æ¯6ç§’æ›´æ–°

    return () => clearInterval(interval);
  }, []);

  const remainingTime = countdown * 6; // ç§’æ•°
  const days = Math.floor(remainingTime / 86400);
  const hours = Math.floor((remainingTime % 86400) / 3600);

  return (
    <div className="settlement-countdown">
      <p>è·ç¦»ä¸‹æ¬¡å‘¨ç»“ç®—ï¼š{days}å¤© {hours}å°æ—¶</p>
    </div>
  );
};
```

## æœªæ¥æ‰©å±•

### 1. åŠ¨æ€å±‚æ•°è°ƒæ•´

**ç›®æ ‡**ï¼šæ ¹æ®å›¢é˜Ÿæ´»è·ƒåº¦å’ŒæŒä»“é‡åŠ¨æ€è°ƒæ•´å¯æ‹¿ä»£æ•°

**å®ç°æ€è·¯**ï¼š
```rust
// æ ¹æ®ç›´æ¨æ´»è·ƒæ•°è°ƒæ•´å±‚æ•°
fn get_eligible_levels(referrer: &T::AccountId) -> u8 {
    let direct_active = DirectActiveCount::<T>::get(referrer);

    match direct_active {
        0..=2 => 3,    // 3å±‚
        3..=5 => 5,    // 5å±‚
        6..=10 => 10,  // 10å±‚
        _ => 15,       // 15å±‚
    }
}
```

### 2. æŒä»“é—¨æ§›éªŒè¯

**ç›®æ ‡**ï¼šæŒ‰æŒä»“é‡å†³å®šå¯æ‹¿ä»£æ•°

**å®ç°æ€è·¯**ï¼š
```rust
// æ ¹æ®æŒä»“é‡è°ƒæ•´å±‚æ•°
fn get_eligible_levels_by_balance(referrer: &T::AccountId) -> u8 {
    let balance = T::Currency::free_balance(referrer);

    if balance >= 10000.into() { 15 }      // 10000 COS â†’ 15å±‚
    else if balance >= 5000.into() { 10 }  // 5000 COS â†’ 10å±‚
    else if balance >= 1000.into() { 5 }   // 1000 COS â†’ 5å±‚
    else { 3 }                             // å…¶ä»– â†’ 3å±‚
}
```

### 3. å¥–åŠ±åŠ é€Ÿæœºåˆ¶

**ç›®æ ‡**ï¼šç‰¹æ®Šæ´»åŠ¨æœŸé—´æé«˜åˆ†æˆæ¯”ä¾‹

**å®ç°æ€è·¯**ï¼š
```rust
// æ´»åŠ¨åŠ é€Ÿé…ç½®
pub struct BoostConfig {
    pub start_block: BlockNumber,
    pub end_block: BlockNumber,
    pub multiplier: u8, // å€æ•°ï¼ˆ100 = 1å€ï¼Œ200 = 2å€ï¼‰
}

// åº”ç”¨åŠ é€Ÿ
fn apply_boost(amount: Balance, config: &BoostConfig) -> Balance {
    if is_in_boost_period(config) {
        amount * config.multiplier / 100
    } else {
        amount
    }
}
```

### 4. NFTå¥–åŠ±

**ç›®æ ‡**ï¼šå°†ç‰¹æ®Šè”ç›Ÿæˆå°±é“¸é€ ä¸ºNFT

**å®ç°æ€è·¯**ï¼š
- æ¨è100äººï¼šé“¸é€ "æ¨å¹¿å¤§ä½¿"NFT
- å›¢é˜Ÿç´¯è®¡æ¶ˆè´¹10ä¸‡COSï¼šé“¸é€ "é‡‘ç‰Œå›¢é˜Ÿ"NFT
- è¿ç»­52å‘¨æ´»è·ƒï¼šé“¸é€ "å¹´åº¦ä¹‹æ˜Ÿ"NFT

### 5. è”ç›Ÿæ’è¡Œæ¦œ

**ç›®æ ‡**ï¼šç»Ÿè®¡æ¨èå¥–åŠ±æ’è¡Œï¼Œæ¿€åŠ±ç«äº‰

**å®ç°æ€è·¯**ï¼š
```rust
// æ’è¡Œæ¦œå­˜å‚¨
pub type LeaderBoard<T> = StorageMap<
    _,
    Blake2_128Concat,
    u32, // period
    BoundedVec<(AccountId, Balance), MaxLeaders>, // top N
>;

// æ›´æ–°æ’è¡Œæ¦œ
fn update_leaderboard(period: u32, account: &AccountId, amount: Balance) {
    LeaderBoard::<T>::mutate(period, |board| {
        // æ’å…¥/æ›´æ–°æ’å
        // ä¿ç•™å‰Nå
    });
}
```

## è¿ç§»è¯´æ˜

### ä»æ—§ç‰ˆæœ¬è¿ç§»

å¦‚æœä½ ä¹‹å‰ä½¿ç”¨äº†ä»¥ä¸‹ä»»ä¸€æ¨¡å—ï¼Œç°åœ¨ç»Ÿä¸€ä½¿ç”¨æœ¬æ¨¡å—ï¼š

| æ—§æ¨¡å— | æ–°æ¨¡å—åŠŸèƒ½ |
|--------|-----------|
| `pallet-affiliate` | `pallet-affiliate::èµ„é‡‘æ‰˜ç®¡åŠŸèƒ½` |
| `pallet-affiliate-config` | `pallet-affiliate::é…ç½®åŠŸèƒ½` |
| `pallet-affiliate-instant` | `pallet-affiliate::å³æ—¶åˆ†æˆåŠŸèƒ½` |
| `pallet-affiliate-weekly` | `pallet-affiliate::å‘¨ç»“ç®—åŠŸèƒ½` |
| `pallet-memo-referrals` | `pallet-affiliate::æ¨èå…³ç³»åŠŸèƒ½` |

### è¿ç§»æ­¥éª¤

1. **ç§»é™¤æ—§ä¾èµ–**ï¼š
```toml
# åˆ é™¤ Cargo.toml ä¸­çš„æ—§ä¾èµ–
# pallet-affiliate = { ... }
# pallet-affiliate-config = { ... }
# pallet-affiliate-instant = { ... }
# pallet-affiliate-weekly = { ... }
# pallet-memo-referrals = { ... }

# æ·»åŠ æ–°ä¾èµ–
pallet-affiliate = { path = "../pallets/affiliate", default-features = false }
```

2. **æ›´æ–°Runtimeé…ç½®**ï¼š
```rust
// åˆ é™¤æ—§é…ç½®
// impl pallet_affiliate_config::Config for Runtime { ... }
// impl pallet_affiliate_instant::Config for Runtime { ... }
// impl pallet_affiliate_weekly::Config for Runtime { ... }
// impl pallet_memo_referrals::Config for Runtime { ... }

// æ·»åŠ æ–°é…ç½®
impl pallet_affiliate::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type EscrowPalletId = AffiliatePalletId;
    type WithdrawOrigin = EnsureRoot<AccountId>;
    type AdminOrigin = EnsureRoot<AccountId>;
    type MembershipProvider = Membership;
    type MaxCodeLen = ConstU32<32>;
    type MaxSearchHops = ConstU32<15>;
    type BurnAccount = BurnAccount;
    type TreasuryAccount = TreasuryAccount;
    type StorageAccount = StorageAccount;
}
```

3. **æ›´æ–°construct_runtimeå®**ï¼š
```rust
construct_runtime! {
    pub enum Runtime {
        // åˆ é™¤æ—§æ¨¡å—
        // Affiliate: pallet_affiliate,
        // AffiliateConfig: pallet_affiliate_config,
        // AffiliateInstant: pallet_affiliate_instant,
        // AffiliateWeekly: pallet_affiliate_weekly,
        // Referrals: pallet_memo_referrals,

        // æ·»åŠ æ–°æ¨¡å—
        Affiliate: pallet_affiliate,
    }
}
```

4. **æ•°æ®è¿ç§»**ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰ï¼š
```rust
// è¿ç§»æ¨èå…³ç³»æ•°æ®
pub fn migrate_referrals() -> Weight {
    // ä»æ—§å­˜å‚¨è¯»å–
    let old_sponsors = pallet_memo_referrals::Sponsors::<Runtime>::iter();

    // å†™å…¥æ–°å­˜å‚¨
    for (account, sponsor) in old_sponsors {
        pallet_affiliate::Sponsors::<Runtime>::insert(account, sponsor);
    }

    // è¿”å›æƒé‡
    Weight::from_parts(1_000_000, 0)
}
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**Q1: æ¨èç æ— æ•ˆ**

A: æ£€æŸ¥æ¨èç æ˜¯å¦æ­£ç¡®ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ï¼Œæ¨èäººæ˜¯å¦å·²è®¤é¢†æ¨èç ï¼Œæ¨èäººæ˜¯å¦ä¸ºæœ‰æ•ˆä¼šå‘˜ã€‚

**Q2: æ— æ³•ç»‘å®šæ¨èäºº**

A: æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šè¿‡æ¨èäººï¼ˆæ¨èå…³ç³»ä¸€ç»ç»‘å®šä¸å¯æ›´æ”¹ï¼‰ï¼Œæ˜¯å¦å°è¯•ç»‘å®šè‡ªå·±ï¼Œæ˜¯å¦å½¢æˆå¾ªç¯å¼•ç”¨ã€‚

**Q3: æœªæ”¶åˆ°è”ç›Ÿå¥–åŠ±**

A: æ£€æŸ¥ç»“ç®—æ¨¡å¼ï¼ˆWeeklyæ¨¡å¼éœ€ç­‰å¾…å‘¨ç»“ç®—ï¼‰ï¼Œæ£€æŸ¥æ¨èäººèµ„æ ¼ï¼ˆæ˜¯å¦ä¸ºæœ‰æ•ˆä¼šå‘˜ï¼‰ï¼Œæ£€æŸ¥æ´»è·ƒæœŸï¼ˆWeeklyæ¨¡å¼éœ€ä¿æŒæ´»è·ƒï¼‰ã€‚

**Q4: å‘¨ç»“ç®—å¤±è´¥**

A: æ£€æŸ¥æ‰˜ç®¡è´¦æˆ·ä½™é¢ï¼ˆæ˜¯å¦å……è¶³ï¼‰ï¼Œæ£€æŸ¥ç»“ç®—å‚æ•°ï¼ˆmax_accountsæ˜¯å¦åˆç†ï¼‰ï¼Œæ£€æŸ¥åŒºå—å¤§å°ï¼ˆæ˜¯å¦è¶…è½½ï¼‰ã€‚

**Q5: æ¨èé“¾æŸ¥è¯¢è¿”å›ç©º**

A: æ£€æŸ¥è´¦æˆ·æ˜¯å¦å·²ç»‘å®šæ¨èäººï¼Œæ£€æŸ¥æ¨èäººè´¦æˆ·æ˜¯å¦å­˜åœ¨ï¼Œæ£€æŸ¥æœ€å¤§æœç´¢æ·±åº¦é…ç½®ã€‚

### è°ƒè¯•æ–¹æ³•

**å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼š
```bash
RUST_LOG=pallet_affiliate=debug ./target/release/cosmos-node --dev
```

**æŸ¥è¯¢å­˜å‚¨çŠ¶æ€**ï¼š
```typescript
// æŸ¥è¯¢æ¨èäºº
const sponsor = await api.query.affiliate.sponsors(account.address);

// æŸ¥è¯¢æ¨èç 
const code = await api.query.affiliate.codeByAccount(account.address);

// æŸ¥è¯¢ç»“ç®—æ¨¡å¼
const mode = await api.query.affiliate.settlementMode();

// æŸ¥è¯¢æ‰˜ç®¡è´¦æˆ·ä½™é¢
const escrowAccount = api.query.affiliate.escrowAccount();
const balance = await api.query.balances.freeBalance(escrowAccount);
```

**ç›‘å¬äº‹ä»¶**ï¼š
```typescript
api.query.system.events((events) => {
  events.forEach(({ event }) => {
    if (api.events.affiliate.SponsorBound.is(event)) {
      console.log("æ¨èäººå·²ç»‘å®š:", event.data);
    }
    if (api.events.affiliate.InstantRewardDistributed.is(event)) {
      console.log("å³æ—¶å¥–åŠ±å·²åˆ†é…:", event.data);
    }
    if (api.events.affiliate.CycleSettled.is(event)) {
      console.log("å‘¨æœŸå·²ç»“ç®—:", event.data);
    }
  });
});
```

## å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡æ¡£

- [Substrateå®˜æ–¹æ–‡æ¡£](https://docs.substrate.io/)
- [Polkadot-JS APIæ–‡æ¡£](https://polkadot.js.org/docs/)
- [FRAMEå¼€å‘æŒ‡å—](https://docs.substrate.io/reference/frame-pallets/)

### ç›¸å…³æ¨¡å—

- `pallet-memorial`: çºªå¿µæœåŠ¡
- `pallet-ledger`: è´¦æœ¬ç»Ÿè®¡
- `pallet-escrow`: æ‰˜ç®¡æœåŠ¡ï¼ˆå¯é€‰ï¼‰

### æŠ€æœ¯æ ˆ

- **Substrate**: v1.0.0
- **Polkadot SDK**: stable2409
- **FRAME**: v2
- **Rust**: 1.77+

---

**ç»´æŠ¤è€…**: Cosmos Team
**æœ€åæ›´æ–°**: 2025-12-30
**ç‰ˆæœ¬**: v1.1.0

### æ›´æ–°æ—¥å¿—

#### v1.1.0 (2025-12-30)
- ğŸ†• æ¨èå…³ç³»æŠ½ç¦»åˆ°ç‹¬ç«‹ `pallet-affiliate-referral` æ¨¡å—
- ğŸ†• å¹´è´¹ä»·æ ¼æ²»ç†ç³»ç»Ÿï¼ˆMembershipPriceProposalï¼‰
- ğŸ†• å­˜å‚¨è†¨èƒ€é˜²æŠ¤æœºåˆ¶ï¼ˆcleanup_expired_proposals, cleanup_old_weekly_dataï¼‰
- ğŸ†• ä¿¡å¿µæŠ•ç¥¨é”å®šï¼ˆVoteLocksï¼‰
- ğŸ†• ç”¨æˆ·å­˜å‚¨èµ„é‡‘è´¦æˆ·ï¼ˆUserFundingProvider æ›¿ä»£ StorageAccountï¼‰
- ğŸ”§ ç¬¬3å±‚åˆ†æˆæ¯”ä¾‹å¯ä»¥ä¸º0ï¼ˆå…¨æ°‘æŠ•ç¥¨å†³å®šï¼‰

#### v1.0.0 (2025-10-28)
- åˆå§‹ç‰ˆæœ¬ï¼Œæ•´åˆ5ä¸ªè”ç›Ÿè®¡é…¬ç›¸å…³pallet
