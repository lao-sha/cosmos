# Swap Palletï¼ˆåšå¸‚å•†å…‘æ¢æ¨¡å—ï¼‰

## æ¨¡å—æ¦‚è¿°

`pallet-trading-swap` æ˜¯ Cosmos é“¾ä¸Šçš„åšå¸‚å•†å…‘æ¢æœåŠ¡æ¨¡å—ï¼Œ**ä¸“æ³¨äº COS â†’ USDT å–å‡ºæ–¹å‘**ï¼š
- **COS â†’ USDT**ï¼šç”¨æˆ·å–å‡º COSï¼Œé€šè¿‡åšå¸‚å•†æ¢å– TRC20 USDT

> ğŸ’¡ **USDT â†’ COSï¼ˆä¹°å…¥ COSï¼‰è¯·ä½¿ç”¨ `pallet-trading-otc` æ¨¡å—**ï¼Œè¯¥æ¨¡å—æä¾›å®Œå–„çš„ KYC è®¤è¯ã€é¦–è´­æœºåˆ¶å’Œä¹°å®¶æŠ¼é‡‘ä¿æŠ¤ã€‚

### æ ¸å¿ƒç‰¹æ€§

-  **OCW è‡ªåŠ¨éªŒè¯**ï¼šé“¾ä¸‹å·¥ä½œæœºè‡ªåŠ¨éªŒè¯ TRC20 äº¤æ˜“
- â° **è¶…æ—¶é€€æ¬¾æœºåˆ¶**ï¼šåšå¸‚å•†æœªåŠæ—¶å®Œæˆè½¬è´¦æ—¶è‡ªåŠ¨é€€æ¬¾
- ğŸ”’ **TRC20 äº¤æ˜“å“ˆå¸Œé˜²é‡æ”¾**ï¼šé˜²æ­¢åŒä¸€ç¬” USDT äº¤æ˜“è¢«é‡å¤ä½¿ç”¨
- ğŸš¨ **ç”¨æˆ·ä¸¾æŠ¥æœºåˆ¶**ï¼šå¯ä¸¾æŠ¥æœªå±¥çº¦æ–¹ï¼Œè¿›å…¥ä»²è£æµç¨‹
- ğŸ’° **çµæ´»é‡‘é¢éªŒè¯**ï¼šÂ±0.5% å®¹å·® + å¤šæ¡£åˆ¤å®šï¼ˆOverpaid/Exact/Underpaid/SeverelyUnderpaidï¼‰
- âš–ï¸ **SeverelyDisputed é€‰æ‹©æœºåˆ¶**ï¼šä¸¥é‡å°‘ä»˜æ—¶ç”±ç”¨æˆ·é€‰æ‹©å¤„ç†æ–¹å¼
- ğŸ”¨ **åšå¸‚å•†ä¿è¯é‡‘ç½šæ²¡**ï¼šä¸¥é‡å°‘ä»˜æ—¶ç½šæ²¡åšå¸‚å•†ä¿è¯é‡‘
- ğŸ“Š **Pricing ä¸ŠæŠ¥**ï¼šå®Œæˆäº¤æ˜“è‡ªåŠ¨ä¸ŠæŠ¥åˆ°å®šä»·æ¨¡å—

### ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v0.1.0 | 2025-11-03 | ä» pallet-trading æ‹†åˆ†è€Œæ¥ |
| v0.2.0 | 2026-01-18 | ç§»é™¤å®˜æ–¹æ¡¥æ¥åŠŸèƒ½ï¼Œä»…ä¿ç•™åšå¸‚å•†å…‘æ¢ |
| v0.3.0 | 2026-01-18 | é‡å‘½å bridge â†’ swap |
| v0.4.0 | 2026-01-20 | æ·»åŠ  OCW TRC20 éªŒè¯æœºåˆ¶ |
| v0.5.0 | 2026-02-04 | æ·»åŠ  SeverelyDisputed å—å®³æ–¹é€‰æ‹©æœºåˆ¶ |
| v0.6.0 | 2026-02-04 | æ·»åŠ åšå¸‚å•†ä¿è¯é‡‘ç½šæ²¡æœºåˆ¶ |
| v0.7.0 | 2026-02-04 | ç§»é™¤ USDTâ†’COS åŠŸèƒ½ï¼ˆç”± OTC æ¨¡å—æä¾›ï¼‰ |

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. COS â†’ USDT å…‘æ¢æµç¨‹ï¼ˆç”¨æˆ·å–å‡º COSï¼‰

```
ç”¨æˆ·                    é“¾ä¸Š                    åšå¸‚å•†
 â”‚                       â”‚                       â”‚
 â”‚ â‘  maker_swap          â”‚                       â”‚
 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
 â”‚   (é”å®šç”¨æˆ· COS)       â”‚                       â”‚
 â”‚                       â”‚                       â”‚
 â”‚                       â”‚ â‘¡ é€šçŸ¥åšå¸‚å•†           â”‚
 â”‚                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                       â”‚
 â”‚                       â”‚ â‘¢ è½¬è´¦ USDT (TRC20)   â”‚
 â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                       â”‚                       â”‚
 â”‚                       â”‚ â‘£ mark_swap_complete  â”‚
 â”‚                       â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                       â”‚   (æäº¤äº¤æ˜“å“ˆå¸Œ)       â”‚
 â”‚                       â”‚                       â”‚
 â”‚                       â”‚ â‘¤ OCW éªŒè¯ TRC20 äº¤æ˜“  â”‚
 â”‚                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
 â”‚                       â”‚                       â”‚
 â”‚                       â”‚ â‘¥ éªŒè¯æˆåŠŸï¼Œé‡Šæ”¾ COS  â”‚
 â”‚                       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚   (ä¸ŠæŠ¥ Pricing)       â”‚
 â”‚                       â”‚                       â”‚
```

### 2. OCW è‡ªåŠ¨éªŒè¯ + é‡‘é¢å¤šæ¡£åˆ¤å®š

æäº¤ TRC20 äº¤æ˜“å“ˆå¸Œåï¼Œç³»ç»Ÿé€šè¿‡é“¾ä¸‹å·¥ä½œæœºï¼ˆOCWï¼‰è‡ªåŠ¨éªŒè¯ï¼š

- è°ƒç”¨ TronGrid API æŸ¥è¯¢äº¤æ˜“ä¿¡æ¯
- éªŒè¯äº¤æ˜“çŠ¶æ€ï¼ˆSUCCESSï¼‰
- éªŒè¯æ”¶æ¬¾åœ°å€åŒ¹é…
- **é‡‘é¢å¤šæ¡£åˆ¤å®š**ï¼š

| å®é™…é‡‘é¢ | çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|---------|------|---------|
| **â‰¥ 100.5%** | `Overpaid` | âœ… éªŒè¯é€šè¿‡ |
| **99.5% ~ 100.5%** | `Exact` | âœ… éªŒè¯é€šè¿‡ |
| **50% ~ 99.5%** | `Underpaid` | âš ï¸ è¿›å…¥ä»²è£ |
| **< 50%** | `SeverelyUnderpaid` | âš–ï¸ **SeverelyDisputed**ï¼Œå—å®³æ–¹é€‰æ‹© |
| **= 0** | `Invalid` | âŒ éªŒè¯å¤±è´¥ |

### 4. SeverelyDisputed å—å®³æ–¹é€‰æ‹©æœºåˆ¶

å½“ OCW æ£€æµ‹åˆ°ä¸¥é‡å°‘ä»˜ï¼ˆ< 50%ï¼‰æ—¶ï¼Œè®¢å•è¿›å…¥ `SeverelyDisputed` çŠ¶æ€ï¼Œç”±**å—å®³æ–¹**é€‰æ‹©å¤„ç†æ–¹å¼ï¼š

| åœºæ™¯ | å°‘ä»˜æ–¹ | å—å®³æ–¹ | é€‰æ‹©æƒ |
|------|-------|--------|--------|
| COS â†’ USDT | åšå¸‚å•† | ç”¨æˆ· | ç”¨æˆ·é€‰æ‹© |
| USDT â†’ COS | ç”¨æˆ· | åšå¸‚å•† | åšå¸‚å•†é€‰æ‹© |

**é€‰é¡¹**ï¼š
- **æ¥å—éƒ¨åˆ†ä»˜æ¬¾**ï¼šæŒ‰å®é™…ä»˜æ¬¾æ¯”ä¾‹é‡Šæ”¾ COS
- **è¦æ±‚é€€æ¬¾**ï¼šå°‘ä»˜æ–¹é€€è¿˜å·²è½¬ USDTï¼ŒCOS é€€è¿˜åŸä¸»

```
SeverelyDisputed å¤„ç†æµç¨‹ï¼š

                    SeverelyDisputed
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                           â–¼
    æ¥å—éƒ¨åˆ†ä»˜æ¬¾                    è¦æ±‚é€€æ¬¾
    (accept_partial)               (request_refund)
            â”‚                           â”‚
            â–¼                           â–¼
    æŒ‰æ¯”ä¾‹é‡Šæ”¾ COS               ç­‰å¾…å°‘ä»˜æ–¹é€€ USDT
    â†’ Completed                        â”‚
                                       â–¼
                               å°‘ä»˜æ–¹ç¡®è®¤é€€æ¬¾
                               (confirm_refund)
                                       â”‚
                                       â–¼
                               COS é€€è¿˜åŸä¸»
                               â†’ Refunded/Cancelled
```

### 5. è¶…æ—¶é€€æ¬¾æœºåˆ¶

- **COS â†’ USDT è¶…æ—¶**ï¼šåšå¸‚å•†åœ¨è§„å®šæ—¶é—´å†…ï¼ˆé»˜è®¤ 1 å¤©ï¼‰æœªæäº¤äº¤æ˜“å“ˆå¸Œï¼Œè‡ªåŠ¨é€€æ¬¾ç»™ç”¨æˆ·
- **USDT â†’ COS è¶…æ—¶**ï¼šç”¨æˆ·åœ¨è§„å®šæ—¶é—´å†…ï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰æœªä»˜æ¬¾ï¼Œåšå¸‚å•† COS è‡ªåŠ¨é€€è¿˜
- **éªŒè¯è¶…æ—¶**ï¼šOCW éªŒè¯è¶…æ—¶ï¼ˆé»˜è®¤ 2 å°æ—¶ï¼‰åï¼Œè‡ªåŠ¨é€€æ¬¾

### 6. ç”¨æˆ·ä¸¾æŠ¥æœºåˆ¶

ç”¨æˆ·å¯ä»¥å¯¹ä»¥ä¸‹çŠ¶æ€çš„å…‘æ¢å‘èµ·ä¸¾æŠ¥ï¼š
- `Pending`ï¼šåšå¸‚å•†æœªå“åº”
- `Completed`ï¼šå¯¹å·²å®Œæˆçš„å…‘æ¢æœ‰å¼‚è®®

ä¸¾æŠ¥åè¿›å…¥ä»²è£æµç¨‹ï¼Œç”±ä»²è£å§”å‘˜ä¼šè£å†³ã€‚

---

## æ•°æ®ç»“æ„

### SwapStatusï¼ˆCOS â†’ USDT å…‘æ¢çŠ¶æ€ï¼‰

```rust
pub enum SwapStatus {
    /// å¾…å¤„ç† - ç­‰å¾…åšå¸‚å•†è½¬è´¦ USDT
    Pending,               // 0
    /// ç­‰å¾…éªŒè¯ - åšå¸‚å•†å·²æäº¤äº¤æ˜“å“ˆå¸Œï¼Œç­‰å¾… OCW éªŒè¯
    AwaitingVerification,  // 1
    /// å·²å®Œæˆ - éªŒè¯æˆåŠŸï¼ŒCOS å·²é‡Šæ”¾ç»™åšå¸‚å•†
    Completed,             // 2
    /// éªŒè¯å¤±è´¥ - OCW éªŒè¯ TRC20 äº¤æ˜“å¤±è´¥ï¼ˆè¿›å…¥ä»²è£ï¼‰
    VerificationFailed,    // 3
    /// ç”¨æˆ·ä¸¾æŠ¥ - ç”¨æˆ·å·²ä¸¾æŠ¥ï¼Œç­‰å¾…ä»²è£
    UserReported,          // 4
    /// ä»²è£ä¸­ - æ­£åœ¨è¿›è¡Œä»²è£
    Arbitrating,           // 5
    /// ä»²è£é€šè¿‡ - åšå¸‚å•†èƒœè¯‰
    ArbitrationApproved,   // 6
    /// ä»²è£æ‹’ç» - ç”¨æˆ·èƒœè¯‰
    ArbitrationRejected,   // 7
    /// å·²é€€æ¬¾ - è¶…æ—¶æˆ–ä»²è£åé€€æ¬¾ç»™ç”¨æˆ·
    Refunded,              // 8
    /// ğŸ†• ä¸¥é‡å°‘ä»˜äº‰è®®ï¼ˆ<50%ï¼‰ï¼Œç­‰å¾…ç”¨æˆ·å¤„ç†
    SeverelyDisputed,      // 9
}
```

### BuyOrderStatusï¼ˆUSDT â†’ COS è´­ä¹°è®¢å•çŠ¶æ€ï¼‰

```rust
pub enum BuyOrderStatus {
    /// ç­‰å¾…ç”¨æˆ·ä»˜æ¬¾ï¼ˆåšå¸‚å•† COS å·²é”å®šï¼‰
    AwaitingPayment,       // 0
    /// ç”¨æˆ·å·²æäº¤ä»˜æ¬¾å“ˆå¸Œï¼Œç­‰å¾… OCW éªŒè¯
    AwaitingVerification,  // 1
    /// éªŒè¯æˆåŠŸï¼ŒCOS å·²é‡Šæ”¾ç»™ç”¨æˆ·
    Completed,             // 2
    /// ç”¨æˆ·å–æ¶ˆï¼ˆè¶…æ—¶å‰ï¼‰
    Cancelled,             // 3
    /// ä»˜æ¬¾è¶…æ—¶ï¼ˆCOS é€€å›åšå¸‚å•†ï¼‰
    Expired,               // 4
    /// éªŒè¯å¤±è´¥ï¼Œè¿›å…¥ä»²è£ï¼ˆå°‘ä»˜ 50%-99.5%ï¼‰
    Disputed,              // 5
    /// ğŸ†• ä¸¥é‡å°‘ä»˜äº‰è®®ï¼ˆ<50%ï¼‰ï¼Œç­‰å¾…åšå¸‚å•†å¤„ç†
    SeverelyDisputed,      // 6
}
```

### MakerSwapRecordï¼ˆåšå¸‚å•†å…‘æ¢è®°å½•ï¼‰

```rust
pub struct MakerSwapRecord<T: Config> {
    /// å…‘æ¢ID
    pub swap_id: u64,
    /// åšå¸‚å•†ID
    pub maker_id: u64,
    /// åšå¸‚å•†è´¦æˆ·
    pub maker: T::AccountId,
    /// ç”¨æˆ·è´¦æˆ·
    pub user: T::AccountId,
    /// COS æ•°é‡
    pub cos_amount: BalanceOf<T>,
    /// USDT é‡‘é¢ï¼ˆç²¾åº¦ 10^6ï¼‰
    pub usdt_amount: u64,
    /// USDT æ¥æ”¶åœ°å€ï¼ˆTRC20ï¼‰
    pub usdt_address: TronAddress,
    /// åˆ›å»ºæ—¶é—´ï¼ˆåŒºå—å·ï¼‰
    pub created_at: BlockNumberFor<T>,
    /// è¶…æ—¶æ—¶é—´ï¼ˆåŒºå—å·ï¼‰
    pub timeout_at: BlockNumberFor<T>,
    /// TRC20 äº¤æ˜“å“ˆå¸Œ
    pub trc20_tx_hash: Option<BoundedVec<u8, ConstU32<128>>>,
    /// å®Œæˆæ—¶é—´ï¼ˆåŒºå—å·ï¼‰
    pub completed_at: Option<BlockNumberFor<T>>,
    /// è¯æ® CIDï¼ˆç”¨äºä»²è£ï¼‰
    pub evidence_cid: Option<BoundedVec<u8, ConstU32<256>>>,
    /// å…‘æ¢çŠ¶æ€
    pub status: SwapStatus,
    /// å…‘æ¢ä»·æ ¼ï¼ˆç²¾åº¦ 10^6ï¼‰
    pub price_usdt: u64,
}
```

### VerificationRequestï¼ˆéªŒè¯è¯·æ±‚ï¼‰

```rust
pub struct VerificationRequest<T: Config> {
    /// å…‘æ¢ID
    pub swap_id: u64,
    /// TRC20 äº¤æ˜“å“ˆå¸Œ
    pub tx_hash: BoundedVec<u8, ConstU32<128>>,
    /// é¢„æœŸæ”¶æ¬¾åœ°å€
    pub expected_to: TronAddress,
    /// é¢„æœŸ USDT é‡‘é¢ï¼ˆç²¾åº¦ 10^6ï¼‰
    pub expected_amount: u64,
    /// æäº¤æ—¶é—´ï¼ˆåŒºå—å·ï¼‰
    pub submitted_at: BlockNumberFor<T>,
    /// éªŒè¯è¶…æ—¶æ—¶é—´ï¼ˆåŒºå—å·ï¼‰
    pub verification_timeout_at: BlockNumberFor<T>,
    /// é‡è¯•æ¬¡æ•°
    pub retry_count: u8,
}
```

---

## å­˜å‚¨é¡¹

| å­˜å‚¨é¡¹ | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `NextSwapId` | `u64` | ä¸‹ä¸€ä¸ªå…‘æ¢ ID |
| `MakerSwaps` | `Map<u64, MakerSwapRecord>` | åšå¸‚å•†å…‘æ¢è®°å½•ï¼ˆswap_id â†’ è®°å½•ï¼‰ |
| `UserSwaps` | `Map<AccountId, Vec<u64>>` | ç”¨æˆ·å…‘æ¢åˆ—è¡¨ï¼ˆæ¯ç”¨æˆ·æœ€å¤š 100 ä¸ªï¼‰ |
| `MakerSwapList` | `Map<u64, Vec<u64>>` | åšå¸‚å•†å…‘æ¢åˆ—è¡¨ï¼ˆæ¯åšå¸‚å•†æœ€å¤š 200 ä¸ªæ´»è·ƒå…‘æ¢ï¼‰ |
| `UsedTronTxHashes` | `Map<Vec<u8>, BlockNumber>` | å·²ä½¿ç”¨çš„ TRC20 äº¤æ˜“å“ˆå¸Œï¼ˆé˜²é‡æ”¾ï¼Œ30 å¤© TTLï¼‰ |
| `PendingVerifications` | `Map<u64, VerificationRequest>` | å¾…éªŒè¯é˜Ÿåˆ— |
| `ArchivedSwapsL1` | `Map<u64, ArchivedSwapL1>` | L1 å½’æ¡£å…‘æ¢ï¼ˆç²¾ç®€ç‰ˆï¼‰ |
| `ArchivedSwapsL2` | `Map<u64, ArchivedSwapL2>` | L2 å½’æ¡£å…‘æ¢ï¼ˆæœ€å°ç‰ˆï¼Œ~16 å­—èŠ‚ï¼‰ |
| `SwapStats` | `SwapPermanentStats` | æ°¸ä¹…ç»Ÿè®¡æ•°æ® |

---

## Extrinsicsï¼ˆå¯è°ƒç”¨å‡½æ•°ï¼‰

### COS â†’ USDT å…‘æ¢ (call_index 0-7)

| # | å‡½æ•° | è°ƒç”¨è€… | è¯´æ˜ |
|---|------|--------|------|
| 0 | `maker_swap` | ç”¨æˆ· | åˆ›å»º COS â†’ USDT å…‘æ¢è¯·æ±‚ |
| 1 | `mark_swap_complete` | åšå¸‚å•† | æäº¤ USDT äº¤æ˜“å“ˆå¸Œ |
| 2 | `report_swap` | ç”¨æˆ· | ä¸¾æŠ¥åšå¸‚å•† |
| 3 | `confirm_verification` | VerificationOrigin | ç¡®è®¤éªŒè¯ç»“æœ |
| 4 | `handle_verification_timeout` | ä»»ä½•äºº | å¤„ç†éªŒè¯è¶…æ—¶ |
| 5 | `ocw_submit_verification` | OCW | æäº¤éªŒè¯ç»“æœï¼ˆæ— ç­¾åï¼‰ |
| 6 | `file_swap_dispute` | ç”¨æˆ· | å‘èµ·ä»²è£ |
| 7 | `claim_verification_reward` | ä»»ä½•äºº | é¢†å–éªŒè¯å¥–åŠ± |

### USDT â†’ COS è´­ä¹° (call_index 10-16)

| # | å‡½æ•° | è°ƒç”¨è€… | è¯´æ˜ |
|---|------|--------|------|
| 10 | `create_buy_order` | ç”¨æˆ· | åˆ›å»ºè´­ä¹°è®¢å•ï¼ˆé”å®šåšå¸‚å•† COSï¼‰ |
| 11 | `submit_usdt_payment` | ç”¨æˆ· | æäº¤ USDT ä»˜æ¬¾å“ˆå¸Œ |
| 12 | `cancel_buy_order` | ç”¨æˆ· | å–æ¶ˆè´­ä¹°è®¢å•ï¼ˆè¶…æ—¶å‰ï¼‰ |
| 13 | `ocw_submit_buy_verification` | OCW | æäº¤è´­ä¹°éªŒè¯ç»“æœï¼ˆæ— ç­¾åï¼‰ |
| 14 | `claim_buy_verification_reward` | ä»»ä½•äºº | é¢†å–è´­ä¹°éªŒè¯å¥–åŠ± |
| 15 | `accept_partial_payment` | åšå¸‚å•† | ğŸ†• æ¥å—éƒ¨åˆ†ä»˜æ¬¾ï¼ˆSeverelyDisputedï¼‰ |
| 16 | `confirm_usdt_refund` | åšå¸‚å•† | ğŸ†• ç¡®è®¤ USDT é€€æ¬¾ï¼ˆSeverelyDisputedï¼‰ |

### COS â†’ USDT SeverelyDisputed å¤„ç† (call_index 17-19)

| # | å‡½æ•° | è°ƒç”¨è€… | è¯´æ˜ |
|---|------|--------|------|
| 17 | `user_accept_partial_usdt` | ç”¨æˆ· | ğŸ†• æ¥å—éƒ¨åˆ† USDT ä»˜æ¬¾ |
| 18 | `user_request_usdt_refund` | ç”¨æˆ· | ğŸ†• è¦æ±‚åšå¸‚å•†é€€è¿˜ USDT |
| 19 | `maker_confirm_usdt_refund` | åšå¸‚å•† | ğŸ†• ç¡®è®¤å·²é€€è¿˜ USDT |

---

### è¯¦ç»†è¯´æ˜

#### `maker_swap` (0) - åˆ›å»º COS â†’ USDT å…‘æ¢

```rust
pub fn maker_swap(
    origin: OriginFor<T>,
    maker_id: u64,           // åšå¸‚å•† ID
    cos_amount: BalanceOf<T>, // COS æ•°é‡
    usdt_address: Vec<u8>,   // USDT æ¥æ”¶åœ°å€ï¼ˆTRC20ï¼‰
) -> DispatchResult
```

#### `create_buy_order` (10) - åˆ›å»º USDT â†’ COS è´­ä¹°è®¢å•

```rust
pub fn create_buy_order(
    origin: OriginFor<T>,
    maker_id: u64,            // åšå¸‚å•† ID
    cos_amount: BalanceOf<T>, // è´­ä¹°çš„ COS æ•°é‡
) -> DispatchResult
```

**æµç¨‹**ï¼š
1. éªŒè¯åšå¸‚å•†å­˜åœ¨ä¸”æ¿€æ´»
2. è·å–åšå¸‚å•† TRON æ”¶æ¬¾åœ°å€
3. è·å–å½“å‰ COS/USD æ±‡ç‡ï¼Œè®¡ç®— USDT é‡‘é¢
4. é”å®šåšå¸‚å•†çš„ COS åˆ°æ‰˜ç®¡
5. åˆ›å»ºè´­ä¹°è®¢å•ï¼ŒçŠ¶æ€ä¸º `AwaitingPayment`

#### `accept_partial_payment` (15) - åšå¸‚å•†æ¥å—éƒ¨åˆ†ä»˜æ¬¾

```rust
pub fn accept_partial_payment(
    origin: OriginFor<T>,
    order_id: u64,  // è®¢å• ID
) -> DispatchResult
```

**é€‚ç”¨**ï¼šUSDT â†’ COS çš„ `SeverelyDisputed` è®¢å•
**æ•ˆæœ**ï¼šæŒ‰å®é™…ä»˜æ¬¾æ¯”ä¾‹é‡Šæ”¾ COS ç»™ç”¨æˆ·

#### `user_accept_partial_usdt` (17) - ç”¨æˆ·æ¥å—éƒ¨åˆ† USDT

```rust
pub fn user_accept_partial_usdt(
    origin: OriginFor<T>,
    swap_id: u64,  // å…‘æ¢ ID
) -> DispatchResult
```

**é€‚ç”¨**ï¼šCOS â†’ USDT çš„ `SeverelyDisputed` å…‘æ¢
**æ•ˆæœ**ï¼šæŒ‰å®é™…ä»˜æ¬¾æ¯”ä¾‹é‡Šæ”¾ COS ç»™åšå¸‚å•†

---

## äº‹ä»¶

### COS â†’ USDT äº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `MakerSwapCreated` | åšå¸‚å•†å…‘æ¢å·²åˆ›å»º |
| `MakerSwapCompleted` | åšå¸‚å•†å…‘æ¢å·²å®Œæˆ |
| `MakerSwapMarkedComplete` | åšå¸‚å•†å·²æäº¤äº¤æ˜“å“ˆå¸Œ |
| `SwapReported` | ç”¨æˆ·å·²ä¸¾æŠ¥å…‘æ¢ |
| `SwapTimeout` | å…‘æ¢å·²è¶…æ—¶é€€æ¬¾ |
| `VerificationSubmitted` | TRC20 éªŒè¯å·²æäº¤ |
| `VerificationConfirmed` | TRC20 éªŒè¯æˆåŠŸ |
| `VerificationFailed` | TRC20 éªŒè¯å¤±è´¥ |
| `VerificationTimeout` | éªŒè¯è¶…æ—¶ |
| `SwapFeeCollected` | ğŸ†• æ‰‹ç»­è´¹æ”¶å– |
| `SwapSeverelyUnderpaid` | ğŸ†• ä¸¥é‡å°‘ä»˜è¿›å…¥äº‰è®® |
| `UserAcceptedPartialUsdt` | ğŸ†• ç”¨æˆ·æ¥å—éƒ¨åˆ† USDT |
| `UserRequestedUsdtRefund` | ğŸ†• ç”¨æˆ·è¦æ±‚ USDT é€€æ¬¾ |
| `MakerUsdtRefundConfirmed` | ğŸ†• åšå¸‚å•†ç¡®è®¤é€€æ¬¾ |

### USDT â†’ COS äº‹ä»¶

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `BuyOrderCreated` | ğŸ†• è´­ä¹°è®¢å•å·²åˆ›å»º |
| `BuyOrderPaymentSubmitted` | ğŸ†• ç”¨æˆ·å·²æäº¤ä»˜æ¬¾å“ˆå¸Œ |
| `BuyOrderCompleted` | ğŸ†• è´­ä¹°è®¢å•å·²å®Œæˆ |
| `BuyOrderCancelled` | ğŸ†• è´­ä¹°è®¢å•å·²å–æ¶ˆ |
| `BuyOrderExpired` | ğŸ†• è´­ä¹°è®¢å•å·²è¿‡æœŸ |
| `BuyOrderSeverelyUnderpaid` | ğŸ†• ä¸¥é‡å°‘ä»˜è¿›å…¥äº‰è®® |
| `PartialPaymentAccepted` | ğŸ†• åšå¸‚å•†æ¥å—éƒ¨åˆ†ä»˜æ¬¾ |
| `UsdtRefundConfirmed` | ğŸ†• USDT é€€æ¬¾å·²ç¡®è®¤ |

---

## é”™è¯¯

### é€šç”¨é”™è¯¯

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `SwapNotFound` | å…‘æ¢ä¸å­˜åœ¨ |
| `MakerNotFound` | åšå¸‚å•†ä¸å­˜åœ¨ |
| `MakerNotActive` | åšå¸‚å•†æœªæ¿€æ´» |
| `InvalidStatus` | çŠ¶æ€æ— æ•ˆ |
| `NotAuthorized` | æœªæˆæƒ |
| `InvalidTxHash` | äº¤æ˜“å“ˆå¸Œæ— æ•ˆ |
| `TronTxHashAlreadyUsed` | TRON äº¤æ˜“å“ˆå¸Œå·²è¢«ä½¿ç”¨ï¼ˆé˜²é‡æ”¾ï¼‰ |
| `PriceNotAvailable` | ä»·æ ¼ä¸å¯ç”¨ |
| `AmountOverflow` | é‡‘é¢æº¢å‡º |

### COS â†’ USDT é”™è¯¯

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `InvalidSwapStatus` | å…‘æ¢çŠ¶æ€ä¸æ­£ç¡® |
| `SwapAmountTooLow` | å…‘æ¢é‡‘é¢å¤ªä½ |
| `NotSwapUser` | ğŸ†• ä¸æ˜¯å…‘æ¢çš„ç”¨æˆ· |
| `NotMaker` | ä¸æ˜¯åšå¸‚å•† |
| `CannotReport` | æ— æ³•ä¸¾æŠ¥ |

### USDT â†’ COS é”™è¯¯

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `BuyOrderNotFound` | ğŸ†• è´­ä¹°è®¢å•ä¸å­˜åœ¨ |
| `InvalidBuyOrderStatus` | ğŸ†• è´­ä¹°è®¢å•çŠ¶æ€ä¸æ­£ç¡® |
| `NotOrderBuyer` | ğŸ†• ä¸æ˜¯è®¢å•ä¹°å®¶ |
| `NotOrderMaker` | ğŸ†• ä¸æ˜¯è®¢å•åšå¸‚å•† |
| `EvidenceNotFound` | ğŸ†• å°‘ä»˜è¯æ®ä¸å­˜åœ¨ |
| `PaymentDeadlinePassed` | ğŸ†• ä»˜æ¬¾æˆªæ­¢æ—¶é—´å·²è¿‡ |
| `PaymentDeadlineNotPassed` | ğŸ†• ä»˜æ¬¾æˆªæ­¢æ—¶é—´æœªåˆ° |

---

## é…ç½®å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `OcwSwapTimeoutBlocks` | `BlockNumber` | 14400ï¼ˆçº¦ 1 å¤©ï¼‰ | COS â†’ USDT åšå¸‚å•†è¶…æ—¶æ—¶é—´ |
| `BuyOrderPaymentTimeoutBlocks` | `BlockNumber` | ğŸ†• 600ï¼ˆçº¦ 1 å°æ—¶ï¼‰ | USDT â†’ COS ç”¨æˆ·ä»˜æ¬¾è¶…æ—¶ |
| `VerificationTimeoutBlocks` | `BlockNumber` | 1200ï¼ˆçº¦ 2 å°æ—¶ï¼‰ | TRC20 éªŒè¯è¶…æ—¶æ—¶é—´ |
| `MinSwapAmount` | `Balance` | 100 COS | æœ€å°å…‘æ¢é‡‘é¢ |
| `TxHashTtlBlocks` | `BlockNumber` | 432000ï¼ˆçº¦ 30 å¤©ï¼‰ | äº¤æ˜“å“ˆå¸Œ TTLï¼ˆé˜²é‡æ”¾çª—å£ï¼‰ |
| `SwapFeeRateBps` | `u32` | ğŸ†• 50ï¼ˆ0.5%ï¼‰ | å…‘æ¢æ‰‹ç»­è´¹ç‡ï¼ˆåŸºç‚¹ï¼‰ |
| `MinSwapFee` | `Balance` | ğŸ†• 1 COS | æœ€ä½æ‰‹ç»­è´¹ |

---

## ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·å‘èµ·å…‘æ¢

```rust
// ç”¨æˆ·å°† 1000 COS å…‘æ¢ä¸º USDT
let maker_id = 1;
let cos_amount = 1_000_000_000_000_000u128; // 1000 COS (12ä½ç²¾åº¦)
let usdt_address = b"TRC20_ADDRESS_HERE".to_vec();

Swap::maker_swap(
    RuntimeOrigin::signed(user),
    maker_id,
    cos_amount,
    usdt_address,
)?;
```

### åšå¸‚å•†å®Œæˆå…‘æ¢

```rust
// åšå¸‚å•†è½¬è´¦ USDT åï¼Œæäº¤äº¤æ˜“å“ˆå¸Œ
let swap_id = 1;
let trc20_tx_hash = b"abc123...".to_vec();

Swap::mark_swap_complete(
    RuntimeOrigin::signed(maker),
    swap_id,
    trc20_tx_hash,
)?;
```

### ç”¨æˆ·ä¸¾æŠ¥

```rust
// ç”¨æˆ·ä¸¾æŠ¥æœªå±¥çº¦çš„åšå¸‚å•†
let swap_id = 1;

Swap::report_swap(
    RuntimeOrigin::signed(user),
    swap_id,
)?;
```

### æŸ¥è¯¢å…‘æ¢ä¿¡æ¯

```rust
// è·å–å…‘æ¢è¯¦æƒ…ï¼ˆå«å¯è¯»æ—¶é—´ï¼‰
let swap_info = Swap::get_swap_with_time(swap_id);

// è·å–ç”¨æˆ·æ‰€æœ‰å…‘æ¢
let user_swaps = Swap::get_user_swaps(&user);

// è·å–åšå¸‚å•†æ‰€æœ‰å…‘æ¢
let maker_swaps = Swap::get_maker_swaps(maker_id);
```

---

## å­˜å‚¨è†¨èƒ€é˜²æŠ¤

### å½’æ¡£æœºåˆ¶

æ¨¡å—å®ç°äº†ä¸‰çº§å­˜å‚¨å½’æ¡£æœºåˆ¶ï¼Œé˜²æ­¢é“¾ä¸Šå­˜å‚¨æ— é™å¢é•¿ï¼š

1. **æ´»è·ƒå­˜å‚¨**ï¼š`MakerSwaps` - å®Œæ•´çš„å…‘æ¢è®°å½•
2. **L1 å½’æ¡£**ï¼š`ArchivedSwapsL1` - ç²¾ç®€ç‰ˆï¼ˆ30 å¤©åå½’æ¡£ï¼‰
3. **L2 å½’æ¡£**ï¼š`ArchivedSwapsL2` - æœ€å°ç‰ˆï¼ˆ90 å¤©åå½’æ¡£ï¼Œ~16 å­—èŠ‚ï¼‰

### TTL æ¸…ç†

- **äº¤æ˜“å“ˆå¸Œ TTL**ï¼š30 å¤©åè‡ªåŠ¨æ¸…ç†å·²ä½¿ç”¨çš„äº¤æ˜“å“ˆå¸Œ
- **on_idle æ¸…ç†**ï¼šåˆ©ç”¨åŒºå—ç©ºé—²æ—¶é—´è¿›è¡Œæ¸…ç†ï¼Œä¸å½±å“æ­£å¸¸äº¤æ˜“

---

## ä¾èµ–æ¨¡å—

| æ¨¡å— | è°ƒç”¨æ–¹å‘ | ç”¨é€” |
|------|---------|------|
| `pallet-escrow` | â†’ | èµ„é‡‘æ‰˜ç®¡æœåŠ¡ |
| `pallet-arbitration` | â†’ | ä»²è£æœåŠ¡ |
| `pallet-trading-common` | â†’ | å…¬å…±ç±»å‹å’Œæ¥å£ |
| `pallet-trading-pricing` | â†” | ä»·æ ¼æŸ¥è¯¢ + æˆäº¤ä¸ŠæŠ¥ |
| `pallet-trading-maker` | â†’ | åšå¸‚å•†éªŒè¯å’Œä¿¡æ¯è·å– |
| `pallet-trading-credit` | â†’ | ä¿¡ç”¨åˆ†è®°å½• |
| `pallet-timestamp` | â†’ | æ—¶é—´æˆ³æœåŠ¡ |
| `pallet-storage-lifecycle` | â†’ | å­˜å‚¨ç”Ÿå‘½å‘¨æœŸç®¡ç† |
| `pallet-cosmos-ipfs` | â†’ | CID é”å®šç®¡ç†ï¼ˆè¯æ®å­˜å‚¨ï¼‰ |

### Pricing æ¨¡å—äº¤äº’

```rust
// è·å–ä»·æ ¼ï¼ˆåˆ›å»ºè®¢å•æ—¶ï¼‰
let price = T::Pricing::get_cos_to_usd_rate()?;

// ä¸ŠæŠ¥æˆäº¤ï¼ˆéªŒè¯é€šè¿‡åï¼‰
T::Pricing::report_swap_order(timestamp, price_usdt, cos_qty)?;
```

**ä¸ŠæŠ¥æ—¶æœº**ï¼š
- `do_confirm_verification` (COS â†’ USDT æ­£å¸¸å®Œæˆ) âœ…
- `do_confirm_buy_verification` (USDT â†’ COS æ­£å¸¸å®Œæˆ) âœ…
- `do_accept_partial_payment` (USDT â†’ COS éƒ¨åˆ†ä»˜æ¬¾) âš ï¸ å¾…è¡¥å……
- `do_user_accept_partial_usdt` (COS â†’ USDT éƒ¨åˆ†ä»˜æ¬¾) âš ï¸ å¾…è¡¥å……

---

## å®‰å…¨è€ƒè™‘

1. **é˜²é‡æ”¾æ”»å‡»**ï¼šæ¯ä¸ª TRC20 äº¤æ˜“å“ˆå¸Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡
2. **è¶…æ—¶ä¿æŠ¤**ï¼šæœªåŠæ—¶å“åº”æ—¶è‡ªåŠ¨é€€æ¬¾
3. **OCW éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯ TRC20 äº¤æ˜“çœŸå®æ€§
4. **å¤šæ¡£é‡‘é¢åˆ¤å®š**ï¼šåŒºåˆ† Overpaid/Exact/Underpaid/SeverelyUnderpaid
5. **SeverelyDisputed é€‰æ‹©æœºåˆ¶**ï¼šä¸¥é‡å°‘ä»˜ç”±å—å®³æ–¹å†³å®šå¤„ç†æ–¹å¼
6. **ğŸ†• åšå¸‚å•†ä¿è¯é‡‘ç½šæ²¡**ï¼šä¸¥é‡å°‘ä»˜æ—¶ç½šæ²¡åšå¸‚å•†ä¿è¯é‡‘ 10%
7. **ä»²è£æœºåˆ¶**ï¼šäº‰è®®æƒ…å†µä¸‹ç”±ä»²è£å§”å‘˜ä¼šè£å†³
8. **ä¿¡ç”¨åˆ†ç³»ç»Ÿ**ï¼šè®°å½•åšå¸‚å•†å±¥çº¦æƒ…å†µ

---

## ğŸ†• åšå¸‚å•†ä¿è¯é‡‘ç½šæ²¡æœºåˆ¶

### è§¦å‘æ¡ä»¶

å½“ **COS â†’ USDT** å…‘æ¢ä¸­åšå¸‚å•†ä¸¥é‡å°‘ä»˜ï¼ˆ< 50%ï¼‰ï¼Œä¸”ç”¨æˆ·é€‰æ‹© **æ¥å—éƒ¨åˆ† USDT** æ—¶è§¦å‘ã€‚

### ç½šæ²¡æµç¨‹

```
ç”¨æˆ·é€‰æ‹©æ¥å—éƒ¨åˆ† USDT
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŒ‰æ¯”ä¾‹åˆ†é… COS          â”‚
â”‚    - åšå¸‚å•†: actual/expected â”‚
â”‚    - ç”¨æˆ·é€€å›: å‰©ä½™éƒ¨åˆ†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç½šæ²¡åšå¸‚å•†ä¿è¯é‡‘        â”‚
â”‚    - ç½šé‡‘ = max(å·®é¢Ã—10%, é¢„æœŸÃ—5%) â”‚
â”‚    - è½¬å…¥å›½åº“              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è®°å½•æƒ©ç½š                â”‚
â”‚    - PenaltyType: SwapSeverelyUnderpaid â”‚
â”‚    - åšå¸‚å•†å¯ç”³è¯‰ï¼ˆ7å¤©å†…ï¼‰  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç½šé‡‘è®¡ç®—

**å…¬å¼**ï¼š`ç½šé‡‘ = max(å·®é¢ Ã— 10%, é¢„æœŸé‡‘é¢ Ã— 5%)`

| é¢„æœŸ USDT | å®é™… USDT | å·®é¢ | å·®é¢Ã—10% | é¢„æœŸÃ—5% | **å®é™…ç½šé‡‘** |
|-----------|-----------|------|----------|---------|-------------|
| 20 | 5 | 15 | 1.5 | 1 | **1.5 USD** |
| 50 | 20 | 30 | 3 | 2.5 | **3 USD** |
| 100 | 40 | 60 | 6 | 5 | **6 USD** |
| 200 | 80 | 120 | 12 | 10 | **12 USD** |
| 500 | 200 | 300 | 30 | 25 | **30 USD** |
| 1000 | 400 | 600 | 60 | 50 | **60 USD** |

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- å°é¢äº¤æ˜“ï¼šç½šé‡‘æ¯”ä¾‹åˆç†ï¼Œä¸ä¼šè¿‡åº¦æƒ©ç½š
- å¤§é¢äº¤æ˜“ï¼šä¿æŒ 10% å¨æ…‘åŠ›

### ç›¸å…³äº‹ä»¶

```rust
Event::MakerDepositSlashed {
    swap_id: u64,
    maker_id: u64,
    penalty_id: u64,  // æƒ©ç½šè®°å½•IDï¼Œå¯ç”¨äºç”³è¯‰
}
```

### é€‚ç”¨åœºæ™¯

| åœºæ™¯ | å°‘ä»˜æ–¹ | æ˜¯å¦ç½šæ²¡ | åŸå›  |
|------|--------|---------|------|
| COS â†’ USDT | åšå¸‚å•† | âœ… æ˜¯ | åšå¸‚å•†æœ‰é“¾ä¸Šä¿è¯é‡‘ |
| USDT â†’ COS | ç”¨æˆ· | âŒ å¦ | ç”¨æˆ·æ— é“¾ä¸Šä¿è¯é‡‘ |

### åšå¸‚å•†ç”³è¯‰

åšå¸‚å•†å¯åœ¨ **7 å¤©å†…** é€šè¿‡ `appeal_penalty` å‡½æ•°ç”³è¯‰ï¼š

```rust
TradingMaker::appeal_penalty(origin, penalty_id, evidence_cid)
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### éƒ¨åˆ†ä»˜æ¬¾å®Œæˆè·¯å¾„æœªä¸ŠæŠ¥ Pricing

**é—®é¢˜**ï¼š
- `do_accept_partial_payment` å’Œ `do_user_accept_partial_usdt` å®Œæˆäº¤æ˜“ä½†æœªä¸ŠæŠ¥ Pricing

**å½±å“**ï¼š
- ä»·æ ¼èšåˆæ•°æ®ç¼ºå°‘éƒ¨åˆ†æˆäº¤é‡
- VWAP è®¡ç®—å¯èƒ½å­˜åœ¨åå·®

**å»ºè®®**ï¼š
åœ¨ä¸Šè¿°å‡½æ•°ä¸­æ·»åŠ  `T::Pricing::report_swap_order()` è°ƒç”¨ï¼ŒæŒ‰å®é™…æˆäº¤çš„ COS æ•°é‡ä¸ŠæŠ¥ã€‚

---

## License

Unlicense
