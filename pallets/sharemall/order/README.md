# pallet-sharemall-order

> ğŸ›’ ShareMall è®¢å•ç®¡ç†æ¨¡å— - æŒ‰å•†å“ç±»åˆ«åŒºåˆ†è®¢å•æµç¨‹

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Substrate](https://img.shields.io/badge/Substrate-polkadot--sdk-blue)](https://github.com/paritytech/polkadot-sdk)

## ğŸ“– æ¦‚è¿°

`pallet-sharemall-order` æ˜¯ ShareMall å•†åŸç³»ç»Ÿçš„è®¢å•ç®¡ç†æ¨¡å—ï¼Œè´Ÿè´£è®¢å•çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚**æ ¹æ®å•†å“ç±»åˆ«è‡ªåŠ¨é€‰æ‹©ä¸åŒçš„è®¢å•æµç¨‹**ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- ğŸ›’ **ä¸‹å•æ”¯ä»˜** - åˆ›å»ºè®¢å•å¹¶é”å®šèµ„é‡‘åˆ°æ‰˜ç®¡
- ğŸ“¦ **å‘è´§ç®¡ç†** - å–å®¶å¡«å†™ç‰©æµä¿¡æ¯ï¼ˆå®ç‰©å•†å“ï¼‰
- âœ… **ç¡®è®¤æ”¶è´§** - ä¹°å®¶ç¡®è®¤åé‡Šæ”¾èµ„é‡‘ç»™å–å®¶
- âŒ **å–æ¶ˆè®¢å•** - æœªå‘è´§å‰å¯å–æ¶ˆå¹¶é€€æ¬¾ï¼ˆæ•°å­—å•†å“é™¤å¤–ï¼‰
- ğŸ’¸ **é€€æ¬¾æµç¨‹** - ç”³è¯·é€€æ¬¾ã€å–å®¶åŒæ„é€€æ¬¾ï¼ˆæ•°å­—å•†å“é™¤å¤–ï¼‰
- â° **è¶…æ—¶å¤„ç†** - å‘è´§è¶…æ—¶è‡ªåŠ¨é€€æ¬¾ã€ç¡®è®¤è¶…æ—¶è‡ªåŠ¨å®Œæˆ
- ğŸ **ç§¯åˆ†æŠµæ‰£** - æ”¯æŒä½¿ç”¨åº—é“ºç§¯åˆ†æŠµæ‰£è®¢å•é‡‘é¢
- ğŸ“Š **ç»Ÿè®¡åˆ†æ** - è®¢å•æ•°ã€äº¤æ˜“é¢ã€å¹³å°è´¹ç»Ÿè®¡
- ğŸ”§ **æœåŠ¡ç±»è®¢å•** - æ”¯æŒæœåŠ¡å¼€å§‹ã€å®Œæˆã€ç¡®è®¤æµç¨‹

## ğŸ“‹ æŒ‰å•†å“ç±»åˆ«åŒºåˆ†æµç¨‹

| å•†å“ç±»åˆ« | æµç¨‹ | å¯å–æ¶ˆ | å¯é€€æ¬¾ |
|----------|------|--------|--------|
| **Digital** | æ”¯ä»˜ â†’ è‡ªåŠ¨å®Œæˆ | âŒ | âŒ |
| **Physical** | æ”¯ä»˜ â†’ å‘è´§ â†’ ç¡®è®¤æ”¶è´§ | âœ…ï¼ˆå‘è´§å‰ï¼‰ | âœ… |
| **Service** | æ”¯ä»˜ â†’ å¼€å§‹æœåŠ¡ â†’ å®ŒæˆæœåŠ¡ â†’ ç¡®è®¤ | âœ…ï¼ˆæœåŠ¡å‰ï¼‰ | âœ… |
| **Other** | æ”¯ä»˜ â†’ å‘è´§ â†’ ç¡®è®¤æ”¶è´§ | âœ…ï¼ˆå‘è´§å‰ï¼‰ | âœ… |

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    pallet-sharemall-order                       â”‚
â”‚                      (è®¢å•ç®¡ç†æ¨¡å—)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ è®¢å• CRUD æ“ä½œ                                                â”‚
â”‚  â€¢ è®¢å•çŠ¶æ€ç®¡ç†                                                  â”‚
â”‚  â€¢ èµ„é‡‘æ‰˜ç®¡é›†æˆ                                                  â”‚
â”‚  â€¢ è¶…æ—¶è‡ªåŠ¨å¤„ç†                                                  â”‚
â”‚  â€¢ ç§¯åˆ†æŠµæ‰£                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚              â”‚
         â”‚ ShopProvider â”‚ ProductProvider â”‚ Escrow    â”‚ ShopToken
         â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   shop      â”‚ â”‚   product   â”‚ â”‚   escrow    â”‚ â”‚    token    â”‚
â”‚  (åº—é“º)     â”‚ â”‚   (å•†å“)    â”‚ â”‚   (æ‰˜ç®¡)    â”‚ â”‚   (ç§¯åˆ†)    â”‚
â”‚ â€¢ åº—é“ºéªŒè¯  â”‚ â”‚ â€¢ å•†å“éªŒè¯  â”‚ â”‚ â€¢ èµ„é‡‘é”å®š  â”‚ â”‚ â€¢ ç§¯åˆ†æŠµæ‰£  â”‚
â”‚ â€¢ ç»Ÿè®¡æ›´æ–°  â”‚ â”‚ â€¢ åº“å­˜ç®¡ç†  â”‚ â”‚ â€¢ èµ„é‡‘é‡Šæ”¾  â”‚ â”‚ â€¢ ç§¯åˆ†å¥–åŠ±  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’° è®¢å•èµ„é‡‘æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®¢å•èµ„é‡‘æµ                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ä¸‹å•æ”¯ä»˜                                                     â”‚
â”‚     ä¹°å®¶è´¦æˆ· â”€â”€â†’ Escrow æ‰˜ç®¡è´¦æˆ·                                 â”‚
â”‚                                                                 â”‚
â”‚  2. ç¡®è®¤æ”¶è´§                                                     â”‚
â”‚     Escrow æ‰˜ç®¡è´¦æˆ· â”€â”€â†’ å–å®¶è´¦æˆ·ï¼ˆæ‰£é™¤å¹³å°è´¹ï¼‰                   â”‚
â”‚                    â”€â”€â†’ å¹³å°è´¦æˆ·ï¼ˆå¹³å°è´¹ï¼‰                        â”‚
â”‚                                                                 â”‚
â”‚  3. å–æ¶ˆ/é€€æ¬¾                                                    â”‚
â”‚     Escrow æ‰˜ç®¡è´¦æˆ· â”€â”€â†’ ä¹°å®¶è´¦æˆ·ï¼ˆå…¨é¢é€€æ¬¾ï¼‰                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ å®‰è£…

### Cargo.toml

```toml
[dependencies]
pallet-sharemall-order = { path = "pallets/sharemall/order", default-features = false }

[features]
std = [
    "pallet-sharemall-order/std",
]
```

## âš™ï¸ Runtime é…ç½®

```rust
parameter_types! {
    /// å¹³å°è´¦æˆ·
    pub PlatformAccount: AccountId = AccountId::from([0u8; 32]);
    /// å¹³å°è´¹ç‡ï¼š2%ï¼ˆ200 åŸºç‚¹ï¼‰
    pub const PlatformFeeRate: u16 = 200;
    /// å‘è´§è¶…æ—¶ï¼š7 å¤©ï¼ˆæŒ‰ 6 ç§’/å—è®¡ç®—ï¼‰
    pub const ShipTimeout: BlockNumber = 7 * 24 * 60 * 10;
    /// ç¡®è®¤æ”¶è´§è¶…æ—¶ï¼š14 å¤©
    pub const ConfirmTimeout: BlockNumber = 14 * 24 * 60 * 10;
}

impl pallet_sharemall_order::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type Escrow = Escrow;
    type ShopProvider = ShareMallShop;
    type ProductProvider = ShareMallProduct;
    type ShopToken = ShareMallToken;
    type PlatformAccount = PlatformAccount;
    type PlatformFeeRate = PlatformFeeRate;
    type ShipTimeout = ShipTimeout;
    type ConfirmTimeout = ConfirmTimeout;
    type MaxCidLength = ConstU32<64>;
}
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| `Currency` | Currency | è´§å¸ç±»å‹ | `Balances` |
| `Escrow` | EscrowTrait | æ‰˜ç®¡æ¥å£ | `Escrow` |
| `ShopProvider` | ShopProvider | åº—é“ºæŸ¥è¯¢æ¥å£ | `ShareMallShop` |
| `ProductProvider` | ProductProvider | å•†å“æŸ¥è¯¢æ¥å£ | `ShareMallProduct` |
| `ShopToken` | ShopTokenProvider | åº—é“ºç§¯åˆ†æ¥å£ | `ShareMallToken` |
| `PlatformAccount` | AccountId | **å¹³å°è´¦æˆ·** | - |
| `PlatformFeeRate` | u16 | **å¹³å°è´¹ç‡ï¼ˆåŸºç‚¹ï¼‰** | 200 (2%) |
| `ShipTimeout` | BlockNumber | **å‘è´§è¶…æ—¶** | 7 å¤© |
| `ConfirmTimeout` | BlockNumber | **ç¡®è®¤æ”¶è´§è¶…æ—¶** | 14 å¤© |
| `MaxCidLength` | u32 | CID æœ€å¤§é•¿åº¦ | 64 |

## ğŸ“Š æ•°æ®ç»“æ„

### MallOrder - è®¢å•ä¿¡æ¯

```rust
pub struct MallOrder<AccountId, Balance, BlockNumber, MaxCidLen> {
    pub id: u64,                              // è®¢å• ID
    pub shop_id: u64,                         // åº—é“º ID
    pub product_id: u64,                      // å•†å“ ID
    pub buyer: AccountId,                     // ä¹°å®¶è´¦æˆ·
    pub seller: AccountId,                    // å–å®¶è´¦æˆ·
    pub quantity: u32,                        // è´­ä¹°æ•°é‡
    pub unit_price: Balance,                  // å•ä»·
    pub total_amount: Balance,                // æ€»é‡‘é¢
    pub platform_fee: Balance,                // å¹³å°è´¹
    pub product_category: ProductCategory,    // å•†å“ç±»åˆ«ï¼ˆå†³å®šè®¢å•æµç¨‹ï¼‰
    pub requires_shipping: bool,              // æ˜¯å¦éœ€è¦ç‰©æµ
    pub shipping_cid: Option<BoundedVec<u8, MaxCidLen>>,  // æ”¶è´§åœ°å€ CID
    pub tracking_cid: Option<BoundedVec<u8, MaxCidLen>>,  // ç‰©æµä¿¡æ¯ CID
    pub status: MallOrderStatus,              // è®¢å•çŠ¶æ€
    pub created_at: BlockNumber,              // åˆ›å»ºæ—¶é—´
    pub paid_at: Option<BlockNumber>,         // æ”¯ä»˜æ—¶é—´
    pub shipped_at: Option<BlockNumber>,      // å‘è´§æ—¶é—´
    pub completed_at: Option<BlockNumber>,    // å®Œæˆæ—¶é—´
    pub service_started_at: Option<BlockNumber>,    // æœåŠ¡å¼€å§‹æ—¶é—´
    pub service_completed_at: Option<BlockNumber>,  // æœåŠ¡å®Œæˆæ—¶é—´
    pub escrow_id: u64,                       // æ‰˜ç®¡ ID
}
```

### MallOrderStatus - è®¢å•çŠ¶æ€

```rust
pub enum MallOrderStatus {
    Created,    // å·²åˆ›å»ºï¼ˆå¾…æ”¯ä»˜ï¼‰
    Paid,       // å·²æ”¯ä»˜ï¼ˆå¾…å‘è´§ï¼‰
    Shipped,    // å·²å‘è´§ï¼ˆå¾…æ”¶è´§ï¼‰
    Completed,  // å·²å®Œæˆ
    Cancelled,  // å·²å–æ¶ˆ
    Refunded,   // å·²é€€æ¬¾
    Disputed,   // äº‰è®®ä¸­
    Expired,    // å·²è¿‡æœŸ
}
```

### OrderStatistics - è®¢å•ç»Ÿè®¡

```rust
pub struct OrderStatistics<Balance> {
    pub total_orders: u64,          // æ€»è®¢å•æ•°
    pub completed_orders: u64,      // å·²å®Œæˆè®¢å•æ•°
    pub total_volume: Balance,      // æ€»äº¤æ˜“é¢
    pub total_platform_fees: Balance, // æ€»å¹³å°è´¹æ”¶å…¥
}
```

## ğŸ”§ Extrinsics

### 1. place_order

ä¸‹å•å¹¶æ”¯ä»˜ï¼ˆèµ„é‡‘é”å®šåˆ°æ‰˜ç®¡ï¼‰ã€‚

```rust
fn place_order(
    origin: OriginFor<T>,
    product_id: u64,
    quantity: u32,
    shipping_cid: Option<Vec<u8>>,
    use_tokens: Option<BalanceOf<T>>,
) -> DispatchResult
```

**å‚æ•°ï¼š**
- `product_id` - å•†å“ ID
- `quantity` - è´­ä¹°æ•°é‡
- `shipping_cid` - æ”¶è´§åœ°å€ IPFS CID
- `use_tokens` - ä½¿ç”¨ç§¯åˆ†æŠµæ‰£é‡‘é¢ï¼ˆå¯é€‰ï¼‰

**æƒé™ï¼š** ä»»æ„ç”¨æˆ·ï¼ˆä¸èƒ½è´­ä¹°è‡ªå·±åº—é“ºçš„å•†å“ï¼‰

**æµç¨‹ï¼š**
1. éªŒè¯å•†å“åœ¨å”®ã€åº“å­˜å……è¶³
2. è®¡ç®—æ€»é‡‘é¢å’Œå¹³å°è´¹
3. ç§¯åˆ†æŠµæ‰£ï¼ˆå¦‚æœ‰ï¼‰
4. é”å®šèµ„é‡‘åˆ°æ‰˜ç®¡
5. æ‰£å‡åº“å­˜

### 2. cancel_order

å–æ¶ˆè®¢å•ï¼ˆé€€æ¬¾ç»™ä¹°å®¶ï¼‰ã€‚

```rust
fn cancel_order(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…ä¹°å®¶
**å‰æï¼š** è®¢å•çŠ¶æ€ä¸º Created æˆ– Paidï¼ˆæœªå‘è´§ï¼‰
**é™åˆ¶ï¼š** âŒ æ•°å­—å•†å“ä¸å¯å–æ¶ˆ

### 3. ship_order

å‘è´§ï¼ˆå¡«å†™ç‰©æµä¿¡æ¯ï¼‰ã€‚

```rust
fn ship_order(
    origin: OriginFor<T>,
    order_id: u64,
    tracking_cid: Vec<u8>,
) -> DispatchResult
```

**æƒé™ï¼š** ä»…å–å®¶
**å‰æï¼š** è®¢å•çŠ¶æ€ä¸º Paid

### 4. confirm_receipt

ç¡®è®¤æ”¶è´§ï¼ˆé‡Šæ”¾èµ„é‡‘ç»™å–å®¶ï¼‰ã€‚

```rust
fn confirm_receipt(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…ä¹°å®¶
**å‰æï¼š** è®¢å•çŠ¶æ€ä¸º Shipped

**èµ„é‡‘åˆ†é…ï¼š**
- å–å®¶æ”¶åˆ°ï¼šæ€»é‡‘é¢ - å¹³å°è´¹
- å¹³å°æ”¶åˆ°ï¼šå¹³å°è´¹

### 5. request_refund

ç”³è¯·é€€æ¬¾ã€‚

```rust
fn request_refund(
    origin: OriginFor<T>,
    order_id: u64,
    reason_cid: Vec<u8>,
) -> DispatchResult
```

**æƒé™ï¼š** ä»…ä¹°å®¶
**å‰æï¼š** è®¢å•çŠ¶æ€ä¸º Paid æˆ– Shipped
**é™åˆ¶ï¼š** âŒ æ•°å­—å•†å“ä¸å¯é€€æ¬¾

### 6. approve_refund

åŒæ„é€€æ¬¾ï¼ˆå–å®¶ï¼‰ã€‚

```rust
fn approve_refund(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…å–å®¶
**å‰æï¼š** è®¢å•çŠ¶æ€ä¸º Disputed

### 7. start_serviceï¼ˆæœåŠ¡ç±»è®¢å•ï¼‰

å¼€å§‹æœåŠ¡ï¼ˆå–å®¶ï¼‰ã€‚

```rust
fn start_service(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…å–å®¶
**å‰æï¼š** æœåŠ¡ç±»è®¢å•ï¼ŒçŠ¶æ€ä¸º Paid

### 8. complete_serviceï¼ˆæœåŠ¡ç±»è®¢å•ï¼‰

æ ‡è®°æœåŠ¡å®Œæˆï¼ˆå–å®¶ï¼‰ã€‚

```rust
fn complete_service(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…å–å®¶
**å‰æï¼š** æœåŠ¡ç±»è®¢å•ï¼ŒçŠ¶æ€ä¸º Shippedï¼ˆæœåŠ¡è¿›è¡Œä¸­ï¼‰

### 9. confirm_serviceï¼ˆæœåŠ¡ç±»è®¢å•ï¼‰

ç¡®è®¤æœåŠ¡å®Œæˆï¼ˆä¹°å®¶ï¼‰ã€‚

```rust
fn confirm_service(origin: OriginFor<T>, order_id: u64) -> DispatchResult
```

**æƒé™ï¼š** ä»…ä¹°å®¶
**å‰æï¼š** æœåŠ¡ç±»è®¢å•ï¼Œå–å®¶å·²æ ‡è®°æœåŠ¡å®Œæˆ

## ğŸ“¡ Events

| äº‹ä»¶ | è¯´æ˜ | å­—æ®µ |
|------|------|------|
| `OrderCreated` | è®¢å•å·²åˆ›å»º | `order_id`, `buyer`, `seller`, `amount` |
| `OrderPaid` | è®¢å•å·²æ”¯ä»˜ | `order_id`, `escrow_id` |
| `OrderShipped` | è®¢å•å·²å‘è´§ | `order_id` |
| `OrderCompleted` | è®¢å•å·²å®Œæˆ | `order_id`, `seller_received` |
| `OrderCancelled` | è®¢å•å·²å–æ¶ˆ | `order_id` |
| `OrderRefunded` | è®¢å•å·²é€€æ¬¾ | `order_id`, `amount` |
| `OrderDisputed` | è®¢å•è¿›å…¥äº‰è®® | `order_id` |
| `ServiceStarted` | æœåŠ¡å·²å¼€å§‹ | `order_id` |
| `ServiceCompleted` | æœåŠ¡å·²å®Œæˆ | `order_id` |

## âŒ Errors

| é”™è¯¯ | è¯´æ˜ |
|------|------|
| `OrderNotFound` | è®¢å•ä¸å­˜åœ¨ |
| `ProductNotFound` | å•†å“ä¸å­˜åœ¨ |
| `ShopNotFound` | åº—é“ºä¸å­˜åœ¨ |
| `NotOrderBuyer` | ä¸æ˜¯è®¢å•ä¹°å®¶ |
| `NotOrderSeller` | ä¸æ˜¯è®¢å•å–å®¶ |
| `InvalidOrderStatus` | æ— æ•ˆçš„è®¢å•çŠ¶æ€ |
| `CannotCancelOrder` | æ— æ³•å–æ¶ˆè®¢å• |
| `CannotBuyOwnProduct` | ä¸èƒ½è´­ä¹°è‡ªå·±åº—é“ºçš„å•†å“ |
| `ProductNotOnSale` | å•†å“ä¸åœ¨å”® |
| `InsufficientStock` | åº“å­˜ä¸è¶³ |
| `CidTooLong` | CID è¿‡é•¿ |
| `Overflow` | æ•°å€¼æº¢å‡º |
| `DigitalProductCannotCancel` | æ•°å­—å•†å“ä¸å¯å–æ¶ˆ |
| `DigitalProductCannotRefund` | æ•°å­—å•†å“ä¸å¯é€€æ¬¾ |
| `NotServiceOrder` | éæœåŠ¡ç±»è®¢å• |

## â° è¶…æ—¶è‡ªåŠ¨å¤„ç†

æ¨¡å—åœ¨ `on_idle` hook ä¸­è‡ªåŠ¨å¤„ç†è¶…æ—¶è®¢å•ï¼š

| åœºæ™¯ | è§¦å‘æ¡ä»¶ | è‡ªåŠ¨å¤„ç† |
|------|----------|----------|
| **å‘è´§è¶…æ—¶** | å®ç‰©å•†å“æ”¯ä»˜åè¶…è¿‡ `ShipTimeout` æœªå‘è´§ | è‡ªåŠ¨é€€æ¬¾ç»™ä¹°å®¶ |
| **ç¡®è®¤è¶…æ—¶** | å®ç‰©å•†å“å‘è´§åè¶…è¿‡ `ConfirmTimeout` æœªç¡®è®¤ | è‡ªåŠ¨ç¡®è®¤æ”¶è´§ |
| **æœåŠ¡ç¡®è®¤è¶…æ—¶** | æœåŠ¡ç±»å•†å“å®Œæˆåè¶…è¿‡ `ServiceConfirmTimeout` æœªç¡®è®¤ | è‡ªåŠ¨ç¡®è®¤æœåŠ¡ |

## ğŸ’¡ è®¢å•ç”Ÿå‘½å‘¨æœŸ

### Digitalï¼ˆæ•°å­—å•†å“ï¼‰

```
ä¸‹å•æ”¯ä»˜ â†’ è‡ªåŠ¨å®Œæˆ
    â””â”€â”€ place_order() â†’ çŠ¶æ€: Completed
        â”œâ”€â”€ èµ„é‡‘ç«‹å³é‡Šæ”¾ç»™å–å®¶
        â””â”€â”€ âŒ ä¸å¯å–æ¶ˆã€ä¸å¯é€€æ¬¾
```

### Physicalï¼ˆå®ç‰©å•†å“ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®ç‰©å•†å“è®¢å•ç”Ÿå‘½å‘¨æœŸ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ä¸‹å•æ”¯ä»˜                                                     â”‚
â”‚     â””â”€â”€ place_order() â†’ çŠ¶æ€: Paid                              â”‚
â”‚         â””â”€â”€ èµ„é‡‘é”å®šåˆ°æ‰˜ç®¡                                       â”‚
â”‚                                                                 â”‚
â”‚  2. å–æ¶ˆè®¢å•ï¼ˆå¯é€‰ï¼‰                                             â”‚
â”‚     â””â”€â”€ cancel_order() â†’ çŠ¶æ€: Cancelled                        â”‚
â”‚         â””â”€â”€ é€€æ¬¾ç»™ä¹°å®¶                                           â”‚
â”‚                                                                 â”‚
â”‚  3. å‘è´§                                                         â”‚
â”‚     â””â”€â”€ ship_order() â†’ çŠ¶æ€: Shipped                            â”‚
â”‚                                                                 â”‚
â”‚  4. ç¡®è®¤æ”¶è´§                                                     â”‚
â”‚     â””â”€â”€ confirm_receipt() â†’ çŠ¶æ€: Completed                     â”‚
â”‚         â””â”€â”€ èµ„é‡‘é‡Šæ”¾ç»™å–å®¶                                       â”‚
â”‚                                                                 â”‚
â”‚  5. è¶…æ—¶å¤„ç†                                                     â”‚
â”‚     â”œâ”€â”€ å‘è´§è¶…æ—¶ â†’ çŠ¶æ€: Refundedï¼ˆè‡ªåŠ¨é€€æ¬¾ï¼‰                   â”‚
â”‚     â””â”€â”€ ç¡®è®¤è¶…æ—¶ â†’ çŠ¶æ€: Completedï¼ˆè‡ªåŠ¨ç¡®è®¤ï¼‰                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Serviceï¼ˆæœåŠ¡ç±»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡ç±»è®¢å•ç”Ÿå‘½å‘¨æœŸ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. ä¸‹å•æ”¯ä»˜                                                     â”‚
â”‚     â””â”€â”€ place_order() â†’ çŠ¶æ€: Paid                              â”‚
â”‚         â””â”€â”€ èµ„é‡‘é”å®šåˆ°æ‰˜ç®¡                                       â”‚
â”‚                                                                 â”‚
â”‚  2. å¼€å§‹æœåŠ¡                                                     â”‚
â”‚     â””â”€â”€ start_service() â†’ çŠ¶æ€: Shippedï¼ˆæœåŠ¡è¿›è¡Œä¸­ï¼‰           â”‚
â”‚                                                                 â”‚
â”‚  3. æ ‡è®°æœåŠ¡å®Œæˆ                                                 â”‚
â”‚     â””â”€â”€ complete_service() â†’ è®°å½•å®Œæˆæ—¶é—´                       â”‚
â”‚                                                                 â”‚
â”‚  4. ç¡®è®¤æœåŠ¡                                                     â”‚
â”‚     â””â”€â”€ confirm_service() â†’ çŠ¶æ€: Completed                     â”‚
â”‚         â””â”€â”€ èµ„é‡‘é‡Šæ”¾ç»™å–å®¶                                       â”‚
â”‚                                                                 â”‚
â”‚  5. è¶…æ—¶å¤„ç†                                                     â”‚
â”‚     â””â”€â”€ æœåŠ¡ç¡®è®¤è¶…æ—¶ â†’ çŠ¶æ€: Completedï¼ˆè‡ªåŠ¨ç¡®è®¤ï¼‰              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”Œ OrderProvider Trait

æœ¬æ¨¡å—å®ç°äº† `OrderProvider` traitï¼Œä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ï¼š

```rust
pub trait OrderProvider<AccountId, Balance> {
    fn order_exists(order_id: u64) -> bool;
    fn order_buyer(order_id: u64) -> Option<AccountId>;
    fn order_shop_id(order_id: u64) -> Option<u64>;
    fn is_order_completed(order_id: u64) -> bool;
}
```

## ğŸ ç§¯åˆ†æŠµæ‰£

ä¸‹å•æ—¶å¯ä½¿ç”¨åº—é“ºç§¯åˆ†æŠµæ‰£è®¢å•é‡‘é¢ï¼š

```rust
// ä¸‹å•æ—¶ä¼ å…¥ use_tokens å‚æ•°
api.tx.shareMallOrder.placeOrder(
    product_id,
    quantity,
    shipping_cid,
    Some(100_000_000_000)  // ä½¿ç”¨ 100 ç§¯åˆ†æŠµæ‰£
)
```

**æµç¨‹ï¼š**
1. æ£€æŸ¥åº—é“ºæ˜¯å¦å¯ç”¨ç§¯åˆ†
2. è°ƒç”¨ `ShopToken::redeem_for_discount()` å…‘æ¢æŠµæ‰£é‡‘é¢
3. å®é™…æ”¯ä»˜é‡‘é¢ = æ€»é‡‘é¢ - ç§¯åˆ†æŠµæ‰£

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
cargo test -p pallet-sharemall-order

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test -p pallet-sharemall-order test_place_order
```

## ğŸ“œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v0.1.0 | 2026-01-31 | ä» pallet-mall æ‹†åˆ† |

## ğŸ“„ è®¸å¯è¯

MIT License
