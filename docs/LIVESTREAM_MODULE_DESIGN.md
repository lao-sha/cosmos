# Stardust ç›´æ’­é—´æ¨¡å—æ¶æ„è®¾è®¡

## æ¦‚è¿°

ç›´æ’­é—´æ¨¡å— (`pallet-livestream`) ä¸º Stardust å¹³å°æä¾›å»ä¸­å¿ƒåŒ–ç›´æ’­åŠŸèƒ½ï¼Œæ”¯æŒä¸»æ’­å¼€æ’­ã€è§‚ä¼—äº’åŠ¨ã€ç¤¼ç‰©æ‰“èµç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend (React Native)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç›´æ’­æ’­æ”¾å™¨   â”‚  â”‚ å¼¹å¹•/èŠå¤©   â”‚  â”‚ ç¤¼ç‰©/æ‰“èµé¢æ¿           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                     â”‚
          â–¼                â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Media Server (é“¾ä¸‹)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ WebRTC SFU  â”‚  â”‚ HLS/DASH    â”‚  â”‚ å¼¹å¹•æœåŠ¡ (WebSocket)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                     â”‚
          â–¼                â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Substrate Blockchain                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                   pallet-livestream                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚ ç›´æ’­é—´ç®¡ç† â”‚ â”‚ è§‚ä¼—ç®¡ç†  â”‚ â”‚ ç¤¼ç‰©ç³»ç»Ÿ  â”‚ â”‚ æ”¶ç›Šåˆ†é…    â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ pallet-tips â”‚ â”‚pallet-escrowâ”‚ â”‚ pallet-stardust-ipfs        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—ç›®å½•ç»“æ„

```
pallets/livestream/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ README.md
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs           # ä¸»æ¨¡å—å…¥å£
â”‚   â”œâ”€â”€ types.rs         # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ weights.rs       # æƒé‡å®šä¹‰
â”‚   â”œâ”€â”€ mock.rs          # æµ‹è¯•mock
â”‚   â””â”€â”€ tests.rs         # å•å…ƒæµ‹è¯•
```

## æ ¸å¿ƒç±»å‹å®šä¹‰

### ç›´æ’­é—´çŠ¶æ€

```rust
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub enum LiveRoomStatus {
    /// å‡†å¤‡ä¸­ï¼ˆæœªå¼€æ’­ï¼‰
    Preparing,
    /// ç›´æ’­ä¸­
    Live,
    /// æš‚åœä¸­
    Paused,
    /// å·²ç»“æŸ
    Ended,
    /// è¢«å°ç¦
    Banned,
}
```

### ç›´æ’­é—´ç±»å‹

```rust
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub enum LiveRoomType {
    /// æ™®é€šç›´æ’­
    Normal,
    /// ä»˜è´¹ç›´æ’­ï¼ˆéœ€è´­ç¥¨ï¼‰
    Paid,
    /// ç§å¯†ç›´æ’­ï¼ˆä»…é‚€è¯·ï¼‰
    Private,
    /// è¿éº¦ç›´æ’­
    MultiHost,
}
```

### ç›´æ’­é—´ä¿¡æ¯

```rust
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct LiveRoom<AccountId, BoundedTitle, BoundedDescription, Balance> {
    /// ç›´æ’­é—´IDï¼ˆè‡ªå¢ï¼‰
    pub id: u64,
    /// ä¸»æ’­è´¦æˆ·
    pub host: AccountId,
    /// ç›´æ’­é—´æ ‡é¢˜
    pub title: BoundedTitle,
    /// ç›´æ’­é—´æè¿°
    pub description: Option<BoundedDescription>,
    /// ç›´æ’­é—´ç±»å‹
    pub room_type: LiveRoomType,
    /// ç›´æ’­é—´çŠ¶æ€
    pub status: LiveRoomStatus,
    /// å°é¢å›¾CID (IPFS)
    pub cover_cid: Option<BoundedVec<u8, MaxCidLen>>,
    /// ç´¯è®¡è§‚ä¼—æ•°ï¼ˆç›´æ’­ç»“æŸæ—¶ä» LiveKit åŒæ­¥ï¼‰
    pub total_viewers: u64,
    /// å³°å€¼è§‚ä¼—æ•°
    pub peak_viewers: u32,
    /// ç´¯è®¡ç¤¼ç‰©æ”¶å…¥
    pub total_gifts: Balance,
    /// ä»˜è´¹ç›´æ’­ç¥¨ä»·ï¼ˆä»…Paidç±»å‹ï¼‰
    pub ticket_price: Option<Balance>,
    /// åˆ›å»ºæ—¶é—´
    pub created_at: u64,
    /// å¼€æ’­æ—¶é—´
    pub started_at: Option<u64>,
    /// ç»“æŸæ—¶é—´
    pub ended_at: Option<u64>,
    // æ³¨æ„: ä¸å­˜å‚¨ stream_keyï¼Œæ”¹ç”¨ç­¾åéªŒè¯æœºåˆ¶
}
```

> **å®‰å…¨è®¾è®¡**: ä¸åœ¨é“¾ä¸Šå­˜å‚¨ `stream_key`ï¼Œä¸»æ’­æ¨æµæ—¶é€šè¿‡ç§é’¥ç­¾åéªŒè¯èº«ä»½ï¼Œé˜²æ­¢ä»»ä½•äººè¯»å–é“¾ä¸Šæ•°æ®åå†’å……ä¸»æ’­æ¨æµã€‚

### ç¤¼ç‰©å®šä¹‰

```rust
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct Gift<Balance> {
    /// ç¤¼ç‰©ID
    pub id: u32,
    /// ç¤¼ç‰©åç§°
    pub name: BoundedVec<u8, MaxGiftNameLen>,
    /// ç¤¼ç‰©ä»·æ ¼
    pub price: Balance,
    /// ç¤¼ç‰©å›¾æ ‡CID
    pub icon_cid: BoundedVec<u8, MaxCidLen>,
    /// æ˜¯å¦å¯ç”¨
    pub enabled: bool,
}

/// ç¤¼ç‰©è®°å½•
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct GiftRecord<AccountId, Balance> {
    /// é€ç¤¼è€…
    pub sender: AccountId,
    /// æ¥æ”¶è€…ï¼ˆä¸»æ’­ï¼‰
    pub receiver: AccountId,
    /// ç›´æ’­é—´ID
    pub room_id: u64,
    /// ç¤¼ç‰©ID
    pub gift_id: u32,
    /// æ•°é‡
    pub quantity: u32,
    /// æ€»ä»·å€¼
    pub total_value: Balance,
    /// æ—¶é—´æˆ³
    pub timestamp: u64,
}
```

### è§‚ä¼—ä¿¡æ¯ï¼ˆé“¾ä¸‹ç®¡ç†ï¼‰

> **è®¾è®¡å˜æ›´**: è§‚ä¼—ä¿¡æ¯ä¸å†å­˜å‚¨åœ¨é“¾ä¸Šï¼Œæ”¹ä¸ºé€šè¿‡ LiveKit ç®¡ç†ã€‚é“¾ä¸Šåªå­˜å‚¨ä»˜è´¹ç›´æ’­çš„é—¨ç¥¨è´­ä¹°è®°å½•å’Œé»‘åå•ã€‚

```rust
// è§‚ä¼—å®æ—¶çŠ¶æ€ç”± LiveKit ç®¡ç†ï¼Œä¸å­˜å‚¨åœ¨é“¾ä¸Š
// é“¾ä¸Šåªè®°å½•ä»¥ä¸‹ä¿¡æ¯:

/// ä»˜è´¹ç›´æ’­é—¨ç¥¨è´­ä¹°è®°å½•
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct Ticket<AccountId> {
    /// è´­ä¹°è€…
    pub buyer: AccountId,
    /// ç›´æ’­é—´ID
    pub room_id: u64,
    /// è´­ä¹°æ—¶é—´
    pub purchased_at: u64,
}
```

## å­˜å‚¨è®¾è®¡

> **è®¾è®¡åŸåˆ™**: æœ€å°åŒ–é“¾ä¸Šå­˜å‚¨ï¼Œè§‚ä¼—ç®¡ç†ã€èŠå¤©ã€å¼¹å¹•ç­‰é«˜é¢‘æ“ä½œå…¨éƒ¨é“¾ä¸‹å¤„ç†ã€‚é“¾ä¸Šåªå­˜å‚¨å¿…è¦çš„çŠ¶æ€å’Œèµ„é‡‘ç›¸å…³æ•°æ®ã€‚

```rust
/// ç›´æ’­é—´ä¿¡æ¯
#[pallet::storage]
pub type LiveRooms<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // room_id
    LiveRoom<T::AccountId, BoundedTitle, BoundedDescription, BalanceOf<T>>,
>;

/// ä¸»æ’­çš„ç›´æ’­é—´ï¼ˆä¸€ä¸ªä¸»æ’­åªèƒ½æœ‰ä¸€ä¸ªæ´»è·ƒç›´æ’­é—´ï¼‰
#[pallet::storage]
pub type HostRoom<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,  // host
    u64,           // room_id
>;

/// ä¸‹ä¸€ä¸ªç›´æ’­é—´IDï¼ˆè‡ªå¢ï¼‰
#[pallet::storage]
pub type NextRoomId<T: Config> = StorageValue<_, u64, ValueQuery>;

/// ç¤¼ç‰©å®šä¹‰
#[pallet::storage]
pub type Gifts<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u32,  // gift_id
    Gift<BalanceOf<T>>,
>;

/// ç”¨æˆ·åœ¨ç›´æ’­é—´çš„ç´¯è®¡æ‰“èµ
#[pallet::storage]
pub type UserRoomGifts<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,           // room_id
    Blake2_128Concat,
    T::AccountId,  // user
    BalanceOf<T>,  // total_gifted
>;

/// ä¸»æ’­ç´¯è®¡æ”¶å…¥
#[pallet::storage]
pub type HostEarnings<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,  // host
    BalanceOf<T>,  // total_earnings
    ValueQuery,
>;

/// ä»˜è´¹ç›´æ’­é—¨ç¥¨æŒæœ‰è€…
#[pallet::storage]
pub type TicketHolders<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,           // room_id
    Blake2_128Concat,
    T::AccountId,  // buyer
    u64,           // purchase_time
>;

/// ç›´æ’­é—´é»‘åå•ï¼ˆè¢«è¸¢å‡ºçš„ç”¨æˆ·ï¼‰
#[pallet::storage]
pub type RoomBlacklist<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,           // room_id
    Blake2_128Concat,
    T::AccountId,  // banned_user
    (),
>;

/// å½“å‰è¿éº¦è€…åˆ—è¡¨ï¼ˆç®€åŒ–å­˜å‚¨ï¼‰
#[pallet::storage]
pub type ActiveCoHosts<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // room_id
    BoundedVec<T::AccountId, T::MaxCoHostsPerRoom>,
    ValueQuery,
>;
```

### å·²åˆ é™¤çš„å­˜å‚¨ï¼ˆæ”¹ä¸ºé“¾ä¸‹æˆ–äº‹ä»¶è®°å½•ï¼‰

| åŸå­˜å‚¨ | å¤„ç†æ–¹å¼ | åŸå›  |
|--------|----------|------|
| `RoomViewers` | é“¾ä¸‹ LiveKit | 10000è§‚ä¼—å­˜é“¾ä¸Šä¼šå¯¼è‡´å­˜å‚¨çˆ†ç‚¸ |
| `GiftRecords` | äº‹ä»¶è®°å½• | å†å²è®°å½•é€šè¿‡äº‹ä»¶ç´¢å¼•æŸ¥è¯¢ |
| `CoHostRequests` | é“¾ä¸‹ DataChannel | ç”³è¯·æµç¨‹æ— éœ€ä¸Šé“¾ |

## å¯è°ƒç”¨å‡½æ•° (Extrinsics)

### ç›´æ’­é—´ç®¡ç†

```rust
/// åˆ›å»ºç›´æ’­é—´
#[pallet::call_index(0)]
pub fn create_room(
    origin: OriginFor<T>,
    title: Vec<u8>,
    description: Option<Vec<u8>>,
    room_type: LiveRoomType,
    cover_cid: Option<Vec<u8>>,
    ticket_price: Option<BalanceOf<T>>,
) -> DispatchResult;

/// å¼€å§‹ç›´æ’­
#[pallet::call_index(1)]
pub fn start_live(
    origin: OriginFor<T>,
    room_id: u64,
) -> DispatchResult;

/// æš‚åœç›´æ’­
#[pallet::call_index(2)]
pub fn pause_live(
    origin: OriginFor<T>,
    room_id: u64,
) -> DispatchResult;

/// æ¢å¤ç›´æ’­
#[pallet::call_index(3)]
pub fn resume_live(
    origin: OriginFor<T>,
    room_id: u64,
) -> DispatchResult;

/// ç»“æŸç›´æ’­
#[pallet::call_index(4)]
pub fn end_live(
    origin: OriginFor<T>,
    room_id: u64,
) -> DispatchResult;

/// æ›´æ–°ç›´æ’­é—´ä¿¡æ¯
#[pallet::call_index(5)]
pub fn update_room(
    origin: OriginFor<T>,
    room_id: u64,
    title: Option<Vec<u8>>,
    description: Option<Vec<u8>>,
    cover_cid: Option<Vec<u8>>,
) -> DispatchResult;
```

### è§‚ä¼—æ“ä½œ

> **è®¾è®¡å˜æ›´**: `join_room` å’Œ `leave_room` å·²ç§»è‡³é“¾ä¸‹ï¼ˆç›´æ¥è¿æ¥/æ–­å¼€ LiveKitï¼‰ã€‚é“¾ä¸Šåªä¿ç•™ä»˜è´¹ç›´æ’­è´­ç¥¨åŠŸèƒ½ã€‚

```rust
/// è´­ä¹°ä»˜è´¹ç›´æ’­é—¨ç¥¨
#[pallet::call_index(10)]
pub fn buy_ticket(
    origin: OriginFor<T>,
    room_id: u64,
) -> DispatchResult;
```

### ç¤¼ç‰©ç³»ç»Ÿ

```rust
/// å‘é€ç¤¼ç‰©ï¼ˆå«é˜²æº¢å‡ºå’ŒçŠ¶æ€æ£€æŸ¥ï¼‰
#[pallet::call_index(20)]
pub fn send_gift(
    origin: OriginFor<T>,
    room_id: u64,
    gift_id: u32,
    quantity: u32,
) -> DispatchResult {
    let sender = ensure_signed(origin)?;

    // 1. æ£€æŸ¥ç›´æ’­é—´çŠ¶æ€
    let mut room = LiveRooms::<T>::get(room_id).ok_or(Error::<T>::RoomNotFound)?;
    ensure!(room.status == LiveRoomStatus::Live, Error::<T>::RoomNotLive);

    // 2. æ£€æŸ¥ç¤¼ç‰©å­˜åœ¨ä¸”å¯ç”¨
    let gift = Gifts::<T>::get(gift_id).ok_or(Error::<T>::GiftNotFound)?;
    ensure!(gift.enabled, Error::<T>::GiftDisabled);

    // 3. è®¡ç®—æ€»ä»·ï¼ˆé˜²æº¢å‡ºï¼‰
    let total = gift.price
        .checked_mul(&quantity.into())
        .ok_or(Error::<T>::Overflow)?;

    // 4. è®¡ç®—åˆ†æˆ
    let platform_fee = total.saturating_mul(T::PlatformFeePercent::get().into()) / 100u32.into();
    let host_amount = total.saturating_sub(platform_fee);

    // 5. è½¬è´¦ç»™ä¸»æ’­
    T::Currency::transfer(&sender, &room.host, host_amount, ExistenceRequirement::KeepAlive)?;

    // 6. è½¬è´¦ç»™å›½åº“
    T::Currency::transfer(&sender, &T::TreasuryAccount::get(), platform_fee, ExistenceRequirement::KeepAlive)?;

    // 7. æ›´æ–°ç»Ÿè®¡
    room.total_gifts = room.total_gifts.saturating_add(total);
    LiveRooms::<T>::insert(room_id, room.clone());

    HostEarnings::<T>::mutate(&room.host, |e| *e = e.saturating_add(host_amount));
    UserRoomGifts::<T>::mutate(room_id, &sender, |g| *g = g.saturating_add(total));

    // 8. å‘å‡ºäº‹ä»¶ï¼ˆæ›¿ä»£å­˜å‚¨è®°å½•ï¼‰
    Self::deposit_event(Event::GiftSent {
        room_id,
        sender: sender.clone(),
        receiver: room.host,
        gift_id,
        quantity,
        value: total,
    });

    Ok(())
}

/// ä¸»æ’­æç°æ”¶ç›Š
#[pallet::call_index(21)]
pub fn withdraw_earnings(
    origin: OriginFor<T>,
    amount: BalanceOf<T>,
) -> DispatchResult;

/// åŒæ­¥ç›´æ’­ç»Ÿè®¡æ•°æ®ï¼ˆç›´æ’­ç»“æŸæ—¶ç”±åç«¯è°ƒç”¨ï¼‰
#[pallet::call_index(22)]
pub fn sync_live_stats(
    origin: OriginFor<T>,
    room_id: u64,
    total_viewers: u64,
    peak_viewers: u32,
) -> DispatchResult;
```

### ç®¡ç†åŠŸèƒ½

> **è®¾è®¡å˜æ›´**: ç¦è¨€åŠŸèƒ½ç§»è‡³é“¾ä¸‹ï¼ˆé€šè¿‡ LiveKit æƒé™æ§åˆ¶ï¼‰ã€‚é“¾ä¸Šåªä¿ç•™é»‘åå•å’Œå°ç¦åŠŸèƒ½ã€‚

```rust
/// è¸¢å‡ºè§‚ä¼—å¹¶åŠ å…¥é»‘åå•ï¼ˆä¸»æ’­ï¼‰
#[pallet::call_index(30)]
pub fn kick_viewer(
    origin: OriginFor<T>,
    room_id: u64,
    viewer: T::AccountId,
) -> DispatchResult;

/// ä»é»‘åå•ç§»é™¤
#[pallet::call_index(31)]
pub fn remove_from_blacklist(
    origin: OriginFor<T>,
    room_id: u64,
    viewer: T::AccountId,
) -> DispatchResult;

/// å°ç¦ç›´æ’­é—´ï¼ˆç®¡ç†å‘˜ï¼‰
#[pallet::call_index(40)]
pub fn ban_room(
    origin: OriginFor<T>,
    room_id: u64,
    reason: Vec<u8>,
) -> DispatchResult;
```

### è¿éº¦åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰

> **è®¾è®¡å˜æ›´**: è¿éº¦ç”³è¯·/åŒæ„/æ‹’ç»æµç¨‹ç§»è‡³é“¾ä¸‹ï¼ˆé€šè¿‡ DataChannelï¼‰ã€‚é“¾ä¸Šåªè®°å½•è¿éº¦å¼€å§‹å’Œç»“æŸã€‚

```rust
/// å¼€å§‹è¿éº¦ï¼ˆä¸»æ’­è°ƒç”¨ï¼Œè®°å½•è¿éº¦è€…ï¼‰
#[pallet::call_index(50)]
pub fn start_co_host(
    origin: OriginFor<T>,
    room_id: u64,
    co_host: T::AccountId,
) -> DispatchResult;

/// ç»“æŸè¿éº¦ï¼ˆä¸»æ’­æˆ–è¿éº¦è€…è°ƒç”¨ï¼‰
#[pallet::call_index(51)]
pub fn end_co_host(
    origin: OriginFor<T>,
    room_id: u64,
    co_host: Option<T::AccountId>,  // None = è‡ªå·±é€€å‡º
) -> DispatchResult;
```

## äº‹ä»¶å®šä¹‰

> **è®¾è®¡åŸåˆ™**: äº‹ä»¶ç”¨äºæ›¿ä»£é“¾ä¸Šå­˜å‚¨è®°å½•ï¼Œå‰ç«¯/ç´¢å¼•å™¨é€šè¿‡ç›‘å¬äº‹ä»¶è·å–å†å²æ•°æ®ã€‚

```rust
#[pallet::event]
pub enum Event<T: Config> {
    /// ç›´æ’­é—´å·²åˆ›å»º
    RoomCreated { host: T::AccountId, room_id: u64 },
    /// ç›´æ’­å·²å¼€å§‹
    LiveStarted { room_id: u64, started_at: u64 },
    /// ç›´æ’­å·²æš‚åœ
    LivePaused { room_id: u64 },
    /// ç›´æ’­å·²æ¢å¤
    LiveResumed { room_id: u64 },
    /// ç›´æ’­å·²ç»“æŸï¼ˆå«ç»Ÿè®¡æ•°æ®ï¼‰
    LiveEnded {
        room_id: u64,
        duration: u64,
        total_viewers: u64,
        peak_viewers: u32,
        total_gifts: BalanceOf<T>,
    },
    /// é—¨ç¥¨å·²è´­ä¹°
    TicketPurchased { room_id: u64, buyer: T::AccountId, price: BalanceOf<T> },
    /// ç¤¼ç‰©å·²å‘é€ï¼ˆæ›¿ä»£ GiftRecords å­˜å‚¨ï¼‰
    GiftSent {
        room_id: u64,
        sender: T::AccountId,
        receiver: T::AccountId,
        gift_id: u32,
        quantity: u32,
        value: BalanceOf<T>,
    },
    /// æ”¶ç›Šå·²æç°
    EarningsWithdrawn { host: T::AccountId, amount: BalanceOf<T> },
    /// è§‚ä¼—è¢«è¸¢å‡ºï¼ˆåŠ å…¥é»‘åå•ï¼‰
    ViewerKicked { room_id: u64, viewer: T::AccountId },
    /// è§‚ä¼—ä»é»‘åå•ç§»é™¤
    ViewerUnbanned { room_id: u64, viewer: T::AccountId },
    /// ç›´æ’­é—´è¢«å°ç¦
    RoomBanned { room_id: u64, reason: Vec<u8> },
    /// è¿éº¦å·²å¼€å§‹
    CoHostStarted { room_id: u64, co_host: T::AccountId },
    /// è¿éº¦å·²ç»“æŸ
    CoHostEnded { room_id: u64, co_host: T::AccountId, duration: u64 },
}
```

## é…ç½®å‚æ•°

```rust
#[pallet::config]
pub trait Config: frame_system::Config {
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;

    /// è´§å¸ç±»å‹
    type Currency: ReservableCurrency<Self::AccountId>;

    /// æ—¶é—´æœåŠ¡
    type TimeProvider: UnixTime;

    /// ç›´æ’­é—´æ ‡é¢˜æœ€å¤§é•¿åº¦
    #[pallet::constant]
    type MaxTitleLen: Get<u32>;  // å»ºè®®: 100

    /// ç›´æ’­é—´æè¿°æœ€å¤§é•¿åº¦
    #[pallet::constant]
    type MaxDescriptionLen: Get<u32>;  // å»ºè®®: 500

    /// CIDæœ€å¤§é•¿åº¦
    #[pallet::constant]
    type MaxCidLen: Get<u32>;  // å»ºè®®: 64

    /// ç¤¼ç‰©åç§°æœ€å¤§é•¿åº¦
    #[pallet::constant]
    type MaxGiftNameLen: Get<u32>;  // å»ºè®®: 32

    /// æœ€å¤§è¿éº¦äººæ•°
    #[pallet::constant]
    type MaxCoHostsPerRoom: Get<u32>;  // å»ºè®®: 4

    /// å¹³å°æŠ½æˆæ¯”ä¾‹ (ç™¾åˆ†æ¯”)
    #[pallet::constant]
    type PlatformFeePercent: Get<u8>;  // å»ºè®®: 10-20%

    /// æœ€å°æç°é‡‘é¢
    #[pallet::constant]
    type MinWithdrawAmount: Get<BalanceOf<Self>>;

    /// åˆ›å»ºç›´æ’­é—´æŠ¼é‡‘
    #[pallet::constant]
    type RoomDeposit: Get<BalanceOf<Self>>;

    /// å›½åº“è´¦æˆ·
    #[pallet::constant]
    type TreasuryAccount: Get<Self::AccountId>;

    /// Pallet ID
    #[pallet::constant]
    type PalletId: Get<PalletId>;

    /// æƒé‡ä¿¡æ¯
    type WeightInfo: WeightInfo;
}
```

### å·²åˆ é™¤çš„é…ç½®é¡¹

| åŸé…ç½® | åŸå›  |
|--------|------|
| `MaxViewersPerRoom` | è§‚ä¼—ç®¡ç†ç§»è‡³é“¾ä¸‹ï¼Œæ— éœ€é™åˆ¶ |
| `MaxStreamKeyLen` | ä¸å†å­˜å‚¨ stream_key |
| `Randomness` | æ”¹ç”¨è‡ªå¢ IDï¼Œæ— éœ€éšæœºæ•° |

## æ”¶ç›Šåˆ†é…æœºåˆ¶

```
ç¤¼ç‰©æ”¶å…¥åˆ†é…:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·æ”¯ä»˜ç¤¼ç‰©é‡‘é¢               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»æ’­æ”¶ç›Š (80%) â”‚  â”‚ å¹³å°æŠ½æˆ (20%)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                         â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ å›½åº“ (70%)  â”‚          â”‚ æ¨èäºº (30%)â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸å…¶ä»–æ¨¡å—çš„é›†æˆ

### ä¸ pallet-tips é›†æˆ
- å¤ç”¨æ‰“èµé€»è¾‘
- å…±äº«æ”¶ç›Šåˆ†é…æœºåˆ¶

### ä¸ pallet-escrow é›†æˆ
- ä»˜è´¹ç›´æ’­é—¨ç¥¨æ‰˜ç®¡
- ä¸»æ’­æ”¶ç›Šæ‰˜ç®¡

### ä¸ pallet-stardust-ipfs é›†æˆ
- ç›´æ’­å°é¢å­˜å‚¨
- ç¤¼ç‰©å›¾æ ‡å­˜å‚¨
- ç›´æ’­å›æ”¾å­˜å‚¨

### ä¸ pallet-referral é›†æˆ
- æ¨èäººåˆ†æˆ
- é‚€è¯·å¥–åŠ±

## é“¾ä¸‹ç»„ä»¶

### åª’ä½“æœåŠ¡å™¨
ç›´æ’­æµåª’ä½“ä¼ è¾“ä¸é€‚åˆåœ¨é“¾ä¸Šå¤„ç†ï¼Œéœ€è¦é“¾ä¸‹åª’ä½“æœåŠ¡å™¨ï¼š

```
æ¨èæŠ€æœ¯æ ˆ:
- WebRTC SFU: mediasoup / Janus / LiveKit
- æµåª’ä½“åè®®: HLS / DASH / WebRTC
- å¼¹å¹•æœåŠ¡: WebSocket + Redis
- CDN: è¾¹ç¼˜èŠ‚ç‚¹åˆ†å‘
```

### é“¾ä¸Šé“¾ä¸‹äº¤äº’

```
1. ä¸»æ’­åˆ›å»ºç›´æ’­é—´ â†’ é“¾ä¸Šè®°å½• â†’ è¿”å› stream_key
2. ä¸»æ’­æ¨æµ â†’ åª’ä½“æœåŠ¡å™¨ (ä½¿ç”¨ stream_key éªŒè¯)
3. è§‚ä¼—è¿›å…¥ â†’ é“¾ä¸Šè®°å½• â†’ è·å–æ’­æ”¾åœ°å€
4. è§‚ä¼—é€ç¤¼ â†’ é“¾ä¸Šè½¬è´¦ â†’ è§¦å‘å¼¹å¹•ç‰¹æ•ˆ
5. ç›´æ’­ç»“æŸ â†’ é“¾ä¸Šè®°å½• â†’ å¯é€‰ä¿å­˜å›æ”¾åˆ° IPFS
```

## å®‰å…¨è€ƒè™‘

1. **é˜²åˆ·æœºåˆ¶**: é™åˆ¶åˆ›å»ºç›´æ’­é—´é¢‘ç‡ã€é€ç¤¼é¢‘ç‡
2. **æŠ¼é‡‘æœºåˆ¶**: åˆ›å»ºç›´æ’­é—´éœ€è¦æŠ¼é‡‘ï¼Œè¿è§„æ‰£é™¤
3. **æƒé™æ§åˆ¶**: åªæœ‰ä¸»æ’­å¯ä»¥ç®¡ç†è‡ªå·±çš„ç›´æ’­é—´
4. **é‡‘é¢éªŒè¯**: ç¤¼ç‰©é‡‘é¢ã€æç°é‡‘é¢éœ€è¦éªŒè¯
5. **çŠ¶æ€æ£€æŸ¥**: åªæœ‰ç›´æ’­ä¸­çš„æˆ¿é—´æ‰èƒ½é€ç¤¼

## åç»­æ‰©å±•

1. **è¿éº¦åŠŸèƒ½**: å¤šä¸»æ’­åŒæ—¶ç›´æ’­
2. **PKåŠŸèƒ½**: ä¸»æ’­é—´PKå¯¹æˆ˜
3. **ç›´æ’­å›æ”¾**: ä¿å­˜åˆ°IPFS
4. **ç›´æ’­é¢„çº¦**: é¢„çº¦å¼€æ’­é€šçŸ¥
5. **ç›´æ’­åˆ†ç±»**: æ¸¸æˆã€éŸ³ä¹ã€èŠå¤©ç­‰åˆ†ç±»
6. **ç²‰ä¸ç­‰çº§**: æ ¹æ®æ‰“èµç´¯è®¡å‡çº§
7. **å®ˆæŠ¤åŠŸèƒ½**: æœˆåº¦å®ˆæŠ¤ç‰¹æƒ

---

## åª’ä½“æœåŠ¡æ–¹æ¡ˆï¼šLiveKit

æœ¬é¡¹ç›®é€‰ç”¨ **LiveKit** ä½œä¸ºç›´æ’­åª’ä½“æœåŠ¡æ–¹æ¡ˆã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© LiveKit

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¼€æº** | å®Œå…¨å¼€æº (Apache 2.0)ï¼Œå¯éšæ—¶è¿ç§»è‡ªå»º |
| **æ— æœ€ä½æ¶ˆè´¹** | å…è´¹å¼€å§‹ï¼ŒæŒ‰é‡ä»˜è´¹ï¼Œé€‚åˆæ—©æœŸé¡¹ç›® |
| **å®šä»·é€æ˜** | $0.01/åˆ†é’Ÿï¼Œæ— éšè—è´¹ç”¨ |
| **ç°ä»£æ¶æ„** | Go è¯­è¨€ï¼Œäº‘åŸç”Ÿï¼Œæ”¯æŒ Kubernetes |
| **SDK å®Œå–„** | Web/iOS/Android/Flutter/React Native |
| **å†…ç½® DataChannel** | å¯ç›´æ¥å®ç°èŠå¤©/å¼¹å¹•ï¼Œæ— éœ€é¢å¤–æœåŠ¡ |

### éƒ¨ç½²æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šLiveKit Cloud (æ¨èæ—©æœŸä½¿ç”¨)

```
é›¶è¿ç»´ï¼ŒæŒ‰é‡ä»˜è´¹:

ä»·æ ¼:
â”œâ”€ è§†é¢‘: $0.01/åˆ†é’Ÿ/å‚ä¸è€…
â”œâ”€ éŸ³é¢‘: $0.004/åˆ†é’Ÿ/å‚ä¸è€…
â””â”€ å…è´¹é¢åº¦: 1000 åˆ†é’Ÿ/æœˆ

æˆæœ¬ä¼°ç®— (100è§‚ä¼—çœ‹1å°æ—¶):
100äºº Ã— 60åˆ†é’Ÿ Ã— $0.01 = $60/åœº
```

#### æ–¹æ¡ˆäºŒï¼šè‡ªå»º LiveKit Server

```yaml
# docker-compose.yml
version: '3.8'

services:
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    ports:
      - "7880:7880"
      - "7881:7881"
      - "7882:7882/udp"
      - "50000-50100:50000-50100/udp"
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

```yaml
# livekit.yaml
port: 7880
rtc:
  port_range_start: 50000
  port_range_end: 50100
  use_external_ip: true

redis:
  address: redis:6379

keys:
  APIxxxxxxx: secretxxxxxxx

turn:
  enabled: true
  udp_port: 3478
```

### å‰ç«¯é›†æˆ (React Native)

```bash
npm install @livekit/react-native @livekit/react-native-webrtc
```

#### ä¸»æ’­æ¨æµ

```typescript
import { Room } from 'livekit-client';

class LiveKitPublisher {
  private room: Room;

  async startPublishing(roomName: string, token: string) {
    this.room = new Room();
    await this.room.connect('wss://your-livekit-server.com', token);
    await this.room.localParticipant.enableCameraAndMicrophone();
  }

  async switchCamera() {
    const track = this.room.localParticipant.getTrackPublication('camera');
    if (track?.videoTrack) {
      await track.videoTrack.switchCamera();
    }
  }

  async toggleMute() {
    const enabled = this.room.localParticipant.isMicrophoneEnabled;
    await this.room.localParticipant.setMicrophoneEnabled(!enabled);
  }

  async stopPublishing() {
    await this.room.disconnect();
  }
}
```

#### è§‚ä¼—æ‹‰æµ

```typescript
import { Room, RoomEvent, Track } from 'livekit-client';

class LiveKitViewer {
  private room: Room;

  async startViewing(token: string, onVideoTrack: (track: Track) => void) {
    this.room = new Room();
    
    this.room.on(RoomEvent.TrackSubscribed, (track) => {
      if (track.kind === Track.Kind.Video) {
        onVideoTrack(track);
      }
    });

    await this.room.connect('wss://your-livekit-server.com', token);
  }

  async stopViewing() {
    await this.room.disconnect();
  }
}
```

### åç«¯ Token ç”Ÿæˆï¼ˆå«ç­¾åéªŒè¯ï¼‰

> **å®‰å…¨è®¾è®¡**: ä¸»æ’­æ¨æµå‰éœ€ç”¨ç§é’¥ç­¾åï¼Œåç«¯éªŒè¯ç­¾ååæ‰ç”Ÿæˆ LiveKit Tokenï¼Œé˜²æ­¢å†’å……æ¨æµã€‚

```typescript
import { AccessToken } from 'livekit-server-sdk';
import { signatureVerify, decodeAddress } from '@polkadot/util-crypto';
import { ApiPromise, WsProvider } from '@polkadot/api';

// è¿æ¥ Substrate èŠ‚ç‚¹
const api = await ApiPromise.create({ provider: new WsProvider('ws://localhost:9944') });

/**
 * éªŒè¯ä¸»æ’­èº«ä»½å¹¶ç”Ÿæˆæ¨æµ Token
 */
async function generatePublisherToken(
  roomId: string,
  publicKey: string,    // ä¸»æ’­å…¬é’¥ (SS58 åœ°å€)
  signature: string,    // ä¸»æ’­ç­¾å
  timestamp: number     // ç­¾åæ—¶é—´æˆ³
): Promise<string> {
  // 1. æ£€æŸ¥æ—¶é—´æˆ³æœ‰æ•ˆæ€§ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
  const now = Date.now();
  if (Math.abs(now - timestamp) > 5 * 60 * 1000) {
    throw new Error('Signature expired');
  }

  // 2. æ„é€ ç­¾åæ¶ˆæ¯
  const message = `livestream:${roomId}:${timestamp}`;

  // 3. éªŒè¯ç­¾å
  const { isValid } = signatureVerify(message, signature, publicKey);
  if (!isValid) {
    throw new Error('Invalid signature');
  }

  // 4. æŸ¥è¯¢é“¾ä¸Šç¡®è®¤æ˜¯æˆ¿ä¸»
  const room = await api.query.livestream.liveRooms(roomId);
  if (room.isNone) {
    throw new Error('Room not found');
  }
  const roomData = room.unwrap();
  if (roomData.host.toString() !== publicKey) {
    throw new Error('Not room host');
  }

  // 5. æ£€æŸ¥ç›´æ’­é—´çŠ¶æ€
  if (roomData.status.toString() !== 'Live' && roomData.status.toString() !== 'Preparing') {
    throw new Error('Room not available for streaming');
  }

  // 6. ç”Ÿæˆ LiveKit Tokenï¼ˆå‘å¸ƒè€…æƒé™ï¼‰
  const token = new AccessToken(
    process.env.LIVEKIT_API_KEY!,
    process.env.LIVEKIT_API_SECRET!,
    { identity: publicKey, name: `Host-${roomId}`, ttl: '6h' }
  );

  token.addGrant({
    room: `room-${roomId}`,
    roomJoin: true,
    canPublish: true,       // å¯ä»¥æ¨æµ
    canSubscribe: true,
    canPublishData: true,   // å¯ä»¥å‘é€èŠå¤©æ¶ˆæ¯
  });

  return token.toJwt();
}

/**
 * ç”Ÿæˆè§‚ä¼—è§‚çœ‹ Token
 */
async function generateViewerToken(
  roomId: string,
  viewerAddress: string
): Promise<string> {
  // 1. æŸ¥è¯¢ç›´æ’­é—´
  const room = await api.query.livestream.liveRooms(roomId);
  if (room.isNone) {
    throw new Error('Room not found');
  }
  const roomData = room.unwrap();

  // 2. æ£€æŸ¥ç›´æ’­é—´çŠ¶æ€
  if (roomData.status.toString() !== 'Live') {
    throw new Error('Room not live');
  }

  // 3. å¦‚æœæ˜¯ä»˜è´¹ç›´æ’­ï¼Œæ£€æŸ¥æ˜¯å¦è´­ç¥¨
  if (roomData.roomType.toString() === 'Paid') {
    const ticket = await api.query.livestream.ticketHolders(roomId, viewerAddress);
    if (ticket.isNone) {
      throw new Error('Ticket required');
    }
  }

  // 4. æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
  const banned = await api.query.livestream.roomBlacklist(roomId, viewerAddress);
  if (banned.isSome) {
    throw new Error('You are banned from this room');
  }

  // 5. ç”Ÿæˆ LiveKit Tokenï¼ˆè§‚ä¼—æƒé™ï¼‰
  const token = new AccessToken(
    process.env.LIVEKIT_API_KEY!,
    process.env.LIVEKIT_API_SECRET!,
    { identity: viewerAddress, ttl: '6h' }
  );

  token.addGrant({
    room: `room-${roomId}`,
    roomJoin: true,
    canPublish: false,      // ä¸èƒ½æ¨æµ
    canSubscribe: true,     // å¯ä»¥è§‚çœ‹
    canPublishData: true,   // å¯ä»¥å‘é€èŠå¤©æ¶ˆæ¯
  });

  return token.toJwt();
}
```

### å‰ç«¯ç­¾åæµç¨‹

> âš ï¸ **React Native æ³¨æ„**: ä¸èƒ½ä½¿ç”¨ `@polkadot/extension-dapp`ï¼ˆæµè§ˆå™¨æ‰©å±• APIï¼‰ï¼Œå¿…é¡»ä½¿ç”¨ç§»åŠ¨ç«¯ç­¾åå™¨ã€‚

```typescript
// React Native ç§»åŠ¨ç«¯ç­¾åå®ç°
import { getCurrentPair } from '@/lib/signer.native';
import { u8aToHex } from '@polkadot/util';

async function getPublisherToken(roomId: string, address: string): Promise<string> {
  // 1. è·å–å½“å‰å¯†é’¥å¯¹ (éœ€è¦å…ˆè§£é”é’±åŒ…)
  const pair = getCurrentPair();
  if (!pair) {
    throw new Error('Wallet is locked. Please unlock first.');
  }

  // 2. æ„é€ ç­¾åæ¶ˆæ¯
  const timestamp = Date.now();
  const message = `livestream:${roomId}:${timestamp}`;

  // 3. ç­¾å
  const messageU8a = new TextEncoder().encode(message);
  const signatureU8a = pair.sign(messageU8a);
  const signature = u8aToHex(signatureU8a);

  // 4. è¯·æ±‚åç«¯ç”Ÿæˆ Token
  const response = await fetch('/api/livestream/publisher-token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ roomId, publicKey: address, signature, timestamp }),
  });

  if (!response.ok) {
    throw new Error('Failed to get publisher token');
  }

  const { token } = await response.json();
  return token;
}

// ä½¿ç”¨å‰éœ€è¦å…ˆè§£é”é’±åŒ…
import { unlockWallet } from '@/lib/signer.native';
await unlockWallet(userPassword);
```

#### Web ç«¯ç­¾å (ä»…ä¾›å‚è€ƒï¼Œæœ¬é¡¹ç›®ä¸º React Native)

```typescript
// æµè§ˆå™¨ç¯å¢ƒå¯ä½¿ç”¨ Polkadot.js æ‰©å±•
import { web3FromAddress } from '@polkadot/extension-dapp';

const injector = await web3FromAddress(address);
const { signature } = await injector.signer.signRaw!({
  address,
  data: message,
  type: 'bytes',
});
```

---

## ç›´æ’­é—´èŠå¤©ç³»ç»Ÿ (LiveKit DataChannel)

ä½¿ç”¨ LiveKit å†…ç½® DataChannel å®ç°å®æ—¶èŠå¤©å’Œå¼¹å¹•ï¼Œæ— éœ€é¢å¤–æœåŠ¡å™¨ã€‚

### æ¶ˆæ¯ç±»å‹å®šä¹‰

```typescript
type MessageType = 'chat' | 'danmaku' | 'gift' | 'system' | 'emoji' | 'like';

interface LiveChatMessage {
  type: MessageType;
  content: string;
  sender: string;        // è´¦æˆ·åœ°å€
  senderName: string;    // æ˜¾ç¤ºåç§°
  timestamp: number;
  // ç¤¼ç‰©æ¶ˆæ¯
  giftId?: number;
  giftCount?: number;
  giftValue?: number;
  // å¼¹å¹•æ ·å¼
  color?: string;
  position?: 'scroll' | 'top' | 'bottom';
}
```

### èŠå¤©æœåŠ¡å°è£…

```typescript
import { Room, RoomEvent } from 'livekit-client';

class LiveChatService {
  private room: Room;
  private messageHandlers: Map<MessageType, (msg: LiveChatMessage) => void> = new Map();

  constructor(room: Room) {
    this.room = room;
    this.setupMessageListener();
  }

  private setupMessageListener() {
    this.room.on(RoomEvent.DataReceived, (payload) => {
      try {
        const message: LiveChatMessage = JSON.parse(new TextDecoder().decode(payload));
        const handler = this.messageHandlers.get(message.type);
        handler?.(message);
      } catch (e) {
        console.error('æ¶ˆæ¯è§£æå¤±è´¥:', e);
      }
    });
  }

  onMessage(type: MessageType, handler: (msg: LiveChatMessage) => void) {
    this.messageHandlers.set(type, handler);
  }

  // å‘é€èŠå¤©æ¶ˆæ¯
  async sendChat(content: string) {
    await this.sendMessage({
      type: 'chat',
      content,
      sender: this.room.localParticipant.identity,
      senderName: this.room.localParticipant.name || 'åŒ¿åç”¨æˆ·',
      timestamp: Date.now(),
    });
  }

  // å‘é€å¼¹å¹•
  async sendDanmaku(content: string, color = '#FFFFFF') {
    await this.sendMessage({
      type: 'danmaku',
      content,
      sender: this.room.localParticipant.identity,
      senderName: this.room.localParticipant.name || 'åŒ¿åç”¨æˆ·',
      timestamp: Date.now(),
      color,
      position: 'scroll',
    });
  }

  // å‘é€ç¤¼ç‰©é€šçŸ¥ (é“¾ä¸Šæ‰“èµæˆåŠŸåè°ƒç”¨)
  async sendGiftNotification(giftId: number, giftCount: number, giftValue: number) {
    await this.sendMessage({
      type: 'gift',
      content: `é€å‡ºäº† ${giftCount} ä¸ªç¤¼ç‰©`,
      sender: this.room.localParticipant.identity,
      senderName: this.room.localParticipant.name || 'åŒ¿åç”¨æˆ·',
      timestamp: Date.now(),
      giftId,
      giftCount,
      giftValue,
    });
  }

  // å‘é€ç‚¹èµ
  async sendLike() {
    await this.sendMessage({
      type: 'like',
      content: 'â¤ï¸',
      sender: this.room.localParticipant.identity,
      senderName: '',
      timestamp: Date.now(),
    });
  }

  private async sendMessage(message: LiveChatMessage) {
    const data = new TextEncoder().encode(JSON.stringify(message));
    await this.room.localParticipant.publishData(data, { reliable: true });
  }
}
```

### React Native èŠå¤©ç»„ä»¶

```typescript
import React, { useState, useEffect, useRef } from 'react';
import { View, FlatList, TextInput, TouchableOpacity, Text, StyleSheet } from 'react-native';
import { Room } from 'livekit-client';

export function LiveChat({ room }: { room: Room }) {
  const [messages, setMessages] = useState<LiveChatMessage[]>([]);
  const [inputText, setInputText] = useState('');
  const chatService = useRef<LiveChatService | null>(null);

  useEffect(() => {
    chatService.current = new LiveChatService(room);
    
    chatService.current.onMessage('chat', (msg) => {
      setMessages(prev => [...prev, msg].slice(-100));
    });

    chatService.current.onMessage('gift', (msg) => {
      setMessages(prev => [...prev, msg].slice(-100));
    });

    return () => { chatService.current = null; };
  }, [room]);

  const handleSend = async () => {
    if (!inputText.trim() || !chatService.current) return;
    await chatService.current.sendChat(inputText.trim());
    setInputText('');
  };

  const renderMessage = ({ item }: { item: LiveChatMessage }) => {
    if (item.type === 'gift') {
      return (
        <View style={styles.giftMessage}>
          <Text style={styles.giftText}>ğŸ {item.senderName} {item.content}</Text>
        </View>
      );
    }
    return (
      <View style={styles.chatMessage}>
        <Text style={styles.senderName}>{item.senderName}:</Text>
        <Text style={styles.messageContent}>{item.content}</Text>
      </View>
    );
  };

  return (
    <View style={styles.container}>
      <FlatList
        data={messages}
        renderItem={renderMessage}
        keyExtractor={(_, index) => index.toString()}
        style={styles.messageList}
      />
      <View style={styles.inputContainer}>
        <TextInput
          style={styles.input}
          value={inputText}
          onChangeText={setInputText}
          placeholder="å‘é€æ¶ˆæ¯..."
          maxLength={100}
        />
        <TouchableOpacity style={styles.sendButton} onPress={handleSend}>
          <Text style={styles.sendButtonText}>å‘é€</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  messageList: { flex: 1, padding: 10 },
  chatMessage: { flexDirection: 'row', marginBottom: 8 },
  senderName: { color: '#FFD700', fontWeight: 'bold', marginRight: 8 },
  messageContent: { color: '#FFF', flex: 1 },
  giftMessage: { backgroundColor: 'rgba(255,215,0,0.2)', padding: 8, borderRadius: 4, marginBottom: 8 },
  giftText: { color: '#FFD700' },
  inputContainer: { flexDirection: 'row', padding: 10, borderTopWidth: 1, borderTopColor: '#333' },
  input: { flex: 1, backgroundColor: '#222', borderRadius: 20, paddingHorizontal: 15, color: '#FFF' },
  sendButton: { marginLeft: 10, backgroundColor: '#FF4757', borderRadius: 20, paddingHorizontal: 20, justifyContent: 'center' },
  sendButtonText: { color: '#FFF', fontWeight: 'bold' },
});
```

### å¼¹å¹•ç»„ä»¶

```typescript
import React, { useState, useEffect, useRef } from 'react';
import { View, Text, Animated, StyleSheet, Dimensions } from 'react-native';

const { width: SCREEN_WIDTH } = Dimensions.get('window');

export function DanmakuOverlay({ room }: { room: Room }) {
  const [danmakus, setDanmakus] = useState<any[]>([]);
  const trackRef = useRef(0);

  useEffect(() => {
    const chatService = new LiveChatService(room);
    
    chatService.onMessage('danmaku', (msg) => {
      const id = `${Date.now()}-${Math.random()}`;
      const translateX = new Animated.Value(SCREEN_WIDTH);
      const top = (trackRef.current % 10) * 30 + 50;
      trackRef.current++;

      setDanmakus(prev => [...prev, { id, content: msg.content, color: msg.color, translateX, top }]);

      Animated.timing(translateX, {
        toValue: -500,
        duration: 8000,
        useNativeDriver: true,
      }).start(() => {
        setDanmakus(prev => prev.filter(d => d.id !== id));
      });
    });
  }, [room]);

  return (
    <View style={StyleSheet.absoluteFill} pointerEvents="none">
      {danmakus.map(d => (
        <Animated.Text
          key={d.id}
          style={[styles.danmaku, { color: d.color, top: d.top, transform: [{ translateX: d.translateX }] }]}
        >
          {d.content}
        </Animated.Text>
      ))}
    </View>
  );
}

const styles = StyleSheet.create({
  danmaku: {
    position: 'absolute',
    fontSize: 16,
    fontWeight: 'bold',
    textShadowColor: '#000',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 2,
  },
});
```

### æ¶ˆæ¯é™æµ

```typescript
class RateLimiter {
  private timestamps: number[] = [];
  
  constructor(private limit = 5, private windowMs = 1000) {}

  canSend(): boolean {
    const now = Date.now();
    this.timestamps = this.timestamps.filter(t => now - t < this.windowMs);
    if (this.timestamps.length >= this.limit) return false;
    this.timestamps.push(now);
    return true;
  }
}

// ä½¿ç”¨: æ¯ç§’æœ€å¤š5æ¡æ¶ˆæ¯
const rateLimiter = new RateLimiter(5, 1000);

async function sendChat(content: string) {
  if (!rateLimiter.canSend()) {
    alert('å‘é€å¤ªé¢‘ç¹');
    return;
  }
  await chatService.sendChat(content);
}
```

### èŠå¤©åŠŸèƒ½ç‰¹æ€§

| åŠŸèƒ½ | å®ç° | è¯´æ˜ |
|------|------|------|
| å®æ—¶èŠå¤© | DataChannel | æ¯«ç§’çº§å»¶è¿Ÿ |
| å¼¹å¹• | DataChannel + åŠ¨ç”» | æ»šåŠ¨/é¡¶éƒ¨/åº•éƒ¨ |
| ç¤¼ç‰©é€šçŸ¥ | é“¾ä¸Šäº‹ä»¶ + DataChannel | é“¾ä¸Šæ‰“èµåå¹¿æ’­ |
| ç‚¹èµ | DataChannel | è½»é‡çº§äº’åŠ¨ |
| ç¦è¨€ | é“¾ä¸Šè®°å½• + å‰ç«¯è¿‡æ»¤ | è¢«ç¦è¨€ç”¨æˆ·æ— æ³•å‘é€ |

### æˆæœ¬

**èŠå¤©åŠŸèƒ½é›¶é¢å¤–æˆæœ¬** - DataChannel åŒ…å«åœ¨ LiveKit è§†é¢‘æµè´¹ç”¨ä¸­ï¼Œä¸å•ç‹¬è®¡è´¹ã€‚


---

## è¿éº¦åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰

> **è®¾è®¡å˜æ›´**: è¿éº¦ç”³è¯·/åŒæ„/æ‹’ç»æµç¨‹å…¨éƒ¨ç§»è‡³é“¾ä¸‹ï¼ˆé€šè¿‡ DataChannelï¼‰ï¼Œé“¾ä¸Šåªè®°å½•è¿éº¦å¼€å§‹å’Œç»“æŸçŠ¶æ€ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹çš„é“¾ä¸Šäº¤æ˜“ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

LiveKit åŸç”Ÿæ”¯æŒå¤šäººåŒæ—¶æ¨æµï¼Œéå¸¸é€‚åˆå®ç°è¿éº¦åŠŸèƒ½ã€‚

### è¿éº¦æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¿éº¦æ¨¡å¼                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. è¯­éŸ³è¿éº¦ (Audio Only)                                        â”‚
â”‚     ä¸»æ’­è§†é¢‘ + è¿éº¦è€…è¯­éŸ³                                         â”‚
â”‚     é€‚åˆ: èŠå¤©ã€é—®ç­”ã€ç”µå°                                        â”‚
â”‚                                                                  â”‚
â”‚  2. è§†é¢‘è¿éº¦ (Video + Audio)                                     â”‚
â”‚     ä¸»æ’­è§†é¢‘ + è¿éº¦è€…è§†é¢‘ (ç”»ä¸­ç”»/åˆ†å±)                           â”‚
â”‚     é€‚åˆ: è®¿è°ˆã€PKã€å¤šäººäº’åŠ¨                                      â”‚
â”‚                                                                  â”‚
â”‚  3. å¤šäººè¿éº¦ (Multi-Guest)                                       â”‚
â”‚     æœ€å¤šæ”¯æŒ 4 äººåŒæ—¶è¿éº¦                                         â”‚
â”‚     é€‚åˆ: åœ†æ¡Œè®¨è®ºã€å¤šäººæ¸¸æˆ                                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿éº¦æµç¨‹ï¼ˆé“¾ä¸‹ç”³è¯· + é“¾ä¸Šè®°å½•ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§‚ä¼—   â”‚          â”‚  ä¸»æ’­   â”‚          â”‚ LiveKit â”‚          â”‚Substrateâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 1. ç”³è¯·è¿éº¦ (DataChannel)               â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 2. åŒæ„è¿éº¦ (DataChannel)               â”‚                    â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 3. è¯·æ±‚è¿éº¦è€… Token â”‚                    â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚ 4. å¼€å¯æ‘„åƒå¤´/éº¦å…‹é£ â”‚                    â”‚                    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚                    â”‚ 5. è®°å½•è¿éº¦å¼€å§‹ (å¯é€‰)                   â”‚
     â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                    â”‚                    â”‚                    â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. è¿éº¦ä¸­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
     â”‚                    â”‚                    â”‚                    â”‚
```

### é“¾ä¸Šç±»å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```rust
/// è¿éº¦ç±»å‹
#[derive(Encode, Decode, Clone, RuntimeDebug, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub enum CoHostType {
    /// è¯­éŸ³è¿éº¦
    AudioOnly,
    /// è§†é¢‘è¿éº¦
    VideoAndAudio,
}
```

> **å·²åˆ é™¤çš„ç±»å‹**: `CoHostStatus`ã€`CoHostRequest`ã€`CoHost` ç»“æ„ä½“ - è¿™äº›ä¿¡æ¯æ”¹ä¸ºé“¾ä¸‹ç®¡ç†ã€‚

### é“¾ä¸Šå­˜å‚¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

```rust
/// å½“å‰è¿éº¦è€…åˆ—è¡¨ï¼ˆä»…è®°å½•è´¦æˆ·ï¼Œè¯¦ç»†ä¿¡æ¯é“¾ä¸‹ç®¡ç†ï¼‰
#[pallet::storage]
pub type ActiveCoHosts<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // room_id
    BoundedVec<T::AccountId, T::MaxCoHostsPerRoom>,
    ValueQuery,
>;
```

> **å·²åˆ é™¤çš„å­˜å‚¨**: `CoHostRequests`ã€`MaxCoHostsPerRoom` StorageValue - ç”³è¯·é˜Ÿåˆ—æ”¹ä¸ºé“¾ä¸‹ç®¡ç†ï¼Œæœ€å¤§äººæ•°æ”¹ä¸º Config å¸¸é‡ã€‚

### é“¾ä¸Šè°ƒç”¨å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```rust
/// å¼€å§‹è¿éº¦ï¼ˆä¸»æ’­è°ƒç”¨ï¼Œåœ¨é“¾ä¸‹åŒæ„åè®°å½•åˆ°é“¾ä¸Šï¼‰
#[pallet::call_index(50)]
pub fn start_co_host(
    origin: OriginFor<T>,
    room_id: u64,
    co_host: T::AccountId,
) -> DispatchResult {
    let host = ensure_signed(origin)?;

    // 1. éªŒè¯æ˜¯æˆ¿ä¸»
    let room = LiveRooms::<T>::get(room_id).ok_or(Error::<T>::RoomNotFound)?;
    ensure!(room.host == host, Error::<T>::NotRoomHost);
    ensure!(room.status == LiveRoomStatus::Live, Error::<T>::RoomNotLive);

    // 2. æ£€æŸ¥è¿éº¦äººæ•°é™åˆ¶
    ActiveCoHosts::<T>::try_mutate(room_id, |co_hosts| {
        ensure!(co_hosts.len() < T::MaxCoHostsPerRoom::get() as usize, Error::<T>::TooManyCoHosts);
        ensure!(!co_hosts.contains(&co_host), Error::<T>::AlreadyCoHost);
        co_hosts.try_push(co_host.clone()).map_err(|_| Error::<T>::TooManyCoHosts)?;
        Ok::<(), DispatchError>(())
    })?;

    // 3. å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::CoHostStarted { room_id, co_host });

    Ok(())
}

/// ç»“æŸè¿éº¦ï¼ˆä¸»æ’­æˆ–è¿éº¦è€…è°ƒç”¨ï¼‰
#[pallet::call_index(51)]
pub fn end_co_host(
    origin: OriginFor<T>,
    room_id: u64,
    co_host: Option<T::AccountId>,
) -> DispatchResult {
    let caller = ensure_signed(origin)?;

    let room = LiveRooms::<T>::get(room_id).ok_or(Error::<T>::RoomNotFound)?;

    // ç¡®å®šè¦ç§»é™¤çš„è¿éº¦è€…
    let target = co_host.unwrap_or(caller.clone());

    // éªŒè¯æƒé™ï¼šæˆ¿ä¸»å¯ä»¥ç§»é™¤ä»»ä½•äººï¼Œè¿éº¦è€…åªèƒ½ç§»é™¤è‡ªå·±
    if caller != room.host {
        ensure!(caller == target, Error::<T>::NotAuthorized);
    }

    // ç§»é™¤è¿éº¦è€…
    ActiveCoHosts::<T>::try_mutate(room_id, |co_hosts| {
        let pos = co_hosts.iter().position(|x| x == &target).ok_or(Error::<T>::NotCoHost)?;
        co_hosts.remove(pos);
        Ok::<(), DispatchError>(())
    })?;

    // å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::CoHostEnded { room_id, co_host: target, duration: 0 });

    Ok(())
}
```

> **å·²åˆ é™¤çš„å‡½æ•°**: `request_co_host`ã€`accept_co_host`ã€`reject_co_host`ã€`mute_co_host`ã€`cancel_co_host_request` - è¿™äº›æ“ä½œæ”¹ä¸ºé“¾ä¸‹å¤„ç†ã€‚

### å‰ç«¯å®ç°

#### è¿éº¦æœåŠ¡

```typescript
import { Room, RoomEvent, Track, Participant } from 'livekit-client';

interface CoHostInfo {
  identity: string;
  name: string;
  type: 'audio' | 'video';
  videoTrack?: Track;
  audioTrack?: Track;
}

class CoHostService {
  private room: Room;
  private coHosts: Map<string, CoHostInfo> = new Map();
  private onCoHostChange?: (coHosts: CoHostInfo[]) => void;

  constructor(room: Room) {
    this.room = room;
    this.setupListeners();
  }

  private setupListeners() {
    // ç›‘å¬æ–°å‚ä¸è€… (è¿éº¦è€…åŠ å…¥)
    this.room.on(RoomEvent.ParticipantConnected, (participant: Participant) => {
      // æ£€æŸ¥æ˜¯å¦æ˜¯è¿éº¦è€… (é€šè¿‡ metadata åˆ¤æ–­)
      if (participant.metadata?.includes('co_host')) {
        this.addCoHost(participant);
      }
    });

    // ç›‘å¬å‚ä¸è€…ç¦»å¼€
    this.room.on(RoomEvent.ParticipantDisconnected, (participant: Participant) => {
      this.removeCoHost(participant.identity);
    });

    // ç›‘å¬è½¨é“è®¢é˜…
    this.room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
      const coHost = this.coHosts.get(participant.identity);
      if (coHost) {
        if (track.kind === Track.Kind.Video) {
          coHost.videoTrack = track;
        } else if (track.kind === Track.Kind.Audio) {
          coHost.audioTrack = track;
        }
        this.notifyChange();
      }
    });
  }

  private addCoHost(participant: Participant) {
    const metadata = JSON.parse(participant.metadata || '{}');
    this.coHosts.set(participant.identity, {
      identity: participant.identity,
      name: participant.name || 'è¿éº¦ç”¨æˆ·',
      type: metadata.coHostType || 'audio',
    });
    this.notifyChange();
  }

  private removeCoHost(identity: string) {
    this.coHosts.delete(identity);
    this.notifyChange();
  }

  private notifyChange() {
    this.onCoHostChange?.(Array.from(this.coHosts.values()));
  }

  // è®¾ç½®è¿éº¦è€…å˜åŒ–å›è°ƒ
  setOnCoHostChange(callback: (coHosts: CoHostInfo[]) => void) {
    this.onCoHostChange = callback;
  }

  // è·å–å½“å‰è¿éº¦è€…åˆ—è¡¨
  getCoHosts(): CoHostInfo[] {
    return Array.from(this.coHosts.values());
  }
}
```

#### è§‚ä¼—ç”³è¯·è¿éº¦

```typescript
class CoHostApplicant {
  private room: Room;
  private chatService: LiveChatService;

  constructor(room: Room) {
    this.room = room;
    this.chatService = new LiveChatService(room);
  }

  // ç”³è¯·è¿éº¦ (é€šè¿‡ DataChannel å‘é€è¯·æ±‚)
  async requestCoHost(type: 'audio' | 'video') {
    await this.chatService.sendMessage({
      type: 'system',
      content: JSON.stringify({
        action: 'co_host_request',
        coHostType: type,
      }),
      sender: this.room.localParticipant.identity,
      senderName: this.room.localParticipant.name || '',
      timestamp: Date.now(),
    });
  }

  // æ”¶åˆ°ä¸»æ’­åŒæ„åï¼Œå¼€å¯æ‘„åƒå¤´/éº¦å…‹é£
  async startCoHost(type: 'audio' | 'video') {
    if (type === 'video') {
      await this.room.localParticipant.enableCameraAndMicrophone();
    } else {
      await this.room.localParticipant.setMicrophoneEnabled(true);
    }

    // æ›´æ–° metadata æ ‡è®°ä¸ºè¿éº¦è€…
    await this.room.localParticipant.setMetadata(JSON.stringify({
      co_host: true,
      coHostType: type,
    }));
  }

  // ç»“æŸè¿éº¦
  async endCoHost() {
    await this.room.localParticipant.setCameraEnabled(false);
    await this.room.localParticipant.setMicrophoneEnabled(false);
    await this.room.localParticipant.setMetadata('{}');
  }
}
```

#### ä¸»æ’­ç®¡ç†è¿éº¦

```typescript
class CoHostManager {
  private room: Room;
  private chatService: LiveChatService;
  private pendingRequests: Map<string, { type: 'audio' | 'video'; timestamp: number }> = new Map();

  constructor(room: Room) {
    this.room = room;
    this.chatService = new LiveChatService(room);
    this.listenForRequests();
  }

  private listenForRequests() {
    this.chatService.onMessage('system', (msg) => {
      try {
        const data = JSON.parse(msg.content);
        if (data.action === 'co_host_request') {
          this.pendingRequests.set(msg.sender, {
            type: data.coHostType,
            timestamp: msg.timestamp,
          });
          this.onRequestReceived?.(msg.sender, msg.senderName, data.coHostType);
        }
      } catch {}
    });
  }

  private onRequestReceived?: (identity: string, name: string, type: 'audio' | 'video') => void;

  // è®¾ç½®æ”¶åˆ°ç”³è¯·çš„å›è°ƒ
  setOnRequestReceived(callback: (identity: string, name: string, type: 'audio' | 'video') => void) {
    this.onRequestReceived = callback;
  }

  // è·å–å¾…å¤„ç†çš„è¿éº¦ç”³è¯·
  getPendingRequests() {
    return Array.from(this.pendingRequests.entries()).map(([identity, data]) => ({
      identity,
      ...data,
    }));
  }

  // åŒæ„è¿éº¦
  async acceptCoHost(identity: string) {
    const request = this.pendingRequests.get(identity);
    if (!request) return;

    // é€šçŸ¥ç”³è¯·è€…
    await this.chatService.sendMessage({
      type: 'system',
      content: JSON.stringify({
        action: 'co_host_accepted',
        target: identity,
        coHostType: request.type,
      }),
      sender: 'host',
      senderName: 'ä¸»æ’­',
      timestamp: Date.now(),
    });

    this.pendingRequests.delete(identity);
  }

  // æ‹’ç»è¿éº¦
  async rejectCoHost(identity: string) {
    await this.chatService.sendMessage({
      type: 'system',
      content: JSON.stringify({
        action: 'co_host_rejected',
        target: identity,
      }),
      sender: 'host',
      senderName: 'ä¸»æ’­',
      timestamp: Date.now(),
    });

    this.pendingRequests.delete(identity);
  }

  // ç»“æŸæŸäººçš„è¿éº¦
  async endCoHost(identity: string) {
    await this.chatService.sendMessage({
      type: 'system',
      content: JSON.stringify({
        action: 'co_host_ended',
        target: identity,
      }),
      sender: 'host',
      senderName: 'ä¸»æ’­',
      timestamp: Date.now(),
    });
  }

  // é™éŸ³è¿éº¦è€…
  async muteCoHost(identity: string, muted: boolean) {
    await this.chatService.sendMessage({
      type: 'system',
      content: JSON.stringify({
        action: 'co_host_mute',
        target: identity,
        muted,
      }),
      sender: 'host',
      senderName: 'ä¸»æ’­',
      timestamp: Date.now(),
    });
  }
}
```

#### è¿éº¦å¸ƒå±€ç»„ä»¶

```typescript
import React from 'react';
import { View, StyleSheet, Dimensions } from 'react-native';
import { VideoView } from '@livekit/react-native';

const { width: SCREEN_WIDTH, height: SCREEN_HEIGHT } = Dimensions.get('window');

interface CoHostLayoutProps {
  hostTrack: Track;
  coHosts: CoHostInfo[];
  layout: 'pip' | 'split' | 'grid';  // ç”»ä¸­ç”» / åˆ†å± / ç½‘æ ¼
}

export function CoHostLayout({ hostTrack, coHosts, layout }: CoHostLayoutProps) {
  // ç”»ä¸­ç”»æ¨¡å¼: ä¸»æ’­å¤§ç”»é¢ + è¿éº¦è€…å°çª—
  if (layout === 'pip') {
    return (
      <View style={styles.container}>
        <VideoView style={styles.fullScreen} videoTrack={hostTrack} />
        <View style={styles.pipContainer}>
          {coHosts.map((coHost, index) => (
            coHost.videoTrack && (
              <VideoView
                key={coHost.identity}
                style={[styles.pipWindow, { bottom: 100 + index * 120 }]}
                videoTrack={coHost.videoTrack}
              />
            )
          ))}
        </View>
      </View>
    );
  }

  // åˆ†å±æ¨¡å¼: å·¦å³/ä¸Šä¸‹åˆ†å±
  if (layout === 'split') {
    const firstCoHost = coHosts[0];
    return (
      <View style={styles.splitContainer}>
        <VideoView style={styles.splitHalf} videoTrack={hostTrack} />
        {firstCoHost?.videoTrack && (
          <VideoView style={styles.splitHalf} videoTrack={firstCoHost.videoTrack} />
        )}
      </View>
    );
  }

  // ç½‘æ ¼æ¨¡å¼: å¤šäººå¹³åˆ†ç”»é¢
  const allTracks = [hostTrack, ...coHosts.filter(c => c.videoTrack).map(c => c.videoTrack!)];
  const gridSize = Math.ceil(Math.sqrt(allTracks.length));
  
  return (
    <View style={styles.gridContainer}>
      {allTracks.map((track, index) => (
        <VideoView
          key={index}
          style={[styles.gridItem, { width: `${100 / gridSize}%`, height: `${100 / gridSize}%` }]}
          videoTrack={track}
        />
      ))}
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1 },
  fullScreen: { width: SCREEN_WIDTH, height: SCREEN_HEIGHT },
  pipContainer: { position: 'absolute', right: 16 },
  pipWindow: { width: 100, height: 150, borderRadius: 8, overflow: 'hidden' },
  splitContainer: { flex: 1, flexDirection: 'row' },
  splitHalf: { flex: 1 },
  gridContainer: { flex: 1, flexDirection: 'row', flexWrap: 'wrap' },
  gridItem: { aspectRatio: 16 / 9 },
});
```

### è¿éº¦åŠŸèƒ½é…ç½®

```rust
// runtime é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰
parameter_types! {
    pub const MaxCoHostsPerRoom: u32 = 4;  // æœ€å¤š4äººè¿éº¦
}

// å·²åˆ é™¤çš„é…ç½®:
// - CoHostRequestTimeout: ç”³è¯·æµç¨‹ç§»è‡³é“¾ä¸‹ï¼Œæ— éœ€è¶…æ—¶é…ç½®
// - MinCoHostDuration: é“¾ä¸‹ç®¡ç†ï¼Œæ— éœ€é“¾ä¸Šé™åˆ¶
```

### è¿éº¦åŠŸèƒ½ç‰¹æ€§

| åŠŸèƒ½ | å®ç°ä½ç½® | è¯´æ˜ |
|------|----------|------|
| è¯­éŸ³è¿éº¦ | é“¾ä¸‹ | ä»…éŸ³é¢‘ï¼Œå¸¦å®½å ç”¨ä½ |
| è§†é¢‘è¿éº¦ | é“¾ä¸‹ | éŸ³è§†é¢‘ï¼Œç”»ä¸­ç”»/åˆ†å±æ˜¾ç¤º |
| å¤šäººè¿éº¦ | é“¾ä¸Šé™åˆ¶ | æœ€å¤š4äººåŒæ—¶è¿éº¦ |
| ç”³è¯·/åŒæ„/æ‹’ç» | **é“¾ä¸‹ DataChannel** | æ— éœ€é“¾ä¸Šäº¤æ˜“ï¼Œå³æ—¶å“åº” |
| å¼€å§‹/ç»“æŸè®°å½• | é“¾ä¸Š | ç”¨äºç»Ÿè®¡å’Œäº‹ä»¶è®°å½• |
| é™éŸ³æ§åˆ¶ | é“¾ä¸‹ LiveKit | é€šè¿‡ LiveKit æƒé™æ§åˆ¶ |
| å¸ƒå±€åˆ‡æ¢ | é“¾ä¸‹å‰ç«¯ | ç”»ä¸­ç”»/åˆ†å±/ç½‘æ ¼ |

### æˆæœ¬

è¿éº¦åŠŸèƒ½ä½¿ç”¨ LiveKit å¤šäººæˆ¿é—´èƒ½åŠ›ï¼ŒæŒ‰å‚ä¸è€…è®¡è´¹ï¼š
- ä¸»æ’­ + 1è¿éº¦è€… + 100è§‚ä¼— = 102äºº Ã— 60åˆ†é’Ÿ Ã— $0.01 = $61.2/å°æ—¶
- ç›¸æ¯”æ— è¿éº¦ä»…å¢åŠ è¿éº¦è€…çš„è´¹ç”¨

---

## è®¾è®¡ä¿®æ”¹æ€»ç»“

æœ¬æ–‡æ¡£ç»è¿‡ä¼˜åŒ–ï¼Œå®æ–½äº†ä»¥ä¸‹æ ¸å¿ƒä¿®æ”¹ï¼š

### 1. è§‚ä¼—ç®¡ç†ç§»è‡³é“¾ä¸‹

| ä¿®æ”¹é¡¹ | åŸè®¾è®¡ | æ–°è®¾è®¡ |
|--------|--------|--------|
| è§‚ä¼—åˆ—è¡¨ | `RoomViewers` é“¾ä¸Šå­˜å‚¨ | LiveKit ç®¡ç† |
| è¿›å…¥/ç¦»å¼€ | `join_room`/`leave_room` extrinsic | ç›´æ¥è¿æ¥/æ–­å¼€ LiveKit |
| è§‚ä¼—è®¡æ•° | é“¾ä¸Š `viewer_count` | LiveKit API å®æ—¶è·å– |
| ç¦è¨€åŠŸèƒ½ | é“¾ä¸Š `mute_viewer` | LiveKit æƒé™æ§åˆ¶ |

**æ”¶ç›Š**: é¿å… 10000 è§‚ä¼—å­˜å‚¨çˆ†ç‚¸ï¼Œå‡å°‘é“¾ä¸Šäº¤æ˜“è´¹ç”¨

### 2. åˆ é™¤ stream_keyï¼Œæ”¹ç”¨ç­¾åéªŒè¯

| ä¿®æ”¹é¡¹ | åŸè®¾è®¡ | æ–°è®¾è®¡ |
|--------|--------|--------|
| æ¨æµè®¤è¯ | é“¾ä¸Šå­˜å‚¨ `stream_key` | ç§é’¥ç­¾åéªŒè¯ |
| å®‰å…¨æ€§ | ä»»ä½•äººå¯è¯»å– key | åªæœ‰ç§é’¥æŒæœ‰è€…å¯æ¨æµ |
| Token ç”Ÿæˆ | ç®€å•ç”Ÿæˆ | éªŒè¯ç­¾å + æŸ¥è¯¢é“¾ä¸Šæˆ¿ä¸» |

**æ”¶ç›Š**: é˜²æ­¢å†’å……ä¸»æ’­æ¨æµçš„å®‰å…¨æ¼æ´

### 3. ç®€åŒ–é“¾ä¸Šå­˜å‚¨ï¼Œç”¨äº‹ä»¶æ›¿ä»£è¯¦ç»†è®°å½•

| ä¿®æ”¹é¡¹ | åŸè®¾è®¡ | æ–°è®¾è®¡ |
|--------|--------|--------|
| ç¤¼ç‰©è®°å½• | `GiftRecords` å­˜å‚¨ | `GiftSent` äº‹ä»¶ |
| å†å²æŸ¥è¯¢ | é“¾ä¸Šéå† | ç´¢å¼•å™¨ç›‘å¬äº‹ä»¶ |
| room_id | éšæœºæ•°ç”Ÿæˆ | è‡ªå¢ `NextRoomId` |

**æ”¶ç›Š**: å‡å°‘é“¾ä¸Šå­˜å‚¨æˆæœ¬ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

### 4. è¿éº¦ç”³è¯·æµç¨‹ç§»è‡³é“¾ä¸‹

| ä¿®æ”¹é¡¹ | åŸè®¾è®¡ | æ–°è®¾è®¡ |
|--------|--------|--------|
| ç”³è¯·è¿éº¦ | `request_co_host` extrinsic | DataChannel æ¶ˆæ¯ |
| åŒæ„/æ‹’ç» | `accept_co_host`/`reject_co_host` | DataChannel æ¶ˆæ¯ |
| é™éŸ³æ§åˆ¶ | `mute_co_host` extrinsic | LiveKit æƒé™æ§åˆ¶ |
| é“¾ä¸Šè®°å½• | å®Œæ•´çŠ¶æ€ | ä»…å¼€å§‹/ç»“æŸäº‹ä»¶ |

**æ”¶ç›Š**: è¿éº¦æ“ä½œå³æ—¶å“åº”ï¼Œæ— éœ€ç­‰å¾…åŒºå—ç¡®è®¤

### é“¾ä¸Š/é“¾ä¸‹èŒè´£åˆ’åˆ†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é“¾ä¸Š (Substrate)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ ç›´æ’­é—´åˆ›å»º/å¼€æ’­/ç»“æŸ                                          â”‚
â”‚  âœ“ ç¤¼ç‰©æ‰“èµï¼ˆèµ„é‡‘è½¬è´¦ï¼‰                                          â”‚
â”‚  âœ“ ä»˜è´¹ç›´æ’­é—¨ç¥¨è´­ä¹°                                              â”‚
â”‚  âœ“ ä¸»æ’­æ”¶ç›Šæç°                                                  â”‚
â”‚  âœ“ é»‘åå•ç®¡ç†                                                    â”‚
â”‚  âœ“ è¿éº¦å¼€å§‹/ç»“æŸè®°å½•                                             â”‚
â”‚  âœ“ ç›´æ’­ç»Ÿè®¡æ•°æ®åŒæ­¥                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é“¾ä¸‹ (LiveKit)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ è§†é¢‘/éŸ³é¢‘æµä¼ è¾“                                               â”‚
â”‚  âœ“ è§‚ä¼—è¿›å…¥/ç¦»å¼€                                                 â”‚
â”‚  âœ“ å®æ—¶è§‚ä¼—è®¡æ•°                                                  â”‚
â”‚  âœ“ èŠå¤©/å¼¹å¹• (DataChannel)                                       â”‚
â”‚  âœ“ è¿éº¦ç”³è¯·/åŒæ„/æ‹’ç»                                            â”‚
â”‚  âœ“ ç¦è¨€/é™éŸ³æ§åˆ¶                                                 â”‚
â”‚  âœ“ æˆ¿ç®¡æƒé™ç®¡ç†                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ é™¤çš„é“¾ä¸Šç»„ä»¶æ±‡æ€»

**å­˜å‚¨**:
- `RoomViewers` - è§‚ä¼—åˆ—è¡¨
- `GiftRecords` - ç¤¼ç‰©è®°å½•
- `CoHostRequests` - è¿éº¦ç”³è¯·é˜Ÿåˆ—

**Extrinsics**:
- `join_room` / `leave_room` - è§‚ä¼—è¿›å‡º
- `mute_viewer` / `unmute_viewer` - ç¦è¨€
- `set_moderator` - è®¾ç½®æˆ¿ç®¡
- `request_co_host` / `accept_co_host` / `reject_co_host` - è¿éº¦ç”³è¯·æµç¨‹
- `mute_co_host` / `cancel_co_host_request` - è¿éº¦ç®¡ç†

**é…ç½®**:
- `MaxViewersPerRoom` - è§‚ä¼—æ•°é™åˆ¶
- `MaxStreamKeyLen` - æµå¯†é’¥é•¿åº¦
- `Randomness` - éšæœºæ•°ç”Ÿæˆå™¨
- `CoHostRequestTimeout` / `MinCoHostDuration` - è¿éº¦è¶…æ—¶é…ç½®

**ç±»å‹**:
- `Viewer` ç»“æ„ä½“
- `CoHostStatus` / `CoHostRequest` / `CoHost` ç»“æ„ä½“
