# Costik Agent å¨èƒæ¨¡å‹ä¸é˜²ä½œæ¶æ·±åº¦åˆ†æ

## 1. æ¶æ„è¦å®³ï¼šAgent æ˜¯ä¿¡ä»»æ ¹

```
Telegram â”€â”€webhookâ”€â”€â–¶ Agent (æŒæœ‰ Bot Token + Ed25519 ç§é’¥)
                         â”‚
                    sign + multicast
                         â”‚
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                    â”‚  K Nodes â”‚  â† å››å±‚éªŒç­¾ + Gossip å…±è¯†
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ consensus (M/K)
                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
                    â”‚  Leader  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ POST /v1/execute
                         â–¼
                    Agent â”€â”€TG APIâ”€â”€â–¶ Telegram
```

**æ ¸å¿ƒçŸ›ç›¾**: Agent åŒæ—¶æ˜¯æ¶ˆæ¯çš„ **ç”Ÿäº§è€…**ï¼ˆæ¥æ”¶ Webhookï¼‰å’Œ **æ‰§è¡Œè€…**ï¼ˆè°ƒç”¨ TG APIï¼‰ï¼Œ
èŠ‚ç‚¹ç½‘ç»œå¤¹åœ¨ä¸­é—´åšéªŒè¯ï¼Œä½† **æ— æ³•ç‹¬ç«‹éªŒè¯æ¶ˆæ¯æ¥æºçš„çœŸå®æ€§**ï¼Œä¹Ÿ **æ— æ³•ç‹¬ç«‹éªŒè¯æ‰§è¡Œç»“æœçš„æ­£ç¡®æ€§**ã€‚

---

## 2. æ”»å‡»å‘é‡å…¨æ™¯ï¼ˆ10 ç±»ï¼‰

### A1 â€” æ¶ˆæ¯ä¼ªé€  (Message Fabrication)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent å‡­ç©ºæ„é€ ä¸€ä¸ªä»æœªå‘ç”Ÿçš„ Telegram Updateï¼Œç­¾ååå¤šæ’­åˆ°èŠ‚ç‚¹ |
| **ä»£ç ä½ç½®** | `costik-agent/src/webhook.rs:67-75` â€” ä» `body` ç›´æ¥æ„é€  `SignedMessage` |
| **å½±å“** | èŠ‚ç‚¹å…±è¯†é€šè¿‡ä¸€ä¸ªå‡æ¶ˆæ¯ â†’ Leader æ‰§è¡Œä¼ªé€ çš„ç®¡ç†åŠ¨ä½œï¼ˆå¦‚ ban æ— è¾œç”¨æˆ·ï¼‰ |
| **å½“å‰é˜²å¾¡** | âŒ **æ— ** â€” èŠ‚ç‚¹åªéªŒç­¾åï¼Œä¸éªŒæ¶ˆæ¯æ¥è‡ª Telegram |
| **ä¸¥é‡æ€§** | ğŸ”´ **Critical** |

**ç¤ºä¾‹**: Agent ä¼ªé€  `{"message": {"text": "/ban", "reply_to_message": {"from": {"id": 12345}}}}` â†’ èŠ‚ç‚¹å…±è¯† â†’ ban user 12345

### A2 â€” æ¶ˆæ¯ç¯¡æ”¹ (Message Tampering)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent æ”¶åˆ°çœŸå® Telegram æ¶ˆæ¯ "hello"ï¼Œæ”¹ä¸º "/ban" åç­¾åè½¬å‘ |
| **ä»£ç ä½ç½®** | `costik-agent/src/webhook.rs:49` â€” `raw_json = body.to_vec()`ï¼ŒAgent å¯åœ¨ç­¾åå‰ä»»æ„ä¿®æ”¹ |
| **å½±å“** | åŒ A1 |
| **å½“å‰é˜²å¾¡** | âš ï¸ **å¼±** â€” `verifier.rs:144-160` é‡æ–°è®¡ç®— hash ä½†å› åºåˆ—åŒ–å·®å¼‚åªè®° debug æ—¥å¿— |
| **ä¸¥é‡æ€§** | ğŸ”´ **Critical** |

### A3 â€” é€‰æ‹©æ€§ä¸¢å¼ƒ (Selective Dropping / Censorship)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent ä¸¢å¼ƒç®¡ç†å‘˜çš„ `/unban` æˆ– `/unmute` å‘½ä»¤ï¼Œåªè½¬å‘ `/ban` |
| **ä»£ç ä½ç½®** | `costik-agent/src/webhook.rs:80` â€” `tokio::spawn` å¯è¢«æ¡ä»¶è·³è¿‡ |
| **å½±å“** | å®¡æŸ¥/é€‰æ‹©æ€§æ‰§è¡Œ â€” ç®¡ç†å‘˜è®¤ä¸ºå‘½ä»¤å·²å‘é€ä½†å®é™…è¢« Agent åæ‰ |
| **å½“å‰é˜²å¾¡** | âŒ **æ— ** |
| **ä¸¥é‡æ€§** | ğŸŸ  **High** |

### A4 â€” ç»•è¿‡å…±è¯†ç›´æ¥æ‰§è¡Œ (Consensus Bypass)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent ä¸èµ°èŠ‚ç‚¹ç½‘ç»œï¼Œç›´æ¥è°ƒç”¨ `api.telegram.org/bot<TOKEN>/banChatMember` |
| **ä»£ç ä½ç½®** | Agent æŒæœ‰ `bot_token`ï¼ˆ`config.rs`ï¼‰ï¼Œå¯éšæ—¶è°ƒç”¨ä»»ä½• TG API |
| **å½±å“** | å®Œå…¨ç»•è¿‡å»ä¸­å¿ƒåŒ–éªŒè¯ï¼Œç­‰ä»·äºä¼ ç»Ÿä¸­å¿ƒåŒ– Bot |
| **å½“å‰é˜²å¾¡** | âŒ **æ— ** â€” è¿™æ˜¯æ¶æ„å±‚é¢çš„æ ¹æœ¬é—®é¢˜ |
| **ä¸¥é‡æ€§** | ğŸ”´ **Critical** |

### A5 â€” æ‹’ç»æ‰§è¡Œ (Execution Refusal)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent æ”¶åˆ° Leader çš„ `/v1/execute` ä½†è¿”å›å‡é”™è¯¯æˆ–ä¸è°ƒç”¨ TG API |
| **ä»£ç ä½ç½®** | `costik-agent/src/webhook.rs:132` â€” `state.executor.execute()` ç»“æœä¸å¯éªŒè¯ |
| **å½±å“** | åˆæ³•å…±è¯†å†³å®šæ— æ³•æ‰§è¡Œï¼ˆDoSï¼‰ |
| **å½“å‰é˜²å¾¡** | âš ï¸ **å¼±** â€” `FailoverManager` å­˜åœ¨ä½†åªå¤„ç† Leader è¶…æ—¶ï¼Œä¸å¤„ç† Agent æ‹’ç» |
| **ä¸¥é‡æ€§** | ğŸŸ  **High** |

### A6 â€” æ‰§è¡Œåå·® (Execution Deviation)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Leader æŒ‡ä»¤ ban user_id=123ï¼ŒAgent å®é™…è°ƒç”¨ TG API ban user_id=456 |
| **ä»£ç ä½ç½®** | `costik-agent/src/executor.rs:58-161` â€” å†…éƒ¨é€»è¾‘ä¸å¯å¤–éƒ¨å®¡è®¡ |
| **å½±å“** | é”™è¯¯çš„ç”¨æˆ·è¢«æ“ä½œ |
| **å½“å‰é˜²å¾¡** | âŒ **æ— ** â€” `agent_receipt` å½“å‰æ˜¯ `"ok"` å­—ç¬¦ä¸²ï¼Œæ— å¯†ç å­¦è¯æ˜ |
| **ä¸¥é‡æ€§** | ğŸŸ  **High** |

### A7 â€” é‡å¤æ‰§è¡Œ (Double Execution)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent æ‰§è¡ŒæˆåŠŸä½†å‘Šè¯‰ Leader å¤±è´¥ â†’ FailoverManager è§¦å‘ Backup â†’ å†æ¬¡æ‰§è¡Œ |
| **ä»£ç ä½ç½®** | `costik-node/src/leader.rs:226-238` â€” å¤±è´¥æ—¶ Backup å¯æ¥ç®¡ |
| **å½±å“** | åŒä¸€åŠ¨ä½œæ‰§è¡Œå¤šæ¬¡ï¼ˆå¦‚å‘é€é‡å¤æ¶ˆæ¯ï¼Œå¤šæ¬¡ banï¼‰ |
| **å½“å‰é˜²å¾¡** | âŒ **æ— ** â€” Telegram éƒ¨åˆ† API å¹‚ç­‰ï¼ˆbanï¼‰ï¼Œéƒ¨åˆ†ä¸å¹‚ç­‰ï¼ˆsendMessageï¼‰ |
| **ä¸¥é‡æ€§** | ğŸŸ¡ **Medium** |

### A8 â€” åºåˆ—å·æ“çºµ (Sequence Manipulation)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent è·³è¿‡åºåˆ—å·æˆ–é‡ç½®åºåˆ—å·åˆ¶é€ æ··ä¹± |
| **ä»£ç ä½ç½®** | `costik-agent/src/signer.rs` â€” SequenceManager ç”± Agent å®Œå…¨æ§åˆ¶ |
| **å½±å“** | èŠ‚ç‚¹é‡æ”¾æ£€æµ‹å¤±æ•ˆï¼Œæ¶ˆæ¯æ’åºæ··ä¹± |
| **å½“å‰é˜²å¾¡** | âš ï¸ **å¼±** â€” `SequenceTracker` æœ‰ Â±10 å®¹å¿çª—å£ä½† Agent æ§åˆ¶åºåˆ—æº |
| **ä¸¥é‡æ€§** | ğŸŸ¡ **Medium** |

### A9 â€” Equivocation (åŒé¢æ¶ˆæ¯)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent å¯¹åŒä¸€ sequence å‘é€ä¸åŒå†…å®¹ç»™ä¸åŒèŠ‚ç‚¹ |
| **ä»£ç ä½ç½®** | `costik-node/src/gossip/state.rs` â€” equivocation detection |
| **å½±å“** | éƒ¨åˆ†èŠ‚ç‚¹å…±è¯†é€šè¿‡ä¸åŒæ¶ˆæ¯ â†’ åˆ†å‰ |
| **å½“å‰é˜²å¾¡** | âœ… **æœ‰æ•ˆ** â€” Gossip çŠ¶æ€æœºæ£€æµ‹ hash ä¸ä¸€è‡´ï¼Œè‡ªåŠ¨ä¸¾æŠ¥ä¸Šé“¾ |
| **ä¸¥é‡æ€§** | ğŸŸ¢ **Mitigated** |

### A10 â€” ç§é’¥æ³„éœ² (Key Compromise)

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **æ”»å‡»æ–¹å¼** | Agent çš„ Ed25519 ç§é’¥è¢«çªƒå–ï¼Œæ”»å‡»è€…å¯å†’å…… Agent |
| **ä»£ç ä½ç½®** | `costik-agent/src/signer.rs:50` â€” å¯†é’¥å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿ |
| **å½±å“** | å®Œå…¨å†’å…… Agent |
| **å½“å‰é˜²å¾¡** | âš ï¸ **å¼±** â€” Unix æƒé™ 600ï¼Œæ—  HSM/TEE |
| **ä¸¥é‡æ€§** | ğŸŸ  **High** |

---

## 3. é˜²å¾¡çŸ©é˜µï¼ˆåˆ†å±‚ï¼‰

### Layer 0: ä¸å¯èƒ½å®Œç¾é˜²å¾¡çš„è®¤çŸ¥

> **Fundamental Limitation**: åªè¦ Agent æŒæœ‰ Bot Tokenï¼Œå®ƒå°± **ç†è®ºä¸Šå¯ä»¥ç»•è¿‡ä¸€åˆ‡**ã€‚
> è¿™ä¸æ˜¯ bug è€Œæ˜¯ Telegram Bot API çš„æ¶æ„çº¦æŸ â€” Bot Token = God Modeã€‚
>
> ç›®æ ‡ä¸æ˜¯æ¶ˆé™¤é£é™©ï¼Œè€Œæ˜¯ **å¤§å¹…æé«˜ä½œæ¶æˆæœ¬ + è®©ä½œæ¶å¯æ£€æµ‹/å¯è¿½æº¯/æœ‰ç»æµåæœ**ã€‚

---

### Layer 1: Webhook æ¥æºè¯æ˜ (é˜² A1/A2)

**é—®é¢˜**: èŠ‚ç‚¹æ— æ³•ç¡®è®¤ Telegram Update çœŸçš„æ¥è‡ª Telegramã€‚

**æ–¹æ¡ˆ 1a â€” Telegram Update ID è¿ç»­æ€§æ£€æµ‹**:
```
Agent ç­¾åæ—¶åŒ…å« update_idï¼ˆTelegram ä¿è¯å…¨å±€é€’å¢ï¼‰
èŠ‚ç‚¹ç»´æŠ¤ per-bot çš„ last_update_id
å¦‚æœ update_id å‡ºç°è·³è·ƒ â†’ æ ‡è®°ä¸ºå¯ç–‘ï¼ˆAgent å¯èƒ½åœ¨ä¸¢å¼ƒæ¶ˆæ¯ï¼‰
å¦‚æœ update_id å‡ºç°å›é€€ â†’ æ ‡è®°ä¸ºä¼ªé€ 
```

**æ–¹æ¡ˆ 1b â€” Node ç‹¬ç«‹æ‹‰å–éªŒè¯ (getUpdates Audit)**:
```
Leader æ‰§è¡Œå®Œæˆåï¼Œéšæœºé€‰æ‹© 1 ä¸ª Backup èŠ‚ç‚¹
Backup è°ƒç”¨ Telegram getUpdates APIï¼ˆä½¿ç”¨ Agent æˆæƒçš„ read-only tokenï¼‰
å¯¹æ¯” update_id å’Œæ¶ˆæ¯å†…å®¹æ˜¯å¦ä¸ Agent è½¬å‘çš„ä¸€è‡´
ä¸ä¸€è‡´ â†’ é“¾ä¸Šä¸¾æŠ¥ Agent ä½œæ¶
```

> âš ï¸ æ­¤æ–¹æ¡ˆéœ€è¦ Agent æä¾›ä¸€ä¸ª read-only å®¡è®¡æ¸ é“ï¼Œ
> æˆ–ä½¿ç”¨ Telegram çš„ getWebhookInfo éªŒè¯æ¶ˆæ¯æ•°é‡ã€‚

**æ–¹æ¡ˆ 1c â€” Commitment + Reveal æ–¹æ¡ˆ**:
```
â‘  Agent æ”¶åˆ° Webhook â†’ ç«‹å³å¹¿æ’­ COMMIT = SHA256(raw_bytes + nonce)
â‘¡ èŠ‚ç‚¹æ”¶åˆ° COMMIT â†’ è®°å½•
â‘¢ Agent å¹¿æ’­ REVEAL = (raw_bytes, nonce, signature)
â‘£ èŠ‚ç‚¹éªŒè¯ SHA256(raw_bytes + nonce) == COMMIT
â‘¤ å¦‚æœ Agent ä¿®æ”¹äº†å†…å®¹ï¼ŒCOMMIT å’Œ REVEAL ä¸åŒ¹é… â†’ ä¸¾æŠ¥
```

> è¿™é˜²æ­¢äº†ç¯¡æ”¹ï¼ˆA2ï¼‰ä½†ä¸é˜²ä¼ªé€ ï¼ˆA1ï¼‰ã€‚

---

### Layer 2: æ‰§è¡Œç»“æœå®¡è®¡ (é˜² A5/A6/A7)

**é—®é¢˜**: èŠ‚ç‚¹æ— æ³•ç¡®è®¤ Agent æ˜¯å¦æ­£ç¡®æ‰§è¡Œäº† TG API è°ƒç”¨ã€‚

**æ–¹æ¡ˆ 2a â€” æ‰§è¡Œå›æ‰§ç­¾å (Signed Receipt)**:
```
Agent æ‰§è¡Œ TG API åï¼Œè¿”å›:
  receipt = {
    action_id,
    tg_api_method,      // å®é™…è°ƒç”¨çš„æ–¹æ³•
    tg_api_params,      // å®é™…å‘é€çš„å‚æ•°
    tg_api_response,    // Telegram è¿”å›çš„å®Œæ•´ JSON
    timestamp,
    agent_signature     // Ed25519 ç­¾å
  }

Leader éªŒè¯ receipt åå¹¿æ’­åˆ° Gossip ç½‘ç»œ â†’ æ‰€æœ‰èŠ‚ç‚¹å­˜æ¡£
receipt ä¸Šé“¾ä½œä¸ºä¸å¯ç¯¡æ”¹çš„å®¡è®¡è¯æ®
```

**æ–¹æ¡ˆ 2b â€” ç‹¬ç«‹éªŒè¯ (Post-Execution Audit)**:
```
Leader å‘é€æ‰§è¡ŒæŒ‡ä»¤: BanUser(chat_id=-100, user_id=789)
Agent æ‰§è¡Œåè¿”å› receipt
Audit Nodeï¼ˆéšæœºé€‰æ‹©ï¼‰è°ƒç”¨ getChatMember(chat_id=-100, user_id=789)
å¦‚æœç”¨æˆ·çŠ¶æ€ä¸æ˜¯ "kicked" â†’ Agent å¯èƒ½æœªçœŸæ­£æ‰§è¡Œ â†’ ä¸¾æŠ¥

é€‚ç”¨çš„å®¡è®¡ API:
  - BanUser    â†’ getChatMember (status == "kicked")
  - MuteUser   â†’ getChatMember (status == "restricted")
  - PinMessage â†’ getChat (pinned_message æ£€æŸ¥)
  - DeleteMessage â†’ æ— æ³•å®¡è®¡ï¼ˆå·²åˆ é™¤ï¼‰
  - SendMessage   â†’ æ— æ³•å®¡è®¡ï¼ˆæ²¡æœ‰æ¶ˆæ¯IDå›ä¼ æœºåˆ¶ï¼‰
```

> éƒ¨åˆ†åŠ¨ä½œå¯å®¡è®¡ï¼Œéƒ¨åˆ†ä¸å¯ã€‚

**æ–¹æ¡ˆ 2c â€” å¹‚ç­‰æ€§æ ‡è®° (Idempotency Key)**:
```
æ¯ä¸ª ExecuteAction æºå¸¦å”¯ä¸€ idempotency_key
Agent ç»´æŠ¤å·²æ‰§è¡Œ key çš„ bloom filter
é‡å¤ key â†’ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œä¸é‡å¤è°ƒç”¨ TG API
é˜²æ­¢ A7ï¼ˆé‡å¤æ‰§è¡Œï¼‰
```

---

### Layer 3: ç»æµå®‰å…¨ (é˜² A1-A8)

**é—®é¢˜**: æŠ€æœ¯æ‰‹æ®µæ— æ³• 100% é˜²æ­¢æŒæœ‰ Bot Token çš„ Agent ä½œæ¶ã€‚

**æ–¹æ¡ˆ 3a â€” Agent è´¨æŠ¼ (Staking)**:
```
Agent æ³¨å†Œæ—¶å¿…é¡»åœ¨é“¾ä¸Šè´¨æŠ¼ N ä¸ªä»£å¸
è¢«ä¸¾æŠ¥å¹¶ä»²è£ç¡®è®¤ä½œæ¶ â†’ slash è´¨æŠ¼
è´¨æŠ¼é‡‘é¢åº” >> Agent ä½œæ¶è·å¾—çš„æ”¶ç›Š
```

**æ–¹æ¡ˆ 3b â€” è¡Œä¸ºè¯„åˆ† (Reputation Score)**:
```
é“¾ä¸Šç»´æŠ¤ Agent Reputation:
  âœ… æ­£å¸¸è½¬å‘æ¶ˆæ¯ â†’ +1
  âœ… æ­£ç¡®æ‰§è¡ŒæŒ‡ä»¤ â†’ +2
  âš ï¸ update_id è·³è·ƒ â†’ -5
  âš ï¸ æ‰§è¡Œå›æ‰§ä¸å®¡è®¡ä¸ç¬¦ â†’ -50
  âŒ equivocation ç¡®è®¤ â†’ -500 + slash
  âŒ å¤šæ¬¡å®¡è®¡å¤±è´¥ â†’ è‡ªåŠ¨ deactivate bot

Reputation < é˜ˆå€¼ â†’ Bot è‡ªåŠ¨åœç”¨ï¼Œç¤¾åŒºæ”¶åˆ°å‘Šè­¦
```

**æ–¹æ¡ˆ 3c â€” ç¤¾åŒºå¤šç­¾æ²»ç†**:
```
é«˜å±æ“ä½œï¼ˆban/kickï¼‰éœ€è¦ç¤¾åŒºå¤šç­¾ç¡®è®¤:
  1. Agent è½¬å‘ /ban å‘½ä»¤
  2. èŠ‚ç‚¹å…±è¯†
  3. Leader ä¸ç›´æ¥æ‰§è¡Œï¼Œè€Œæ˜¯åˆ›å»º Proposal
  4. ç¤¾åŒºç®¡ç†å‘˜åœ¨é“¾ä¸ŠæŠ•ç¥¨ï¼ˆ2/3 ç¡®è®¤ï¼‰
  5. æŠ•ç¥¨é€šè¿‡åæ‰é€šçŸ¥ Agent æ‰§è¡Œ

é€‚ç”¨: å¤§å‹ç¤¾åŒºï¼ˆ>1000 äººï¼‰çš„ä¸å¯é€†æ“ä½œ
ä¸é€‚ç”¨: ååƒåœ¾ã€è‡ªåŠ¨å®¡æ‰¹ç­‰æ—¶é—´æ•æ„Ÿæ“ä½œ
```

---

### Layer 4: æ¶æ„çº§é˜²å¾¡ (é˜² A4)

**é—®é¢˜**: Agent å¯ä»¥ç»•è¿‡èŠ‚ç‚¹ç›´æ¥è°ƒç”¨ TG APIã€‚

**æ–¹æ¡ˆ 4a â€” Bot Token åˆ†ç‰‡ (Token Sharding) [ç†æƒ³ä½† TG ä¸æ”¯æŒ]**:
```
å°† Bot Token æ‹†åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡
Agent åªæŒæœ‰éƒ¨åˆ†åˆ†ç‰‡
æ‰§è¡Œæ—¶éœ€è¦ä»èŠ‚ç‚¹æ”¶é›†è¶³å¤Ÿåˆ†ç‰‡æ‰èƒ½é‡æ„ Token

âš ï¸ Telegram Bot API ä¸æ”¯æŒåˆ†ç‰‡è®¤è¯ï¼Œæ­¤æ–¹æ¡ˆä¸å¯è¡Œ
```

**æ–¹æ¡ˆ 4b â€” Proxy Agent æ¨¡å¼ (å®é™…å¯è¡Œ)**:
```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Telegram webhook â”€â”€â–¶â”‚ Proxy Agent  â”‚â”€â”€signâ”€â”€â–¶ Nodes
                    â”‚ (æ—  Bot Token)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–²
                            â”‚ (åªä¼ é€’åŸå§‹ bytes)
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Token Vault  â”‚ â† ç‹¬ç«‹å®‰å…¨éš”ç¦»è¿›ç¨‹
                    â”‚ (æŒæœ‰ Token)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                  åªåœ¨æ”¶åˆ° Leader ç­¾ååæ‰è°ƒç”¨ TG API
                  ä¸”ä»…å…è®¸ Leader ç­¾å + M/K å…±è¯†è¯æ®

å°† Bot Token é”åœ¨ Token Vault è¿›ç¨‹ä¸­:
  - Vault è¿›ç¨‹è¿è¡Œåœ¨ TEE/SGX æˆ–ç‹¬ç«‹ VPS
  - Vault åªæš´éœ²ä¸€ä¸ªæ¥å£: execute(leader_sig, consensus_proof, action)
  - Vault å†…éƒ¨éªŒè¯: leader ç­¾åæœ‰æ•ˆ + consensus_proof ä¸­æœ‰ M ä¸ªèŠ‚ç‚¹ç­¾å
  - éªŒè¯é€šè¿‡åæ‰è°ƒç”¨ TG API
  - Proxy Agent æ²¡æœ‰ Bot Tokenï¼Œæ— æ³•ç»•è¿‡

Proxy Agent çš„èŒè´£é€€åŒ–ä¸º:
  â‘  æ¥æ”¶ Webhook â†’ ç­¾å â†’ å¤šæ’­ï¼ˆä¸æ¥è§¦ Tokenï¼‰
  â‘¡ æ”¶åˆ° Leader æŒ‡ä»¤ â†’ è½¬å‘ç»™ Vaultï¼ˆä¸æ¥è§¦ Tokenï¼‰
```

**æ–¹æ¡ˆ 4c â€” å¤š Agent äº¤å‰å®¡è®¡**:
```
ä¸ºåŒä¸€ä¸ª Bot æ³¨å†Œå¤šä¸ª Agent (ä¸åŒè¿è¥è€…)
æ¯ä¸ª Agent ç‹¬ç«‹æ¥æ”¶ Webhook
Agent ä¹‹é—´äº¤å‰éªŒè¯:
  - Agent_A çš„ update_id åºåˆ—å¿…é¡»ä¸ Agent_B ä¸€è‡´
  - ä»»ä½•å·®å¼‚ â†’ ä¸¾æŠ¥

æˆæœ¬: N å€çš„ Webhook æµé‡ï¼Œä½†å®‰å…¨æ€§å¤§å¹…æå‡
é€‚ç”¨: é«˜ä»·å€¼ç¤¾åŒº
```

---

## 4. æ¨èå®æ–½è·¯çº¿

### Phase 1 â€” å¿«é€Ÿè§æ•ˆï¼ˆ1-2 å‘¨ï¼‰

| # | é˜²å¾¡ | é˜²å¾¡çš„æ”»å‡» | å®æ–½éš¾åº¦ |
|---|------|-----------|---------|
| 1 | **update_id è¿ç»­æ€§æ£€æµ‹** | A1/A3 | â­ ä½ |
| 2 | **ç­¾åæ‰§è¡Œå›æ‰§** | A5/A6 | â­â­ ä½ |
| 3 | **å¹‚ç­‰æ€§ key** | A7 | â­ ä½ |
| 4 | **åºåˆ—å·é“¾ä¸Šé”šå®š** | A8 | â­ ä½ |

### Phase 2 â€” ç»æµå®‰å…¨ï¼ˆ2-4 å‘¨ï¼‰

| # | é˜²å¾¡ | é˜²å¾¡çš„æ”»å‡» | å®æ–½éš¾åº¦ |
|---|------|-----------|---------|
| 5 | **Agent è´¨æŠ¼** (pallet æ‰©å±•) | A1-A8 | â­â­â­ ä¸­ |
| 6 | **è¡Œä¸ºè¯„åˆ†ç³»ç»Ÿ** | A1-A8 | â­â­â­ ä¸­ |
| 7 | **æ‰§è¡Œåå®¡è®¡** (getChatMember) | A5/A6 | â­â­ ä½ |

### Phase 3 â€” æ¶æ„åŠ å›ºï¼ˆ4-8 å‘¨ï¼‰

| # | é˜²å¾¡ | é˜²å¾¡çš„æ”»å‡» | å®æ–½éš¾åº¦ |
|---|------|-----------|---------|
| 8 | **Proxy Agent + Token Vault åˆ†ç¦»** | A4 | â­â­â­â­ é«˜ |
| 9 | **å¤š Agent äº¤å‰å®¡è®¡** | A1/A2/A3 | â­â­â­â­ é«˜ |
| 10 | **ç¤¾åŒºå¤šç­¾æ²»ç†** (é«˜å±æ“ä½œ) | A1/A2 | â­â­â­ ä¸­ |

---

## 5. å½“å‰ä»£ç ä¸­çš„å…·ä½“æ¼æ´

### æ¼æ´ V1: `/v1/execute` æ—  Leader ç­¾åéªŒè¯

```rust
// costik-agent/src/webhook.rs:130
// TODO: éªŒè¯ Leader ç­¾å + consensus_nodes æ•°é‡
let result = state.executor.execute(&action).await;
```

**é£é™©**: ä»»ä½•äººéƒ½èƒ½å‘ Agent å‘é€æ‰§è¡ŒæŒ‡ä»¤ã€‚
**ä¿®å¤**: Agent å¿…é¡»éªŒè¯ `leader_signature` + `consensus_nodes` ç­¾åé“¾ã€‚

### æ¼æ´ V2: æ‰§è¡Œå›æ‰§æ— å¯†ç å­¦è¯æ˜

```rust
// costik-agent/src/executor.rs:169
agent_receipt: Some("ok".to_string()), // TODO: Ed25519 ç­¾åå›æ‰§
```

**é£é™©**: Agent å¯ä»¥å£°ç§°æ‰§è¡ŒæˆåŠŸä½†å®é™…æ²¡æœ‰è°ƒç”¨ TG APIã€‚
**ä¿®å¤**: å›æ‰§åº”åŒ…å« TG API å“åº”åŸæ–‡ + Agent ç­¾åã€‚

### æ¼æ´ V3: message_hash ä¸€è‡´æ€§æ£€æŸ¥è¢«è·³è¿‡

```rust
// costik-node/src/verifier.rs:154-160
if computed_hash != message.message_hash {
    debug!(...); // ä»… debug æ—¥å¿—ï¼Œä¸æ‹’ç»
}
```

**é£é™©**: Agent å¯ä»¥ä¿®æ”¹ `telegram_update` å†…å®¹è€Œä¸è¢«æ‹’ç»ã€‚
**ä¿®å¤**: è¦æ±‚ Agent å‘é€åŸå§‹å­—èŠ‚ï¼ŒNode ä¾§ä¸¥æ ¼éªŒè¯ã€‚

### æ¼æ´ V4: Leader ç­¾åå­—æ®µä¸ºç©º

```rust
// costik-node/src/leader.rs:174
leader_signature: String::new(), // TODO: ç­¾å
```

**é£é™©**: Backup æ¥ç®¡æ—¶æ— æ³•éªŒè¯ Leader æ˜¯å¦çœŸçš„å°è¯•è¿‡æ‰§è¡Œã€‚

---

## 6. ä¿¡ä»»æ¨¡å‹æ€»ç»“

```
å®Œå…¨ä¿¡ä»»        éƒ¨åˆ†ä¿¡ä»»          é›¶ä¿¡ä»»
   â”‚               â”‚                â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                â”‚
   â”‚  â”‚Telegramâ”‚   â”‚                â”‚
   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚                â”‚
   â”‚       â”‚       â”‚                â”‚
   â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”‚                â”‚
   â”œâ”€â”€â”‚ Agent  â”‚â”€â”€â”€â”¤  â† å½“å‰: å®Œå…¨ä¿¡ä»»ï¼ˆå±é™©ï¼‰
   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚    ç›®æ ‡: éƒ¨åˆ†ä¿¡ä»»ï¼ˆå¯å®¡è®¡+å¯æƒ©ç½šï¼‰
   â”‚       â”‚       â”‚
   â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”‚
   â”‚  â”‚ Nodes  â”‚â”€â”€â”€â”¼â”€â”€â”€â”€ é›¶ä¿¡ä»»ï¼ˆé€šè¿‡å…±è¯†éªŒè¯ï¼‰
   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
   â”‚       â”‚       â”‚
   â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”‚
   â”‚  â”‚ Chain  â”‚â”€â”€â”€â”¼â”€â”€â”€â”€ é›¶ä¿¡ä»»ï¼ˆå¯†ç å­¦ä¿è¯ï¼‰
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
```

**ç»“è®º**: åœ¨ Telegram Bot API çš„çº¦æŸä¸‹ï¼ŒAgent ä¸å¯èƒ½è¾¾åˆ°é›¶ä¿¡ä»»ã€‚
æœ€ä½³ç­–ç•¥æ˜¯ **"ä¿¡ä»»ä½†éªŒè¯ + ç»æµæƒ©ç½š"**:

1. **æŠ€æœ¯éªŒè¯**: update_id æ£€æµ‹ + æ‰§è¡Œå›æ‰§ + äº¤å‰å®¡è®¡
2. **ç»æµæƒ©ç½š**: è´¨æŠ¼ + è¯„åˆ† + è‡ªåŠ¨ slash
3. **æ¶æ„éš”ç¦»**: Token Vault åˆ†ç¦»ï¼ˆå‡å°æ”»å‡»é¢ï¼‰
4. **æ²»ç†å…œåº•**: é«˜å±æ“ä½œç¤¾åŒºå¤šç­¾
