# Pallet Bazi Chart 冗余深度评估 - 需求文档

## 1. 项目背景

### 1.1 当前状态
Pallet Bazi Chart 是一个完整的八字排盘区块链模块，已经实现了：
- 四柱计算（年月日时）
- 大运推算
- 五行强度分析
- 神煞计算（32种）
- 星运（十二长生）
- 刑冲合会分析
- 解盘系统 V3
- 加密存储
- Runtime API
- 真太阳时修正
- 农历支持
- 子时双模式

### 1.2 评估目标
对 Pallet Bazi Chart 进行深度评估，识别以下类型的冗余：
1. **代码冗余**：重复的函数、逻辑、数据结构
2. **功能冗余**：重叠的功能模块、相似的计算逻辑
3. **存储冗余**：不必要的链上存储、可以通过计算获得的数据
4. **架构冗余**：与其他 pallet 的功能重叠
5. **历史遗留**：已迁移但未清理的代码、注释

### 1.3 评估范围
- `pallets/divination/bazi/src/` 目录下所有源代码
- 与其他 pallet 的集成关系（privacy, ocw-tee, common, almanac）
- 存储结构设计
- API 接口设计

## 2. 用户故事

### 2.1 作为开发者
**我想要**：识别并消除代码中的冗余部分  
**以便**：提高代码可维护性，减少存储成本，优化性能

**验收标准**：
- [ ] 识别所有重复的函数和逻辑
- [ ] 识别可以合并的数据结构
- [ ] 识别不必要的链上存储
- [ ] 识别与其他 pallet 的功能重叠
- [ ] 提供具体的优化建议

### 2.2 作为架构师
**我想要**：评估模块间的职责划分  
**以便**：确保每个 pallet 职责单一，避免功能重叠

**验收标准**：
- [ ] 评估 Bazi 与 Privacy 模块的职责边界
- [ ] 评估 Bazi 与 OCW-TEE 模块的职责边界
- [ ] 评估 Bazi 与 Common 模块的职责边界
- [ ] 评估 Bazi 与 Almanac 模块的职责边界
- [ ] 识别职责不清晰的部分

### 2.3 作为性能优化者
**我想要**：识别存储和计算的优化空间  
**以便**：降低链上存储成本，提高计算效率

**验收标准**：
- [ ] 识别可以从链上移到链下的数据
- [ ] 识别可以通过 Runtime API 实时计算的数据
- [ ] 识别可以压缩的数据结构
- [ ] 评估当前存储押金机制的合理性

## 3. 功能需求

### 3.1 代码冗余分析

#### 3.1.1 函数重复检测
- 识别相似或重复的函数实现
- 检查是否有可以提取为公共函数的逻辑
- 评估 `calculate_sizhu_from_input` 的三个分支是否可以优化

#### 3.1.2 类型定义冗余
- 检查 `types.rs` 中是否有重复的类型定义
- 评估 `SiZhuIndex` 和 `SiZhuDirectInput` 的必要性
- 检查是否有可以合并的枚举类型

#### 3.1.3 计算逻辑冗余
- 检查 `interpretation.rs` 中的重复计算逻辑
- 评估 `calculate_core_interpretation` 和 `calculate_interpretation_from_index` 的重复部分
- 检查五行相关辅助函数的重复

### 3.2 存储冗余分析

#### 3.2.1 链上存储评估
当前链上存储：
- `ChartById`: 完整八字信息（~500 bytes）
- `UserCharts`: 用户八字ID列表
- `InterpretationCache`: 解盘结果缓存（13 bytes，可选）
- `DepositRecords`: 押金记录

需要评估：
- `InterpretationCache` 是否必要（可以通过 Runtime API 实时计算）
- `BaziChart` 中哪些字段可以移除（通过计算获得）
- 是否需要同时存储 `birth_time` 和 `sizhu`（四柱可以从出生时间计算）

#### 3.2.2 可计算数据识别
识别以下可以通过计算获得的数据：
- 大运信息（可以从四柱和性别计算）
- 五行强度（可以从四柱计算）
- 喜用神（可以从五行强度计算）
- 藏干信息（可以从地支查表获得）
- 纳音（可以从干支查表获得）

### 3.3 架构冗余分析

#### 3.3.1 与 Privacy 模块的关系
当前状态：
- `BaziChart` 包含 `privacy_mode`, `encrypted_fields`, `sensitive_data_hash`
- 注释表明加密存储已迁移至 `pallet-divination-ocw-tee`

需要评估：
- 这些字段是否还需要保留在 `BaziChart` 中
- 是否应该完全由 Privacy 模块管理隐私相关字段

#### 3.3.2 与 OCW-TEE 模块的关系
注释表明以下功能已迁移：
- `EncryptedBaziChart` → `ocw-tee::CompletedResults`
- `create_encrypted_chart` → `ocw-tee::create_encrypted_request`

需要评估：
- 是否有遗留的加密相关代码未清理
- 注释是否准确反映当前架构

#### 3.3.3 与 Common 模块的关系
当前使用：
- `DepositRecord` 类型
- `DivinationProvider` trait

需要评估：
- 押金管理逻辑是否应该完全由 Common 模块处理
- `DivinationProvider` 实现是否完整

### 3.4 历史遗留清理

#### 3.4.1 注释清理
识别以下类型的注释：
- "已迁移" 相关的注释
- "TODO" 标记
- 过时的设计说明

#### 3.4.2 未使用代码
识别：
- 未使用的函数
- 未使用的类型定义
- 未使用的导入

## 4. 非功能需求

### 4.1 性能要求
- 分析不应影响现有功能
- 建议的优化应该能够提升性能或降低成本

### 4.2 兼容性要求
- 优化建议应该考虑向后兼容性
- 存储迁移方案应该可行

### 4.3 可维护性要求
- 优化后的代码应该更易维护
- 减少代码行数和复杂度

## 5. 约束条件

### 5.1 技术约束
- 必须保持 Substrate FRAME 框架兼容性
- 必须保持现有 API 的功能完整性
- 存储迁移必须考虑现有数据

### 5.2 业务约束
- 不能破坏现有用户的八字数据
- 核心功能（四柱计算、解盘）必须保留
- Runtime API 必须继续免费提供

## 6. 评估方法

### 6.1 代码审查
- 逐文件审查源代码
- 使用工具检测重复代码
- 分析函数调用关系

### 6.2 存储分析
- 计算每种数据的存储成本
- 评估数据的访问频率
- 分析计算成本 vs 存储成本

### 6.3 架构分析
- 绘制模块依赖图
- 识别职责重叠
- 评估接口设计

## 7. 输出要求

### 7.1 分析报告
包含：
- 发现的冗余清单（按严重程度排序）
- 每个冗余的详细说明
- 优化建议和实施难度评估
- 预期收益（代码行数减少、存储成本降低等）

### 7.2 优化建议
包含：
- 短期优化（低风险、易实施）
- 中期优化（需要测试、中等风险）
- 长期优化（需要重构、高风险）

### 7.3 实施计划
包含：
- 优先级排序
- 实施步骤
- 风险评估
- 回滚方案

## 8. 成功标准

### 8.1 完整性
- [ ] 覆盖所有源代码文件
- [ ] 覆盖所有存储项
- [ ] 覆盖所有 API 接口
- [ ] 覆盖所有模块依赖

### 8.2 准确性
- [ ] 识别的冗余确实存在
- [ ] 优化建议技术可行
- [ ] 风险评估合理

### 8.3 可操作性
- [ ] 提供具体的代码示例
- [ ] 提供清晰的实施步骤
- [ ] 提供可量化的收益预期

## 9. 参考资料

### 9.1 相关文档
- `pallets/divination/bazi/README.md` - 模块说明
- `docs/BAZI_PALLET_REDUNDANCY_ANALYSIS.md` - 之前的冗余分析（如果存在）
- `docs/TEE_REFACTOR_PLAN.md` - TEE 重构计划

### 9.2 相关代码
- `pallets/divination/privacy/` - 隐私模块
- `pallets/divination/ocw-tee/` - OCW-TEE 模块
- `pallets/divination/common/` - 公共模块
- `pallets/divination/almanac/` - 黄历模块

## 10. 时间线

### 10.1 评估阶段（预计 2-3 天）
- Day 1: 代码审查和冗余识别
- Day 2: 存储和架构分析
- Day 3: 报告编写和建议整理

### 10.2 验证阶段（预计 1 天）
- 与团队讨论发现
- 验证优化建议的可行性
- 调整优先级

### 10.3 实施阶段（根据优化范围确定）
- 短期优化：1-2 天
- 中期优化：3-5 天
- 长期优化：1-2 周
