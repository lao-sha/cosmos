# ══════════════════════════════════════════════════════════
# Nexus 多节点集成测试环境
# 
# 架构: 1 Agent + 3 Nodes + 1 Substrate Dev Chain
#
# 启动: docker-compose up -d
# 日志: docker-compose logs -f
# 停止: docker-compose down -v
# ══════════════════════════════════════════════════════════

version: "3.8"

services:
  # ════════════════════════════════════════════
  # Substrate Dev Chain
  # ════════════════════════════════════════════
  chain:
    image: nexus-node:latest
    build:
      context: ..
      dockerfile: Dockerfile
    command: >
      --dev
      --rpc-external
      --rpc-cors=all
      --rpc-port=9944
      --tmp
    ports:
      - "9944:9944"
      - "9933:9933"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9944/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ════════════════════════════════════════════
  # Nexus Agent (群主本地代理)
  # ════════════════════════════════════════════
  agent:
    build:
      context: ../nexus-agent
      dockerfile: Dockerfile
    environment:
      BOT_TOKEN: "${BOT_TOKEN:-test_token_for_dev}"
      WEBHOOK_URL: "http://agent:8443"
      WEBHOOK_PORT: "8443"
      WEBHOOK_SECRET: "dev_secret_12345"
      CHAIN_RPC: "ws://chain:9944"
      DATA_DIR: "/data"
      MULTICAST_TIMEOUT_MS: "5000"
      NODES: "node_001@http://node1:8080,node_002@http://node2:8080,node_003@http://node3:8080"
      RUST_LOG: "nexus_agent=debug"
    ports:
      - "8443:8443"
    volumes:
      - agent-data:/data
    depends_on:
      chain:
        condition: service_started

  # ════════════════════════════════════════════
  # Nexus Node 1
  # ════════════════════════════════════════════
  node1:
    build:
      context: ../nexus-node
      dockerfile: Dockerfile
    environment:
      NODE_ID: "node_001"
      LISTEN_PORT: "8080"
      GOSSIP_PORT: "9090"
      CHAIN_RPC: "ws://chain:9944"
      DATA_DIR: "/data"
      NODE_LIST: "node_001@http://node1:8080,node_002@http://node2:8080,node_003@http://node3:8080"
      AGENT_ENDPOINT: "http://agent:8443"
      RUST_LOG: "nexus_node=debug"
    ports:
      - "8081:8080"
    volumes:
      - node1-data:/data
    depends_on:
      chain:
        condition: service_started

  # ════════════════════════════════════════════
  # Nexus Node 2
  # ════════════════════════════════════════════
  node2:
    build:
      context: ../nexus-node
      dockerfile: Dockerfile
    environment:
      NODE_ID: "node_002"
      LISTEN_PORT: "8080"
      GOSSIP_PORT: "9090"
      CHAIN_RPC: "ws://chain:9944"
      DATA_DIR: "/data"
      NODE_LIST: "node_001@http://node1:8080,node_002@http://node2:8080,node_003@http://node3:8080"
      AGENT_ENDPOINT: "http://agent:8443"
      RUST_LOG: "nexus_node=debug"
    ports:
      - "8082:8080"
    volumes:
      - node2-data:/data
    depends_on:
      chain:
        condition: service_started

  # ════════════════════════════════════════════
  # Nexus Node 3
  # ════════════════════════════════════════════
  node3:
    build:
      context: ../nexus-node
      dockerfile: Dockerfile
    environment:
      NODE_ID: "node_003"
      LISTEN_PORT: "8080"
      GOSSIP_PORT: "9090"
      CHAIN_RPC: "ws://chain:9944"
      DATA_DIR: "/data"
      NODE_LIST: "node_001@http://node1:8080,node_002@http://node2:8080,node_003@http://node3:8080"
      AGENT_ENDPOINT: "http://agent:8443"
      RUST_LOG: "nexus_node=debug"
    ports:
      - "8083:8080"
    volumes:
      - node3-data:/data
    depends_on:
      chain:
        condition: service_started

volumes:
  agent-data:
  node1-data:
  node2-data:
  node3-data:
